{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>按摩預約</title>

  <!-- Open Graph / 社群分享縮圖設定 -->
  <meta property="og:title" content="按摩預約 - Lemon Spa">
  <meta property="og:description" content="線上預約按摩服務，輕鬆選擇時段">
  <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'images/logo-og-image.png' %}">
  <meta property="og:url" content="{{ request.build_absolute_uri }}">
  <meta property="og:type" content="website">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="按摩預約 - Lemon Spa">
  <meta name="twitter:description" content="線上預約按摩服務，輕鬆選擇時段">
  <meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'images/logo-og-image.png' %}">
  <style>
    /* Mobile-first 設計 */
    * { box-sizing: border-box; }
    body {
      font-family: "Noto Sans TC", system-ui, -apple-system, sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }
    main {
      width: 100%;
      min-height: 100vh;
      padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
    }
    .card {
      background: #ffffff;
      padding: 1.25rem 1rem 2rem;
      min-height: 100vh;
    }

    /* 為手機增加底部安全區域 */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .actions {
        padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
      }
    }
    h1 {
      margin: 0 0 0.75rem;
      padding: 0.5rem 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: #0f172a;
      text-align: center;
      letter-spacing: -0.01em;
    }
    p.lead {
      margin-top: 0;
      margin-bottom: 1.25rem;
      color: #64748b;
      text-align: center;
      font-size: 0.9rem;
    }
    form { display: grid; gap: 1rem; }
    .form-field {
      position: relative;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #0f172a;
      font-size: 0.95rem;
      letter-spacing: -0.01em;
    }
    label::after {
      content: none;
    }
    input, select, textarea {
      width: 100%;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1.5px solid #e2e8f0;
      font-size: 1rem;
      background: #ffffff;
      transition: all 0.2s ease;
      -webkit-appearance: none;
      appearance: none;
      font-family: inherit;
    }
    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23475569' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1.25rem;
      padding-right: 2.75rem;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
      background-color: #ffffff;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    /* 讓整個日期輸入框都可以點擊 */
    input[type="date"] {
      position: relative;
      cursor: pointer;
    }
    
    /* 讓日期輸入框的整個區域都可以觸發日曆 */
    input[type="date"]::-webkit-calendar-picker-indicator {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: auto;
      height: auto;
      color: transparent;
      background: transparent;
      cursor: pointer;
    }
    
    /* Firefox 的處理 */
    input[type="date"]::-moz-focus-inner {
      border: 0;
    }
    .actions { text-align: center; margin-top: 0.5rem; }
    button {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      border: none;
      color: #ffffff;
      border-radius: 0.75rem;
      padding: 1.125rem 2rem;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
      -webkit-tap-highlight-color: transparent;
    }
    button:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
    }
    .messages {
      list-style: none;
      padding: 1rem;
      margin: 0 0 1rem;
      border-radius: 0.75rem;
      background: #ecfdf5;
      color: #047857;
      border: 1.5px solid #a7f3d0;
      font-size: 0.95rem;
    }
    .field-errors {
      margin-top: 0.5rem;
      color: #dc2626;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .field-errors li { margin-left: 1rem; }
    .form-alert {
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1.5px solid;
      font-size: 0.95rem;
    }
    .form-alert.error {
      background: #fef2f2;
      border-color: #fca5a5;
      color: #991b1b;
    }
    .form-alert.success {
      background: #ecfdf5;
      border-color: #a7f3d0;
      color: #047857;
    }
    .selected-therapist {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border: 1.5px solid #93c5fd;
      padding: 1rem;
      border-radius: 0.75rem;
      color: #1e40af;
      margin-bottom: 1rem;
      font-weight: 600;
      text-align: center;
      font-size: 0.95rem;
    }
    .time-slot-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 0.625rem;
      padding: 0.5rem 0;
    }
    .time-slot-container .slot-message {
      color: #64748b;
      margin: 0;
      font-size: 0.9rem;
      grid-column: 1 / -1;
      text-align: center;
      padding: 1rem;
    }
    .time-slot-button {
      border: 1.5px solid #e2e8f0;
      border-radius: 0.75rem;
      background: #ffffff;
      color: #0f172a;
      padding: 0.875rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      -webkit-tap-highlight-color: transparent;
    }
    .time-slot-button:active {
      transform: scale(0.95);
    }
    .time-slot-button.active {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      border-color: #0ea5e9;
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }
    .time-slot-button:disabled {
      cursor: not-allowed;
      opacity: 0.4;
    }
    .time-slot-loading { color: #64748b; font-size: 0.9rem; }
    .visually-hidden { display: none !important; }
    .success-card { text-align: center; padding: 1.5rem 1rem; }
    .success-title {
      font-size: 1.75rem;
      margin: 1rem 0 0.5rem;
      color: #0f172a;
      font-weight: 700;
    }
    .success-subtitle {
      margin: 0 0 1.5rem;
      color: #64748b;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .success-details {
      list-style: none;
      padding: 0;
      margin: 0 0 1.5rem;
      text-align: left;
    }
    .success-details li {
      background: #f8fafc;
      border-radius: 0.75rem;
      padding: 1rem;
      border: 1.5px solid #e2e8f0;
    }
    .success-details li + li { margin-top: 0.625rem; }
    .success-label {
      display: block;
      color: #64748b;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      font-weight: 500;
    }
    .success-value {
      font-weight: 600;
      color: #0f172a;
      font-size: 1rem;
    }
    .success-line-invite {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border: 1.5px solid #93c5fd;
      padding: 1.25rem;
      border-radius: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .success-line-invite p {
      margin: 0 0 0.75rem;
      color: #1e40af;
      font-weight: 600;
      font-size: 0.95rem;
    }
    .success-line-invite img { display: inline-block; }
    .verification-panel {
      margin-top: 1.25rem;
      padding: 1.25rem;
      border-radius: 0.75rem;
      border: 1.5px solid #93c5fd;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .verification-panel h2 {
      margin: 0 0 0.75rem;
      font-size: 1.125rem;
      color: #0f172a;
      font-weight: 700;
    }
    .verification-panel p {
      margin: 0 0 0.75rem;
      color: #334155;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .verification-status {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .verification-status-item {
      flex: 1 1 100%;
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 0.875rem 1rem;
      border: 1.5px solid #cbd5e1;
    }
    .verification-status-label {
      display: block;
      font-size: 0.85rem;
      color: #64748b;
      margin-bottom: 0.25rem;
      font-weight: 500;
    }
    .verification-status-value {
      font-weight: 700;
      color: #0369a1;
      font-size: 1.125rem;
    }
    .phone-input { display: flex; gap: 0.625rem; align-items: center; }
    .phone-input select {
      flex: 0 0 9.5rem;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1.5px solid #e2e8f0;
      background: #ffffff;
      font-size: 1rem;
    }
    .phone-input input { flex: 1; }
    .verification-form { display: grid; gap: 0.75rem; }
    .verification-input-row { display: flex; gap: 0.625rem; align-items: stretch; }
    .verification-input-row input {
      flex: 1;
      text-align: center;
      font-size: 1.5rem;
      letter-spacing: 0.5rem;
      padding: 1rem;
      background: #ffffff;
      border: 1.5px solid #cbd5e1;
      border-radius: 0.75rem;
      font-weight: 600;
    }
    .verification-input-row button {
      flex: 0 0 auto;
      padding: 1rem 1.5rem;
      white-space: nowrap;
      width: auto;
    }
    .verification-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.625rem;
      margin-top: 0.75rem;
    }
    .verification-error {
      flex: 1 1 100%;
      color: #dc2626;
      margin: 0;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    button.secondary {
      background: #ffffff;
      color: #0284c7;
      border: 1.5px solid #0ea5e9;
      box-shadow: none;
    }
    button.secondary:active {
      background: #f0f9ff;
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    /* 輸入框的 loading 狀態 */
    input:disabled, select:disabled, textarea:disabled {
      background-color: #f1f5f9;
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* 提升觸控反饋 */
    @media (hover: none) {
      button:active {
        transform: scale(0.97);
      }
      .time-slot-button:active {
        transform: scale(0.93);
      }
    }

    /* 平板與桌面優化 */
    @media (min-width: 640px) {
      body {
        background: #f1f5f9;
      }
      .card {
        padding: 2rem;
        margin: 2rem auto;
        border-radius: 1rem;
        max-width: 480px;
        min-height: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }
      h1 { font-size: 1.75rem; }
      .time-slot-container {
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      }
      .verification-status-item {
        flex: 1 1 auto;
      }
      button:hover {
        box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
      }
      button.secondary:hover {
        border-color: #0284c7;
        color: #0369a1;
      }
    }

    /* 優化暗色模式支援（可選） */
    @media (prefers-color-scheme: dark) {
      /* 暫時保持亮色主題，可以之後再加暗色模式 */
    }

    /* Footer 招聘區塊 */
    .footer-recruit {
      margin-top: 2rem;
      padding: 1.5rem 1rem;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 1rem;
      border: 1.5px solid #fbbf24;
      text-align: center;
    }
    .footer-recruit-title {
      margin: 0 0 0.5rem;
      font-size: 1rem;
      font-weight: 700;
      color: #78350f;
      letter-spacing: -0.01em;
    }
    .footer-recruit-description {
      margin: 0 0 1rem;
      font-size: 0.875rem;
      color: #92400e;
      line-height: 1.5;
    }
    .footer-recruit-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: center;
    }
    .footer-recruit-button {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #ffffff;
      border: none;
      border-radius: 0.75rem;
      padding: 0.875rem 1.75rem;
      font-size: 0.95rem;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      width: 100%;
      max-width: 280px;
    }
    .footer-recruit-button:active {
      transform: scale(0.97);
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    .footer-recruit-ig-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: #92400e;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .footer-recruit-ig-link:active {
      transform: scale(0.95);
      background: rgba(146, 64, 14, 0.1);
    }
    .footer-recruit-ig-icon {
      width: 1.25rem;
      height: 1.25rem;
      fill: currentColor;
    }
    @media (min-width: 640px) {
      .footer-recruit {
        padding: 2rem;
      }
      .footer-recruit-title {
        font-size: 1.125rem;
      }
      .footer-recruit-description {
        font-size: 0.95rem;
      }
      .footer-recruit-actions {
        flex-direction: row;
        justify-content: center;
        gap: 1rem;
      }
      .footer-recruit-button {
        width: auto;
      }
      .footer-recruit-button:hover {
        box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        transform: translateY(-1px);
      }
      .footer-recruit-ig-link:hover {
        background: rgba(146, 64, 14, 0.1);
      }
    }
  </style>
</head>
<body>
  <main>
    <section id="appointment-form-card" class="card">
      <h1>按摩預約</h1>

      {% if messages %}
        <ul class="messages">
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}

      <div id="form-alert" class="form-alert error visually-hidden" role="alert"></div>

      {% if selected_therapist %}
        <div class="selected-therapist">
          為 {{ selected_therapist.nickname }} 按摩師建立預約
        </div>
      {% endif %}

      <form method="post">
        {% csrf_token %}
        {% for hidden_field in form.hidden_fields %}
          {% if hidden_field.name != "start_time" %}
            {{ hidden_field }}
          {% endif %}
        {% endfor %}
        {% if form.non_field_errors %}
          <div class="field-errors">
            <ul>
              {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if form.treatment %}
          <div class="form-field">
            <label for="{{ form.treatment.id_for_label }}">{{ form.treatment.label }}{% if form.treatment.field.required %} *{% endif %}</label>
            {{ form.treatment }}
            {% if form.treatment.help_text %}
              <small>{{ form.treatment.help_text }}</small>
            {% endif %}
            {% if form.treatment.errors %}
              <ul class="field-errors">
                {% for error in form.treatment.errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
        {% endif %}
                
        <div class="form-field">
          <label for="appointment-date">預約日期 *</label>
          <input
            type="date"
            id="appointment-date"
            name="appointment-date"
            value="{{ appointment_selected_date }}"
            min="{{ appointment_min_date }}"
            required
          >
        </div>

        <div class="form-field">
          <label>可預約時間</label>
          <div id="time-slot-container" class="time-slot-container" role="group" aria-label="可預約時間">
            <p id="time-slot-message" class="slot-message">請先選擇日期與療程。</p>
          </div>
          {% if form.start_time.errors %}
            <ul class="field-errors">
              {% for error in form.start_time.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
        <div class="visually-hidden">
          {{ form.start_time }}
        </div>

        <div class="form-field">
          <label for="{{ form.customer_phone_region.id_for_label }}">顧客電話 *</label>
          <div class="phone-input">
            {{ form.customer_phone_region }}
            {{ form.customer_phone_national }}
          </div>
          {% if form.customer_phone_region.errors %}
            <ul class="field-errors">
              {% for error in form.customer_phone_region.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
          {% if form.customer_phone_national.errors %}
            <ul class="field-errors">
              {% for error in form.customer_phone_national.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
        {% for field in form.remaining_visible_fields %}
          <div class="form-field">
            <label for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %} *{% endif %}</label>
            {{ field }}
            {% if field.help_text %}
              <small>{{ field.help_text }}</small>
            {% endif %}
            {% if field.errors %}
              <ul class="field-errors">
                {% for error in field.errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
        {% endfor %}

        <div class="actions">
          <button type="submit">送出預約</button>
        </div>
      </form>

      <section id="verification-panel" class="verification-panel visually-hidden" aria-live="polite">
        <h2>手機驗證</h2>
        <p id="verification-message">手機尚未驗證，請輸入簡訊中的 4 位數驗證碼。</p>
        <div class="verification-status">
          <div class="verification-status-item">
            <span class="verification-status-label">驗證碼有效時間</span>
            <span class="verification-status-value" id="verification-expiry-countdown">--:--</span>
          </div>
        </div>
        <form id="verification-form" class="verification-form" novalidate>
          <label for="verification-code">輸入手機驗證碼</label>
          <div class="verification-input-row">
            <input
              type="text"
              id="verification-code"
              name="code"
              inputmode="numeric"
              pattern="[0-9]{4}"
              maxlength="4"
              autocomplete="one-time-code"
              placeholder="＿ ＿ ＿ ＿"
              required
            >
            <button type="submit" id="verify-code-button">確認</button>
          </div>
        </form>
        <div class="verification-actions">
          <button type="button" id="resend-code-button" class="secondary">重新寄送驗證碼</button>
          <p id="verification-error" class="verification-error visually-hidden"></p>
        </div>
      </section>

      <!-- 招聘按摩師區塊 -->
      <div class="footer-recruit">
        <h3 class="footer-recruit-title">你也是按摩師嗎？</h3>
        <p class="footer-recruit-description">加入我們，輕鬆管理預約、提升客戶體驗，專注在你最擅長的療程上</p>
        <div class="footer-recruit-actions">
          <a href="/" class="footer-recruit-button">了解如何建立專屬預約系統</a>
          <a href="https://www.instagram.com/lmspa.app" target="_blank" rel="noopener noreferrer" class="footer-recruit-ig-link">
            <svg class="footer-recruit-ig-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
            </svg>
            追蹤 IG
          </a>
        </div>
      </div>
    </section>

    <section id="appointment-success-card" class="card success-card visually-hidden" aria-live="polite">
      <h2 class="success-title">預約成功！</h2>
      <p class="success-subtitle" id="success-subtitle">您的預約已成立，我們期待在療程中與您相見。</p>
      <ul class="success-details">
        <li>
          <span class="success-label">預約日期</span>
          <span class="success-value" id="success-date">-</span>
        </li>
        <li>
          <span class="success-label">療程開始時間</span>
          <span class="success-value" id="success-time">-</span>
        </li>
        <li>
          <span class="success-label">按摩師</span>
          <span class="success-value" id="success-therapist">-</span>
        </li>
        <li>
          <span class="success-label">療程內容</span>
          <span class="success-value" id="success-treatment">-</span>
        </li>
        <li>
          <span class="success-label">療程地點</span>
          <span class="success-value" id="success-address">-</span>
        </li>
        <li>
          <span class="success-label">連絡電話</span>
          <span class="success-value" id="success-phone">-</span>
        </li>
      </ul>
      <div class="success-line-invite">
        <p>加入 LINE 官方好友，按摩預約提醒與預約管理</p>
        <a id="line-invite-link" href="https://lin.ee/PWRS6h6" target="_blank" rel="noopener">
          <img src="https://scdn.line-apps.com/n/line_add_friends/btn/zh-Hant.png" alt="加入好友" height="36" border="0">
        </a>
      </div>
      <div class="actions">
        <button type="button" id="book-another">再預約一個時段</button>
      </div>

      <!-- 招聘按摩師區塊 -->
      <div class="footer-recruit">
        <h3 class="footer-recruit-title">你也是按摩師嗎？</h3>
        <p class="footer-recruit-description">加入我們，輕鬆管理預約、提升客戶體驗，專注在你最擅長的療程上</p>
        <div class="footer-recruit-actions">
          <a href="/" class="footer-recruit-button">了解如何建立專屬預約系統</a>
          <a href="https://www.instagram.com/lmspa.app" target="_blank" rel="noopener noreferrer" class="footer-recruit-ig-link">
            <svg class="footer-recruit-ig-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
            </svg>
            追蹤 IG
          </a>
        </div>
      </div>
    </section>
  </main>
  {{ appointment_config|json_script:"appointment-config-data" }}
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/libphonenumber-js@1.11.6/bundle/libphonenumber-min.js"></script>
  <script>
    dayjs.extend(dayjs_plugin_utc);
    dayjs.extend(dayjs_plugin_timezone);

    document.addEventListener("DOMContentLoaded", () => {
      const configElement = document.getElementById("appointment-config-data");
      const config = configElement ? JSON.parse(configElement.textContent) : {};
      const form = document.querySelector("form");
      const dateInput = document.getElementById("appointment-date");
      const treatmentSelect = document.getElementById("id_treatment");
      const therapistSelect = document.getElementById("id_therapist");
      const startTimeInput = document.getElementById("id_start_time");
      const slotContainer = document.getElementById("time-slot-container");
      const formCard = document.getElementById("appointment-form-card");
      const successCard = document.getElementById("appointment-success-card");
      const formAlert = document.getElementById("form-alert");
      const phoneHiddenInput = document.getElementById("id_customer_phone");
      const phoneRegionSelect = document.getElementById("id_customer_phone_region");
      const phoneNationalInput = document.getElementById("id_customer_phone_national");
      const verificationPanel = document.getElementById("verification-panel");
      const verificationMessage = document.getElementById("verification-message");
      const verificationExpiryCountdown = document.getElementById("verification-expiry-countdown");
      const verificationForm = document.getElementById("verification-form");
      const verificationCodeInput = document.getElementById("verification-code");
      const verifyCodeButton = document.getElementById("verify-code-button");
      const resendCodeButton = document.getElementById("resend-code-button");
      const verificationError = document.getElementById("verification-error");
      const successSubtitle = document.getElementById("success-subtitle");
      const successDate = document.getElementById("success-date");
      const successTime = document.getElementById("success-time");
      const successTherapist = document.getElementById("success-therapist");
      const successTreatment = document.getElementById("success-treatment");
      const successAddress = document.getElementById("success-address");
      const successPhone = document.getElementById("success-phone");
      const bookAnotherButton = document.getElementById("book-another");
      const submitButton = form ? form.querySelector('button[type="submit"]') : null;
      if (submitButton) {
        submitButton.dataset.defaultText = submitButton.textContent;
      }
      if (verifyCodeButton) {
        verifyCodeButton.dataset.defaultText = verifyCodeButton.textContent;
      }
      if (resendCodeButton) {
        resendCodeButton.dataset.defaultText = resendCodeButton.textContent;
      }

      const verificationState = {
        active: false,
        appointmentUuid: null,
        phoneNumber: null,
        expiresAt: null,
        resendAvailableAt: null,
        expireTimer: null,
        resendTimer: null,
      };

      if (!form || !dateInput || !treatmentSelect || !startTimeInput || !slotContainer) {
        return;
      }

      updateHiddenPhoneFromInputs();

      let latestAvailability = null;

      function hideFormAlert() {
        if (!formAlert) {
          return;
        }
        formAlert.classList.add("visually-hidden");
        formAlert.classList.remove("success", "error");
        formAlert.classList.add("error");
        formAlert.textContent = "";
      }

      function showFormAlert(message, variant = "error") {
        if (!formAlert) {
          return;
        }
        formAlert.textContent = message;
        formAlert.classList.remove("visually-hidden");
        formAlert.classList.remove("success", "error");
        formAlert.classList.add(variant);
      }

      function clearFieldErrors() {
        const errorLists = form.querySelectorAll(".field-errors");
        errorLists.forEach((list) => list.remove());
      }

      function renderFieldErrors(errors) {
        if (!errors) {
          return;
        }
        const combinedGeneralErrors = [
          ...(errors.__all__ || []),
          ...(errors.non_field_errors || []),
        ];
        if (combinedGeneralErrors.length) {
          showFormAlert(combinedGeneralErrors.join("、"));
        }
        Object.entries(errors).forEach(([fieldName, messages]) => {
          if (fieldName === "__all__" || fieldName === "non_field_errors") {
            return;
          }
          if (!messages || !messages.length) {
            return;
          }
          let fieldElement = form.querySelector(`[name="${fieldName}"]`);
          if (!fieldElement && fieldName === "appointment-date") {
            fieldElement = dateInput;
          }
          let targetContainer = fieldElement ? fieldElement.closest(".form-field") : null;
          if (fieldName === "start_time") {
            targetContainer = slotContainer ? slotContainer.parentElement : null;
          }
          if (!targetContainer) {
            showFormAlert(messages.join("、"));
            return;
          }
          const list = document.createElement("ul");
          list.className = "field-errors";
          messages.forEach((message) => {
            const item = document.createElement("li");
            item.textContent = message;
            list.appendChild(item);
          });
          targetContainer.appendChild(list);
        });
      }

      function toggleSubmitting(isSubmitting) {
        if (!submitButton) {
          return;
        }
        const defaultText = submitButton.dataset.defaultText || "送出預約";
        submitButton.disabled = isSubmitting;
        submitButton.textContent = isSubmitting ? "送出中..." : defaultText;
      }

      function getCsrfToken() {
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : "";
      }

      function formatDuration(totalSeconds) {
        const safeSeconds = Math.max(Number(totalSeconds) || 0, 0);
        const minutes = Math.floor(safeSeconds / 60);
        const seconds = safeSeconds % 60;
        return `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
      }

      function updateResendButtonLabel(seconds) {
        if (!resendCodeButton) {
          return;
        }
        const baseText = resendCodeButton.dataset.defaultText || "重新寄送驗證碼";
        if (seconds && seconds > 0) {
          resendCodeButton.textContent = `${baseText} (${formatDuration(seconds)})`;
        } else {
          resendCodeButton.textContent = baseText;
        }
      }

      function clearVerificationError() {
        if (!verificationError) {
          return;
        }
        verificationError.textContent = "";
        verificationError.classList.add("visually-hidden");
      }

      function showVerificationError(message) {
        if (!verificationError) {
          return;
        }
        verificationError.textContent = message;
        verificationError.classList.remove("visually-hidden");
      }

      function clearVerificationTimers() {
        if (verificationState.expireTimer) {
          clearInterval(verificationState.expireTimer);
          verificationState.expireTimer = null;
        }
        if (verificationState.resendTimer) {
          clearInterval(verificationState.resendTimer);
          verificationState.resendTimer = null;
        }
      }

      function sanitizeNationalInput(value) {
        return (value || "").replace(/[\s-]+/g, "");
      }

      function parsePhone(region, national) {
        if (!window.libphonenumber || !region || !national) {
          return null;
        }
        try {
          const parsed = libphonenumber.parsePhoneNumberFromString(national, region);
          return parsed && parsed.isValid() ? parsed : null;
        } catch (error) {
          return null;
        }
      }

      function updateHiddenPhoneFromInputs() {
        if (!phoneHiddenInput || !phoneNationalInput || !phoneRegionSelect) {
          return null;
        }
        const region = phoneRegionSelect.value || "TW";
        const nationalInput = sanitizeNationalInput(phoneNationalInput.value);
        const phoneNumber = parsePhone(region, nationalInput);

        if (phoneNumber) {
          phoneHiddenInput.value = phoneNumber.number;
          phoneNationalInput.value = phoneNumber.nationalNumber;
          verificationState.phoneNumber = phoneNumber.number;
          return phoneNumber.number;
        }

        phoneHiddenInput.value = "";
        verificationState.phoneNumber = null;
        return null;
      }

      function unlockSubmitButton() {
        if (!submitButton) {
          return;
        }
        submitButton.disabled = false;
        submitButton.textContent = submitButton.dataset.defaultText || "送出預約";
      }

      function setSubmitLocked() {
        if (!submitButton) {
          return;
        }
        submitButton.disabled = true;
        submitButton.textContent = "等待手機驗證";
      }

      function resetVerificationFlow() {
        verificationState.active = false;
        verificationState.appointmentUuid = null;
        verificationState.phoneNumber = null;
        verificationState.expiresAt = null;
        verificationState.resendAvailableAt = null;
        clearVerificationTimers();
        if (verificationPanel) {
          verificationPanel.classList.add("visually-hidden");
        }
        if (verificationMessage) {
          verificationMessage.textContent = "手機尚未驗證，請輸入簡訊中的 4 位數驗證碼。";
        }
        if (verificationCodeInput) {
          verificationCodeInput.value = "";
          verificationCodeInput.disabled = false;
        }
        if (verifyCodeButton) {
          verifyCodeButton.disabled = false;
          verifyCodeButton.textContent = verifyCodeButton.dataset.defaultText || "確認";
        }
        if (resendCodeButton) {
          resendCodeButton.disabled = false;
          updateResendButtonLabel(0);
        }
        if (verificationExpiryCountdown) {
          verificationExpiryCountdown.textContent = "--:--";
        }
        clearVerificationError();
        unlockSubmitButton();
        updateResendButtonLabel(0);
        if (phoneHiddenInput) {
          phoneHiddenInput.value = "";
        }
      }

      function startExpiryCountdown(targetMoment) {
        if (!verificationExpiryCountdown) {
          return;
        }
        clearInterval(verificationState.expireTimer);
        const isValidMoment =
          targetMoment && typeof targetMoment.isValid === "function" && targetMoment.isValid();
        if (!isValidMoment) {
          verificationExpiryCountdown.textContent = "--:--";
          if (verifyCodeButton) {
            verifyCodeButton.disabled = false;
          }
          return;
        }
        const update = () => {
          const remainingSeconds = Math.max(targetMoment.diff(dayjs(), "second"), 0);
          verificationExpiryCountdown.textContent = formatDuration(remainingSeconds);
          if (remainingSeconds <= 0) {
            if (verifyCodeButton) {
              verifyCodeButton.disabled = true;
            }
            if (verificationMessage && verificationState.active) {
              verificationMessage.textContent = "驗證碼已過期，請點擊重新寄送驗證碼。";
            }
            clearInterval(verificationState.expireTimer);
            verificationState.expireTimer = null;
          } else if (verifyCodeButton) {
            verifyCodeButton.disabled = false;
          }
        };
        update();
        verificationState.expireTimer = setInterval(update, 1000);
      }

      function startResendCountdown(targetMoment, fallbackSeconds) {
        if (!resendCodeButton) {
          return;
        }
        clearInterval(verificationState.resendTimer);
        let target = null;
        if (
          targetMoment &&
          typeof targetMoment.isValid === "function" &&
          targetMoment.isValid()
        ) {
          target = targetMoment;
        } else if (typeof fallbackSeconds === "number" && fallbackSeconds > 0) {
          target = dayjs().add(fallbackSeconds, "second");
        }
        verificationState.resendAvailableAt = target;

        if (!target) {
          resendCodeButton.disabled = false;
          updateResendButtonLabel(0);
          return;
        }

        const update = () => {
          const diffSeconds = Math.ceil(target.diff(dayjs(), "second"));
          if (diffSeconds > 0) {
            resendCodeButton.disabled = true;
            updateResendButtonLabel(diffSeconds);
          } else {
            resendCodeButton.disabled = false;
            updateResendButtonLabel(0);
            clearInterval(verificationState.resendTimer);
            verificationState.resendTimer = null;
          }
        };

        update();
        verificationState.resendTimer = setInterval(update, 1000);
      }

      function setResendBusy(isBusy) {
        if (!resendCodeButton) {
          return;
        }
        if (isBusy) {
          resendCodeButton.disabled = true;
          resendCodeButton.textContent = "重新寄送中...";
        } else {
          updateResendButtonLabel(0);
        }
      }

      function setVerifyBusy(isBusy) {
        if (!verifyCodeButton) {
          return;
        }
        if (isBusy) {
          verifyCodeButton.disabled = true;
          verifyCodeButton.textContent = "確認中...";
        } else {
          verifyCodeButton.disabled = false;
          verifyCodeButton.textContent = verifyCodeButton.dataset.defaultText || "確認";
        }
      }

      function applyVerificationState(payload) {
        if (!payload) {
          return;
        }
        const verification = payload.verification || {};
        verificationState.active = true;
        if (payload.appointment && payload.appointment.uuid) {
          verificationState.appointmentUuid = payload.appointment.uuid;
        }
        if (verification.phone_number) {
          verificationState.phoneNumber = verification.phone_number;
        } else if (!verificationState.phoneNumber && phoneHiddenInput) {
          verificationState.phoneNumber = phoneHiddenInput.value || null;
        }

        if (phoneHiddenInput) {
          phoneHiddenInput.value = verificationState.phoneNumber || "";
        }

        const expiresAt = verification.expires_at ? dayjs(verification.expires_at) : null;
        let resendTarget = null;
        if (verification.resend_available_at) {
          resendTarget = dayjs(verification.resend_available_at);
        } else if (typeof verification.resend_available_in === "number") {
          resendTarget = dayjs().add(verification.resend_available_in, "second");
        }

        verificationState.expiresAt = expiresAt;
        verificationState.resendAvailableAt = resendTarget;

        if (verificationPanel) {
          verificationPanel.classList.remove("visually-hidden");
        }
        setSubmitLocked();
        clearVerificationError();

        if (verificationMessage) {
          verificationMessage.textContent =
            payload.message ||
            verification.message ||
            "手機尚未驗證，請輸入簡訊中的 4 位數驗證碼。";
        }

        if (verificationCodeInput && verification.error_code !== "VerificationAttemptsExceeded") {
          verificationCodeInput.value = "";
          verificationCodeInput.disabled = false;
        } else if (verificationCodeInput && verification.error_code === "VerificationAttemptsExceeded") {
          verificationCodeInput.disabled = true;
        }

        if (verifyCodeButton) {
          verifyCodeButton.disabled = verification.error_code === "VerificationAttemptsExceeded";
          verifyCodeButton.textContent = verifyCodeButton.dataset.defaultText || "確認";
        }

        if (resendCodeButton && verification.error_code === "SendLimitReached") {
          resendCodeButton.disabled = true;
        }

        if (verificationExpiryCountdown) {
          verificationExpiryCountdown.textContent = "--:--";
        }
        if (verification.status === "error") {
          showVerificationError(
            verification.message || payload.message || "手機驗證處理失敗，請稍後再試。"
          );
        } else if (verification.error_code === "VerificationAttemptsExceeded") {
          showVerificationError("驗證次數過多，請聯絡客服人員協助。");
        } else if (verification.error_code === "SendLimitReached") {
          showVerificationError(verification.message || "驗證碼發送次數已達上限，請聯絡客服。");
        }

        startExpiryCountdown(expiresAt);
        startResendCountdown(resendTarget, verification.resend_available_in);

        if (verificationCodeInput && !verificationCodeInput.disabled) {
          setTimeout(() => verificationCodeInput.focus(), 100);
        }
      }

      function handleVerificationFailure(data) {
        if (!data) {
          return;
        }
        const message = data.message || "手機驗證失敗，請稍後再試。";
        if (verificationMessage) {
          verificationMessage.textContent = message;
        }
        const code = data.error_code;
        const context = data.context || {};

        if (code === "InvalidVerificationCode" && typeof context.attempts_remaining === "number") {
          const remaining = context.attempts_remaining;
          showVerificationError(`${message} (剩餘 ${remaining} 次機會)`);
        } else {
          showVerificationError(message);
        }

        if (code === "VerificationExpired") {
          if (verifyCodeButton) {
            verifyCodeButton.disabled = true;
          }
          startResendCountdown(null, 0);
        }

        if (code === "VerificationAttemptsExceeded") {
          if (verificationCodeInput) {
            verificationCodeInput.disabled = true;
          }
          if (verifyCodeButton) {
            verifyCodeButton.disabled = true;
          }
          if (resendCodeButton) {
            resendCodeButton.disabled = true;
          }
          setSubmitLocked();
        }
      }

      function handleVerificationSuccess(payload) {
        resetVerificationFlow();
        if (payload && payload.appointment) {
          showSuccess(payload);
        } else {
          showFormAlert("手機驗證成功，但無法取得預約資訊。");
        }
      }

      function switchToSuccess() {
        if (formCard) {
          formCard.classList.add("visually-hidden");
        }
        if (successCard) {
          successCard.classList.remove("visually-hidden");
        }
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function switchToForm() {
        if (successCard) {
          successCard.classList.add("visually-hidden");
        }
        if (formCard) {
          formCard.classList.remove("visually-hidden");
        }
        hideFormAlert();
      }

      function showSuccess(payload) {
        if (!payload || !payload.appointment) {
          showFormAlert("預約已送出，但無法取得確認資訊，請與客服聯繫。");
          return;
        }
        if (verificationState.active) {
          resetVerificationFlow();
        }
        const appointment = payload.appointment;
        const therapist = appointment.therapist || {};
        const treatment = appointment.treatment || {};
        const guessedTimezone = therapist.timezone || dayjs.tz.guess();
        let sessionStart = dayjs(appointment.start_time);
        if (guessedTimezone) {
          sessionStart = sessionStart.tz(guessedTimezone);
        }
        if (!sessionStart.isValid()) {
          sessionStart = dayjs(appointment.start_time);
        }

        if (successDate) {
          successDate.textContent = sessionStart.isValid()
            ? sessionStart.format("YYYY 年 M 月 D 日")
            : "-";
        }
        if (successTime) {
          successTime.textContent = sessionStart.isValid()
            ? sessionStart.format("HH:mm")
            : "-";
        }
        if (successTherapist) {
          successTherapist.textContent = therapist.nickname
            ? `${therapist.nickname} 按摩師`
            : "按摩師";
        }
        if (successTreatment) {
          successTreatment.textContent = treatment.name || "療程內容";
        }
        if (successAddress) {
          successAddress.textContent = therapist.address || "-";
        }
        if (successPhone) {
          successPhone.textContent = therapist.phone_number || "-";
        }
        if (successSubtitle) {
          if (sessionStart.isValid() && therapist.nickname) {
            successSubtitle.textContent = `${therapist.nickname} 按摩師將在 ${sessionStart.format("M 月 D 日 HH:mm")} 為您服務。`;
          } else {
            successSubtitle.textContent = "您的預約已成立，我們期待在療程中與您相見。";
          }
        }

        form.reset();
        startTimeInput.value = "";
        latestAvailability = null;
        clearSlots("請先選擇日期與療程。");
        clearFieldErrors();
        hideFormAlert();
        switchToSuccess();
      }

      if (bookAnotherButton) {
        bookAnotherButton.addEventListener("click", () => {
          resetVerificationFlow();
          switchToForm();
          form.reset();
          startTimeInput.value = "";
          latestAvailability = null;
          clearFieldErrors();
          clearSlots("請先選擇日期與療程。");
          setTimeout(() => dateInput.focus(), 100);
        });
      }

      const resetVerificationIfActive = () => {
        if (verificationState.active) {
          resetVerificationFlow();
        }
      };

      if (phoneRegionSelect) {
        phoneRegionSelect.addEventListener("change", () => {
          updateHiddenPhoneFromInputs();
          resetVerificationIfActive();
        });
      }

      if (phoneNationalInput) {
        phoneNationalInput.addEventListener("input", () => {
          updateHiddenPhoneFromInputs();
          resetVerificationIfActive();
        });
        phoneNationalInput.addEventListener("blur", updateHiddenPhoneFromInputs);

        // 處理瀏覽器自動填入：檢測並修正國碼
        phoneNationalInput.addEventListener("change", () => {
          handleAutofillPhone();
        });
      }

      // 處理瀏覽器自動填入的電話號碼
      function handleAutofillPhone() {
        if (!phoneNationalInput || !phoneRegionSelect || !window.libphonenumber) {
          return;
        }

        const inputValue = phoneNationalInput.value.trim();
        if (!inputValue) {
          return;
        }

        // 如果輸入的號碼以 + 開頭，表示可能是完整國際格式
        if (inputValue.startsWith('+')) {
          try {
            const parsed = libphonenumber.parsePhoneNumberFromString(inputValue);
            if (parsed && parsed.isValid()) {
              // 更新國碼選單（避免觸發下拉選單跳出）
              phoneRegionSelect.value = parsed.country;
              // 立即移除焦點，避免下拉選單跳出
              if (document.activeElement === phoneRegionSelect) {
                phoneRegionSelect.blur();
              }
              // 更新號碼欄位為國內格式
              phoneNationalInput.value = parsed.nationalNumber;
              // 將焦點保持在輸入框
              phoneNationalInput.focus();
              // 更新隱藏欄位
              updateHiddenPhoneFromInputs();
              return;
            }
          } catch (error) {
            console.log('Failed to parse international phone number', error);
          }
        }

        // 如果沒有 +，嘗試用當前選擇的國碼解析
        const currentRegion = phoneRegionSelect.value || 'TW';

        // 移除所有空格和連字號
        const cleanedInput = sanitizeNationalInput(inputValue);

        // 嘗試偵測國碼（例如：886912345678 或 +886912345678）
        const commonCountries = ['TW', 'CN', 'HK', 'US', 'JP'];
        for (const country of commonCountries) {
          try {
            const testParsed = libphonenumber.parsePhoneNumberFromString(cleanedInput, country);
            if (testParsed && testParsed.isValid()) {
              phoneRegionSelect.value = testParsed.country;
              // 立即移除焦點，避免下拉選單跳出
              if (document.activeElement === phoneRegionSelect) {
                phoneRegionSelect.blur();
              }
              phoneNationalInput.value = testParsed.nationalNumber;
              // 將焦點保持在輸入框
              phoneNationalInput.focus();
              updateHiddenPhoneFromInputs();
              return;
            }
          } catch (error) {
            continue;
          }
        }

        // 如果都無法解析，保持原樣並用當前國碼
        phoneNationalInput.value = cleanedInput;
        updateHiddenPhoneFromInputs();
      }

      if (verificationForm) {
        verificationForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!verificationState.active || !verificationState.appointmentUuid) {
            showVerificationError("請先送出預約以取得驗證碼。");
            return;
          }
          const codeValue = verificationCodeInput ? verificationCodeInput.value.trim() : "";
          if (!/^\d{4}$/.test(codeValue)) {
            showVerificationError("請輸入 4 位數字驗證碼。");
            if (verificationCodeInput) {
              verificationCodeInput.focus();
            }
            return;
          }

          clearVerificationError();
          setVerifyBusy(true);

          try {
            const response = await fetch("/api/phone_verification/verify/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCsrfToken(),
                "X-Requested-With": "XMLHttpRequest",
                Accept: "application/json",
              },
              credentials: "same-origin",
              body: JSON.stringify({
                appointment_uuid: verificationState.appointmentUuid,
                phone_number:
                  verificationState.phoneNumber || (phoneHiddenInput ? phoneHiddenInput.value : ""),
                code: codeValue,
              }),
            });

            let data;
            try {
              data = await response.json();
            } catch (jsonError) {
              data = null;
            }

            if (response.ok && data && data.success) {
              handleVerificationSuccess(data);
            } else if (data) {
              handleVerificationFailure(data);
            } else {
              showVerificationError("暫時無法驗證，請稍後再試或聯絡客服。");
            }
          } catch (error) {
            console.error("Failed to verify phone code", error);
            showVerificationError("暫時無法驗證，請稍後再試或聯絡客服。");
          } finally {
            if (verificationState.active) {
              setVerifyBusy(false);
            }
          }
        });
      }

      if (resendCodeButton) {
        resendCodeButton.addEventListener("click", async () => {
          if (!verificationState.active || !verificationState.phoneNumber) {
            showVerificationError("請先送出預約以取得驗證碼。");
            return;
          }

          clearVerificationError();
          setResendBusy(true);

          try {
            const response = await fetch("/api/phone_verification/resend/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCsrfToken(),
                "X-Requested-With": "XMLHttpRequest",
                Accept: "application/json",
              },
              credentials: "same-origin",
              body: JSON.stringify({
                phone_number: verificationState.phoneNumber,
                appointment_uuid: verificationState.appointmentUuid,
              }),
            });

            let data;
            try {
              data = await response.json();
            } catch (jsonError) {
              data = null;
            }

            if (response.ok && data && data.success) {
              setResendBusy(false);
              if (
                data.verification &&
                data.verification.status === "verified" &&
                data.appointment
              ) {
                handleVerificationSuccess(data);
              } else {
                applyVerificationState({
                  message: data.message,
                  appointment: { uuid: verificationState.appointmentUuid },
                  verification: data.verification || {},
                });
              }
            } else if (data && data.verification) {
              setResendBusy(false);
              applyVerificationState({
                message: data.message,
                appointment: { uuid: verificationState.appointmentUuid },
                verification: data.verification,
              });
            } else {
              console.error("Failed to resend verification code", response.status, data);
              showVerificationError((data && data.message) || "重新寄送失敗，請稍後再試。");
              setResendBusy(false);
            }
          } catch (error) {
            console.error("Failed to resend verification code", error);
            showVerificationError("暫時無法重新寄送，請稍後再試或聯絡客服。");
            setResendBusy(false);
          }
        });
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        hideFormAlert();
        clearFieldErrors();

        const normalizedPhone = updateHiddenPhoneFromInputs();
        if (!normalizedPhone) {
          showFormAlert("請輸入有效的電話號碼。");
          return;
        }

        toggleSubmitting(true);

        try {
          const response = await fetch(form.action, {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              Accept: "application/json",
            },
            body: new FormData(form),
          });

          let data = null;
          try {
            data = await response.json();
          } catch (jsonError) {
            data = null;
          }

          if (data && data.verification_required) {
            applyVerificationState(data);
          } else if (response.ok && data && data.success) {
            showSuccess(data);
          } else if (response.status === 400 && data && data.errors) {
            renderFieldErrors(data.errors);
          } else {
            console.error("Unexpected response when submitting appointment", response.status, data);
            const fallbackMessage =
              (data && data.message) || "送出時發生錯誤，請稍後再試。";
            showFormAlert(fallbackMessage);
          }
        } catch (error) {
          console.error("Failed to submit appointment", error);
          showFormAlert("暫時無法送出預約，請檢查網路連線或稍後再試。");
        } finally {
          toggleSubmitting(false);
        }
      });

      function getTherapistContext() {
        const selectedFromConfig = config.selectedTherapist;
        if (selectedFromConfig && (!therapistSelect || therapistSelect.value === "" || therapistSelect.value === selectedFromConfig.pk)) {
          return {
            uuid: selectedFromConfig.uuid,
            timezone: selectedFromConfig.timezone,
          };
        }

        if (!therapistSelect || !therapistSelect.value) {
          return null;
        }

        const therapistMeta = config.therapists ? config.therapists[therapistSelect.value] : null;
        if (!therapistMeta) {
          return null;
        }

        return {
          uuid: therapistMeta.uuid,
          timezone: therapistMeta.timezone,
        };
      }

      function getTreatmentDuration() {
        if (!treatmentSelect || !treatmentSelect.value) {
          return null;
        }
        const treatmentMeta = config.treatments ? config.treatments[treatmentSelect.value] : null;
        return treatmentMeta ? Number(treatmentMeta.duration_minutes) : null;
      }

      function clearSlots(messageText, cssClass = "slot-message", options = {}) {
        const { resetSelection = true } = options;
        slotContainer.innerHTML = "";
        const info = document.createElement("p");
        info.className = cssClass;
        info.textContent = messageText;
        slotContainer.appendChild(info);
        if (resetSelection) {
          startTimeInput.value = "";
        }
      }

      function setLoadingState() {
        clearSlots("讀取可預約時段中…", "slot-message time-slot-loading", { resetSelection: false });
      }

      function alignToHalfHour(moment) {
        const minutes = moment.minute();
        let aligned;
        
        if (minutes === 0 || minutes === 30) {
          // 已經對齊，直接返回
          aligned = moment.clone();
        } else if (minutes < 30) {
          // 向上對齊到 30 分
          aligned = moment.minute(30);
        } else {
          // 向上對齊到下一個小時
          aligned = moment.add(1, 'hour').minute(0);
        }
        
        return aligned.second(0).millisecond(0);
      }

      // 合併重疊的時間段
      function mergeOverlappingWindows(windows) {
        if (!windows || windows.length === 0) {
          return [];
        }

        // 轉換為 dayjs 物件並按開始時間排序
        const convertedWindows = windows
          .map(window => ({
            start: dayjs(window.start),
            end: dayjs(window.end),
            original: window
          }))
          .sort((a, b) => a.start.valueOf() - b.start.valueOf());

        const merged = [];
        let current = convertedWindows[0];

        for (let i = 1; i < convertedWindows.length; i++) {
          const next = convertedWindows[i];
          
          // 檢查是否重疊或相鄰 (current.end >= next.start)
          if (current.end.isAfter(next.start) || current.end.isSame(next.start)) {
            // 合併：擴展當前窗口的結束時間，取較晚的結束時間
            const laterEnd = current.end.isAfter(next.end) ? current.end : next.end;
            current = {
              start: current.start,
              end: laterEnd,
              original: current.original
            };
          } else {
            // 沒有重疊，將當前窗口加入結果並移到下一個
            merged.push(current);
            current = next;
          }
        }

        // 加入最後一個窗口
        merged.push(current);

        return merged.map(window => ({
          start: window.start.toISOString(),
          end: window.end.toISOString()
        }));
      }

      function generateSlotsForAvailability(availability, blocked, durationMinutes, timezone) {
        const slots = [];
        if (!Array.isArray(availability) || availability.length === 0) {
          console.log('🚫 沒有available時間段');
          return slots;
        }

        console.log('📊 原始資料:', {
          availability,
          blocked,
          durationMinutes,
          timezone
        });

        // 先合併重疊的 available 時間段
        const mergedAvailability = mergeOverlappingWindows(availability);
        console.log('🔄 合併後的available:', mergedAvailability);

        // 將 blocked 時間轉換為 dayjs 物件
        const blockedWindows = (blocked || []).map((window) => ({
          start: dayjs(window.start),
          end: dayjs(window.end),
          originalStart: window.start,
          originalEnd: window.end
        }));

        console.log('⛔ blocked時間段:', blockedWindows.map(bw => ({
          start: bw.start.format('HH:mm'),
          end: bw.end.format('HH:mm'),
          original: `${bw.originalStart} - ${bw.originalEnd}`
        })));

        for (const window of mergedAvailability) {
          console.log(`\n🎯 處理available時間段: ${window.start} - ${window.end}`);
          
          // 直接使用 dayjs() 解析時間，因為 API 已經包含時區資訊
          const windowStart = dayjs(window.start);
          const windowEnd = dayjs(window.end);

          console.log(`   轉換後: ${windowStart.format('HH:mm')} - ${windowEnd.format('HH:mm')}`);

          let cursor = alignToHalfHour(windowStart);
          console.log(`   對齊後起始時間: ${cursor.format('HH:mm')}`);
          
          let processedSlots = 0;
          const maxSlots = 50; // 防止無限循環
          
          // 修正循環條件，避免邊界問題
          while (cursor.isBefore(windowEnd) && processedSlots < maxSlots) {
            const candidateEnd = cursor.add(durationMinutes, "minute");
            
            console.log(`     檢查時間段: ${cursor.format('HH:mm')} - ${candidateEnd.format('HH:mm')}`);
            
            // 檢查療程結束時間是否超出可用時間窗口
            if (candidateEnd.isAfter(windowEnd)) {
              console.log(`       ❌ 超出available範圍 (${windowEnd.format('HH:mm')})`);
              break;
            }
            
            // 檢查是否與 blocked 時間重疊
            let overlapsBlocked = false;
            let blockingWindow = null;
            
            for (const bw of blockedWindows) {
              const overlaps = cursor.isBefore(bw.end) && candidateEnd.isAfter(bw.start);
              if (overlaps) {
                overlapsBlocked = true;
                blockingWindow = bw;
                break;
              }
            }

            if (overlapsBlocked) {
              console.log(`       ❌ 與blocked時間重疊: ${blockingWindow.start.format('HH:mm')}-${blockingWindow.end.format('HH:mm')}`);
            } else {
              console.log(`       ✅ 可用時間段: ${cursor.format('HH:mm')}`);
              slots.push({
                start: cursor.clone(),
                end: candidateEnd,
              });
            }

            cursor = cursor.add(30, "minute");
            processedSlots++;
          }
          
          if (processedSlots >= maxSlots) {
            console.log('⚠️ 達到最大處理數量限制，停止處理');
          }
        }

        console.log(`\n📈 總共生成 ${slots.length} 個時間段:`, 
          slots.map(slot => slot.start.format('HH:mm')));

        return slots;
      }

      function renderSlots(slots, timezone, existingSelection = "") {
        slotContainer.innerHTML = "";
        if (!slots.length) {
          clearSlots("當天預約額滿，請選其他天。");
          return;
        }

        const fragment = document.createDocumentFragment();
        let hasMatch = false;

        slots.sort((a, b) => a.start.valueOf() - b.start.valueOf());
        slots.forEach((slot) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "time-slot-button";
          button.dataset.start = slot.start.toISOString();
          button.dataset.end = slot.end.toISOString();
          button.textContent = slot.start.tz(timezone).format("HH:mm");
          if (existingSelection && dayjs(existingSelection).isSame(slot.start, "minute")) {
            button.classList.add("active");
            hasMatch = true;
          }
          button.addEventListener("click", () => selectSlot(slot, button));
          fragment.appendChild(button);
        });

        slotContainer.appendChild(fragment);
        if (!hasMatch) {
          startTimeInput.value = "";
        }
      }

      function selectSlot(slot, button) {
        const buttons = slotContainer.querySelectorAll(".time-slot-button");
        buttons.forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");
        startTimeInput.value = slot.start.utc().format("YYYY-MM-DDTHH:mm:ss[Z]");
      }

      async function refreshAvailability() {
        const therapist = getTherapistContext();
        const duration = getTreatmentDuration();
        const selectedDate = dateInput.value;

        if (!therapist) {
          clearSlots("請先選擇按摩師。");
          return;
        }

        if (!selectedDate) {
          clearSlots("請先選擇日期。");
          return;
        }

        if (!duration || Number.isNaN(duration)) {
          clearSlots("請先選擇療程。");
          return;
        }

        if (!config.availabilityUrlTemplate || !config.availabilityPlaceholder) {
          clearSlots("暫時無法取得可預約時段，請稍後再試。");
          return;
        }

        const previousSelection = startTimeInput.value;
        setLoadingState();
        const dayStart = dayjs.tz(selectedDate, therapist.timezone).startOf("day");
        const dayEnd = dayStart.add(1, "day");
        const params = new URLSearchParams({
          start: dayStart.format("YYYY-MM-DD[T]HH:mm:ss"),
          end: dayEnd.format("YYYY-MM-DD[T]HH:mm:ss"),
        });

        const url = config.availabilityUrlTemplate.replace(
          config.availabilityPlaceholder,
          therapist.uuid
        );

        try {
          const response = await fetch(`${url}?${params.toString()}`);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          latestAvailability = await response.json();
          const slots = generateSlotsForAvailability(
            latestAvailability.available,
            latestAvailability.blocked,
            duration,
            therapist.timezone
          );
          renderSlots(slots, therapist.timezone, previousSelection);
        } catch (error) {
          console.error("Failed to load availability", error);
          clearSlots("暫時無法取得可預約時段，請稍後再試。");
        }
      }

      function reRenderWithExistingAvailability() {
        const therapist = getTherapistContext();
        const duration = getTreatmentDuration();

        if (!latestAvailability || !therapist || !duration) {
          return;
        }

        const slots = generateSlotsForAvailability(
          latestAvailability.available,
          latestAvailability.blocked,
          duration,
          therapist.timezone
        );
        renderSlots(slots, therapist.timezone, startTimeInput.value);
      }

      dateInput.addEventListener("change", () => {
        latestAvailability = null;
        startTimeInput.value = "";
        refreshAvailability();
      });

      if (treatmentSelect) {
        treatmentSelect.addEventListener("change", () => {
          startTimeInput.value = "";
          if (latestAvailability) {
            reRenderWithExistingAvailability();
          } else if (dateInput.value) {
            refreshAvailability();
          } else {
            clearSlots("請先選擇日期與療程。");
          }
        });
      }

      if (therapistSelect) {
        therapistSelect.addEventListener("change", () => {
          latestAvailability = null;
          startTimeInput.value = "";
          if (dateInput.value) {
            refreshAvailability();
          } else {
            clearSlots("請先選擇日期與療程。");
          }
        });
      }

      if (config.selectedTherapist && !therapistSelect) {
        form.dataset.therapistUuid = config.selectedTherapist.uuid;
        form.dataset.therapistTimezone = config.selectedTherapist.timezone;
      }

      const initialStart = startTimeInput.value;
      if (initialStart) {
        const therapist = getTherapistContext();
        if (therapist) {
          const startMoment = dayjs(initialStart).tz(therapist.timezone);
          if (startMoment.isValid()) {
            dateInput.value = startMoment.format("YYYY-MM-DD");
            refreshAvailability();
          } else {
            clearSlots("請先選擇日期與療程。");
          }
        } else {
          clearSlots("請先選擇日期與療程。");
        }
      } else if (dateInput.value) {
        refreshAvailability();
      } else {
        clearSlots("請先選擇日期與療程。");
      }
    });
  </script>
</body>
</html>
