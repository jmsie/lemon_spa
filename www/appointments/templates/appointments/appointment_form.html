<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>按摩預約</title>
  <style>
    body { font-family: "Noto Sans TC", system-ui, sans-serif; background: #f1f5f9; margin: 0; padding: 0; display: flex; min-height: 100vh; align-items: center; justify-content: center; }
    main { width: min(640px, 94%); }
    .card { background: #ffffff; padding: 2.5rem; border-radius: 1rem; box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12); }
    h1 { margin-top: 0; margin-bottom: 1.5rem; font-size: 2rem; color: #0f172a; text-align: center; }
    p.lead { margin-top: 0; margin-bottom: 1.5rem; color: #475569; text-align: center; }
    form { display: grid; gap: 1.25rem; }
    label { display: block; font-weight: 600; margin-bottom: 0.35rem; color: #1e293b; }
    input, select, textarea { width: 100%; padding: 0.75rem 0.85rem; border-radius: 0.6rem; border: 1px solid #cbd5f5; font-size: 1rem; background: #f8fafc; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); background: #fff; }
    
    /* 讓整個日期輸入框都可以點擊 */
    input[type="date"] {
      position: relative;
      cursor: pointer;
    }
    
    /* 讓日期輸入框的整個區域都可以觸發日曆 */
    input[type="date"]::-webkit-calendar-picker-indicator {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: auto;
      height: auto;
      color: transparent;
      background: transparent;
      cursor: pointer;
    }
    
    /* Firefox 的處理 */
    input[type="date"]::-moz-focus-inner {
      border: 0;
    }
    .actions { text-align: center; }
    button { background: #0ea5e9; border: none; color: #f8fafc; border-radius: 9999px; padding: 0.75rem 2.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s ease, transform 0.1s ease; }
    button:hover { background: #0284c7; }
    button:active { transform: scale(0.98); }
    .messages { list-style: none; padding: 0.75rem 1rem; margin: 0 0 1.25rem; border-radius: 0.75rem; background: #ecfdf5; color: #047857; border: 1px solid rgba(5, 150, 105, 0.35); }
    .field-errors { margin-top: 0.35rem; color: #dc2626; font-size: 0.9rem; }
    .field-errors li { margin-left: 1rem; }
    .selected-therapist { background: #eff6ff; border: 1px solid rgba(59, 130, 246, 0.35); padding: 0.85rem 1rem; border-radius: 0.75rem; color: #1d4ed8; margin-bottom: 1rem; font-weight: 600; text-align: center; }
    .time-slot-container { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem 0; }
    .time-slot-container .slot-message { color: #64748b; margin: 0; }
    .time-slot-button { border: 1px solid #cbd5f5; border-radius: 9999px; background: #fff; color: #0f172a; padding: 0.45rem 0.9rem; font-size: 0.95rem; cursor: pointer; transition: all 0.2s ease; }
    .time-slot-button:hover { border-color: #3b82f6; color: #1d4ed8; }
    .time-slot-button.active { background: #1d4ed8; border-color: #1d4ed8; color: #fff; box-shadow: 0 10px 18px rgba(29, 78, 216, 0.25); }
    .time-slot-button:disabled { cursor: not-allowed; opacity: 0.5; }
    .time-slot-loading { color: #475569; }
    .visually-hidden { display: none !important; }
    @media (max-width: 640px) {
      .card { padding: 1.75rem; }
    }
  </style>
</head>
<body>
  <main>
    <section class="card">
      <h1>按摩預約</h1>

      {% if messages %}
        <ul class="messages">
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}

      {% if selected_therapist %}
        <div class="selected-therapist">
          為 {{ selected_therapist.nickname }} 按摩師建立預約
        </div>
      {% endif %}

      <form method="post">
        {% csrf_token %}
        {% for hidden_field in form.hidden_fields %}
          {% if hidden_field.name != "start_time" %}
            {{ hidden_field }}
          {% endif %}
        {% endfor %}
        {% if form.non_field_errors %}
          <div class="field-errors">
            <ul>
              {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if form.treatment %}
          <div class="form-field">
            <label for="{{ form.treatment.id_for_label }}">{{ form.treatment.label }}{% if form.treatment.field.required %} *{% endif %}</label>
            {{ form.treatment }}
            {% if form.treatment.help_text %}
              <small>{{ form.treatment.help_text }}</small>
            {% endif %}
            {% if form.treatment.errors %}
              <ul class="field-errors">
                {% for error in form.treatment.errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
        {% endif %}
                
        <div class="form-field">
          <label for="appointment-date">預約日期 *</label>
          <input
            type="date"
            id="appointment-date"
            name="appointment-date"
            value="{{ appointment_selected_date }}"
            min="{{ appointment_min_date }}"
            required
          >
        </div>

        <div class="form-field">
          <label>可預約時間</label>
          <div id="time-slot-container" class="time-slot-container" role="group" aria-label="可預約時間">
            <p id="time-slot-message" class="slot-message">請先選擇日期與療程。</p>
          </div>
          {% if form.start_time.errors %}
            <ul class="field-errors">
              {% for error in form.start_time.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
        <div class="visually-hidden">
          {{ form.start_time }}
        </div>

        {% for field in form.visible_fields %}
          {% if field.name != "start_time" and field.name != "treatment" %}
            <div class="form-field">
              <label for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %} *{% endif %}</label>
              {{ field }}
              {% if field.help_text %}
                <small>{{ field.help_text }}</small>
              {% endif %}
              {% if field.errors %}
                <ul class="field-errors">
                  {% for error in field.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}

        <div class="actions">
          <button type="submit">送出預約</button>
        </div>
      </form>
    </section>
  </main>
  {{ appointment_config|json_script:"appointment-config-data" }}
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
  <script>
    dayjs.extend(dayjs_plugin_utc);
    dayjs.extend(dayjs_plugin_timezone);

    document.addEventListener("DOMContentLoaded", () => {
      const configElement = document.getElementById("appointment-config-data");
      const config = configElement ? JSON.parse(configElement.textContent) : {};
      const form = document.querySelector("form");
      const dateInput = document.getElementById("appointment-date");
      const treatmentSelect = document.getElementById("id_treatment");
      const therapistSelect = document.getElementById("id_therapist");
      const startTimeInput = document.getElementById("id_start_time");
      const slotContainer = document.getElementById("time-slot-container");

      if (!form || !dateInput || !treatmentSelect || !startTimeInput || !slotContainer) {
        return;
      }

      let latestAvailability = null;

      function getTherapistContext() {
        const selectedFromConfig = config.selectedTherapist;
        if (selectedFromConfig && (!therapistSelect || therapistSelect.value === "" || therapistSelect.value === selectedFromConfig.pk)) {
          return {
            uuid: selectedFromConfig.uuid,
            timezone: selectedFromConfig.timezone,
          };
        }

        if (!therapistSelect || !therapistSelect.value) {
          return null;
        }

        const therapistMeta = config.therapists ? config.therapists[therapistSelect.value] : null;
        if (!therapistMeta) {
          return null;
        }

        return {
          uuid: therapistMeta.uuid,
          timezone: therapistMeta.timezone,
        };
      }

      function getTreatmentDuration() {
        if (!treatmentSelect || !treatmentSelect.value) {
          return null;
        }
        const treatmentMeta = config.treatments ? config.treatments[treatmentSelect.value] : null;
        return treatmentMeta ? Number(treatmentMeta.duration_minutes) : null;
      }

      function clearSlots(messageText, cssClass = "slot-message", options = {}) {
        const { resetSelection = true } = options;
        slotContainer.innerHTML = "";
        const info = document.createElement("p");
        info.className = cssClass;
        info.textContent = messageText;
        slotContainer.appendChild(info);
        if (resetSelection) {
          startTimeInput.value = "";
        }
      }

      function setLoadingState() {
        clearSlots("讀取可預約時段中…", "slot-message time-slot-loading", { resetSelection: false });
      }

      function alignToHalfHour(moment) {
        const minutes = moment.minute();
        let aligned;
        
        if (minutes === 0 || minutes === 30) {
          // 已經對齊，直接返回
          aligned = moment.clone();
        } else if (minutes < 30) {
          // 向上對齊到 30 分
          aligned = moment.minute(30);
        } else {
          // 向上對齊到下一個小時
          aligned = moment.add(1, 'hour').minute(0);
        }
        
        return aligned.second(0).millisecond(0);
      }

      // 合併重疊的時間段
      function mergeOverlappingWindows(windows) {
        if (!windows || windows.length === 0) {
          return [];
        }

        // 轉換為 dayjs 物件並按開始時間排序
        const convertedWindows = windows
          .map(window => ({
            start: dayjs(window.start),
            end: dayjs(window.end),
            original: window
          }))
          .sort((a, b) => a.start.valueOf() - b.start.valueOf());

        const merged = [];
        let current = convertedWindows[0];

        for (let i = 1; i < convertedWindows.length; i++) {
          const next = convertedWindows[i];
          
          // 檢查是否重疊或相鄰 (current.end >= next.start)
          if (current.end.isAfter(next.start) || current.end.isSame(next.start)) {
            // 合併：擴展當前窗口的結束時間，取較晚的結束時間
            const laterEnd = current.end.isAfter(next.end) ? current.end : next.end;
            current = {
              start: current.start,
              end: laterEnd,
              original: current.original
            };
          } else {
            // 沒有重疊，將當前窗口加入結果並移到下一個
            merged.push(current);
            current = next;
          }
        }

        // 加入最後一個窗口
        merged.push(current);

        return merged.map(window => ({
          start: window.start.toISOString(),
          end: window.end.toISOString()
        }));
      }

      function generateSlotsForAvailability(availability, blocked, durationMinutes, timezone) {
        const slots = [];
        if (!Array.isArray(availability) || availability.length === 0) {
          console.log('🚫 沒有available時間段');
          return slots;
        }

        console.log('📊 原始資料:', {
          availability,
          blocked,
          durationMinutes,
          timezone
        });

        // 先合併重疊的 available 時間段
        const mergedAvailability = mergeOverlappingWindows(availability);
        console.log('🔄 合併後的available:', mergedAvailability);

        // 將 blocked 時間轉換為 dayjs 物件
        const blockedWindows = (blocked || []).map((window) => ({
          start: dayjs(window.start),
          end: dayjs(window.end),
          originalStart: window.start,
          originalEnd: window.end
        }));

        console.log('⛔ blocked時間段:', blockedWindows.map(bw => ({
          start: bw.start.format('HH:mm'),
          end: bw.end.format('HH:mm'),
          original: `${bw.originalStart} - ${bw.originalEnd}`
        })));

        for (const window of mergedAvailability) {
          console.log(`\n🎯 處理available時間段: ${window.start} - ${window.end}`);
          
          // 直接使用 dayjs() 解析時間，因為 API 已經包含時區資訊
          const windowStart = dayjs(window.start);
          const windowEnd = dayjs(window.end);

          console.log(`   轉換後: ${windowStart.format('HH:mm')} - ${windowEnd.format('HH:mm')}`);

          let cursor = alignToHalfHour(windowStart);
          console.log(`   對齊後起始時間: ${cursor.format('HH:mm')}`);
          
          let processedSlots = 0;
          const maxSlots = 50; // 防止無限循環
          
          // 修正循環條件，避免邊界問題
          while (cursor.isBefore(windowEnd) && processedSlots < maxSlots) {
            const candidateEnd = cursor.add(durationMinutes, "minute");
            
            console.log(`     檢查時間段: ${cursor.format('HH:mm')} - ${candidateEnd.format('HH:mm')}`);
            
            // 檢查療程結束時間是否超出可用時間窗口
            if (candidateEnd.isAfter(windowEnd)) {
              console.log(`       ❌ 超出available範圍 (${windowEnd.format('HH:mm')})`);
              break;
            }
            
            // 檢查是否與 blocked 時間重疊
            let overlapsBlocked = false;
            let blockingWindow = null;
            
            for (const bw of blockedWindows) {
              const overlaps = cursor.isBefore(bw.end) && candidateEnd.isAfter(bw.start);
              if (overlaps) {
                overlapsBlocked = true;
                blockingWindow = bw;
                break;
              }
            }

            if (overlapsBlocked) {
              console.log(`       ❌ 與blocked時間重疊: ${blockingWindow.start.format('HH:mm')}-${blockingWindow.end.format('HH:mm')}`);
            } else {
              console.log(`       ✅ 可用時間段: ${cursor.format('HH:mm')}`);
              slots.push({
                start: cursor.clone(),
                end: candidateEnd,
              });
            }

            cursor = cursor.add(30, "minute");
            processedSlots++;
          }
          
          if (processedSlots >= maxSlots) {
            console.log('⚠️ 達到最大處理數量限制，停止處理');
          }
        }

        console.log(`\n📈 總共生成 ${slots.length} 個時間段:`, 
          slots.map(slot => slot.start.format('HH:mm')));

        return slots;
      }

      function renderSlots(slots, timezone, existingSelection = "") {
        slotContainer.innerHTML = "";
        if (!slots.length) {
          clearSlots("當天預約額滿，請選其他天。");
          return;
        }

        const fragment = document.createDocumentFragment();
        let hasMatch = false;

        slots.sort((a, b) => a.start.valueOf() - b.start.valueOf());
        slots.forEach((slot) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "time-slot-button";
          button.dataset.start = slot.start.toISOString();
          button.dataset.end = slot.end.toISOString();
          button.textContent = slot.start.tz(timezone).format("HH:mm");
          if (existingSelection && dayjs(existingSelection).isSame(slot.start, "minute")) {
            button.classList.add("active");
            hasMatch = true;
          }
          button.addEventListener("click", () => selectSlot(slot, button));
          fragment.appendChild(button);
        });

        slotContainer.appendChild(fragment);
        if (!hasMatch) {
          startTimeInput.value = "";
        }
      }

      function selectSlot(slot, button) {
        const buttons = slotContainer.querySelectorAll(".time-slot-button");
        buttons.forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");
        startTimeInput.value = slot.start.utc().format("YYYY-MM-DDTHH:mm:ss[Z]");
      }

      async function refreshAvailability() {
        const therapist = getTherapistContext();
        const duration = getTreatmentDuration();
        const selectedDate = dateInput.value;

        if (!therapist) {
          clearSlots("請先選擇按摩師。");
          return;
        }

        if (!selectedDate) {
          clearSlots("請先選擇日期。");
          return;
        }

        if (!duration || Number.isNaN(duration)) {
          clearSlots("請先選擇療程。");
          return;
        }

        if (!config.availabilityUrlTemplate || !config.availabilityPlaceholder) {
          clearSlots("暫時無法取得可預約時段，請稍後再試。");
          return;
        }

        const previousSelection = startTimeInput.value;
        setLoadingState();
        const dayStart = dayjs.tz(selectedDate, therapist.timezone).startOf("day");
        const dayEnd = dayStart.add(1, "day");
        const params = new URLSearchParams({
          start: dayStart.format("YYYY-MM-DD[T]HH:mm:ss"),
          end: dayEnd.format("YYYY-MM-DD[T]HH:mm:ss"),
        });

        const url = config.availabilityUrlTemplate.replace(
          config.availabilityPlaceholder,
          therapist.uuid
        );

        try {
          const response = await fetch(`${url}?${params.toString()}`);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          latestAvailability = await response.json();
          const slots = generateSlotsForAvailability(
            latestAvailability.available,
            latestAvailability.blocked,
            duration,
            therapist.timezone
          );
          renderSlots(slots, therapist.timezone, previousSelection);
        } catch (error) {
          console.error("Failed to load availability", error);
          clearSlots("暫時無法取得可預約時段，請稍後再試。");
        }
      }

      function reRenderWithExistingAvailability() {
        const therapist = getTherapistContext();
        const duration = getTreatmentDuration();

        if (!latestAvailability || !therapist || !duration) {
          return;
        }

        const slots = generateSlotsForAvailability(
          latestAvailability.available,
          latestAvailability.blocked,
          duration,
          therapist.timezone
        );
        renderSlots(slots, therapist.timezone, startTimeInput.value);
      }

      dateInput.addEventListener("change", () => {
        latestAvailability = null;
        startTimeInput.value = "";
        refreshAvailability();
      });

      if (treatmentSelect) {
        treatmentSelect.addEventListener("change", () => {
          startTimeInput.value = "";
          if (latestAvailability) {
            reRenderWithExistingAvailability();
          } else if (dateInput.value) {
            refreshAvailability();
          } else {
            clearSlots("請先選擇日期與療程。");
          }
        });
      }

      if (therapistSelect) {
        therapistSelect.addEventListener("change", () => {
          latestAvailability = null;
          startTimeInput.value = "";
          if (dateInput.value) {
            refreshAvailability();
          } else {
            clearSlots("請先選擇日期與療程。");
          }
        });
      }

      if (config.selectedTherapist && !therapistSelect) {
        form.dataset.therapistUuid = config.selectedTherapist.uuid;
        form.dataset.therapistTimezone = config.selectedTherapist.timezone;
      }

      const initialStart = startTimeInput.value;
      if (initialStart) {
        const therapist = getTherapistContext();
        if (therapist) {
          const startMoment = dayjs(initialStart).tz(therapist.timezone);
          if (startMoment.isValid()) {
            dateInput.value = startMoment.format("YYYY-MM-DD");
            refreshAvailability();
          } else {
            clearSlots("請先選擇日期與療程。");
          }
        } else {
          clearSlots("請先選擇日期與療程。");
        }
      } else if (dateInput.value) {
        refreshAvailability();
      } else {
        clearSlots("請先選擇日期與療程。");
      }
    });
  </script>
</body>
</html>