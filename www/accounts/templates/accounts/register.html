{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>æŒ‰æ‘©å¸«è¨»å†Š</title>
  <style>
    * {
      box-sizing: border-box;
    }
    :root {
      color-scheme: light;
      font-family: "Noto Sans TC", system-ui, sans-serif;
    }
    body {
      margin: 0;
      background: #f8fafc;
      display: flex;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: #ffffff;
      width: min(520px, 92%);
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.14);
      padding: 32px;
    }
    h1 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 1.75rem;
      color: #0f172a;
    }
    p.lead {
      margin-top: 0;
      margin-bottom: 24px;
      color: #475569;
      line-height: 1.6;
    }
    form {
      display: grid;
      gap: 16px;
    }
    .form-field {
      display: flex;
      flex-direction: column;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #1e293b;
      font-size: 0.95rem;
    }
    input, select, textarea, button {
      font: inherit;
      box-sizing: border-box;
    }
    input, select, textarea {
      display: block;
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #cbd5e1;
      background: #f8fbff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      font-size: 1rem;
      line-height: 1.5;
    }
    input::placeholder,
    textarea::placeholder {
      color: #94a3b8;
      opacity: 1;
    }
    input:disabled,
    select:disabled,
    textarea:disabled {
      background: #f1f5f9;
      color: #94a3b8;
      cursor: not-allowed;
    }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 40px;
      cursor: pointer;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
      background: #ffffff;
    }
    button {
      display: inline-block;
      padding: 12px 16px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s ease;
      font-size: 1rem;
      line-height: 1.5;
      box-sizing: border-box;
    }
    button.primary {
      background: #2563eb;
      color: #ffffff;
    }
    button.primary:hover:not(:disabled) {
      background: #1d4ed8;
    }
    button.primary:disabled {
      background: #93c5fd;
      cursor: not-allowed;
    }
    button.secondary {
      background: transparent;
      border: 1px solid #cbd5e1;
      color: #1e40af;
    }
    button.secondary:hover:not(:disabled) {
      background: #f1f5f9;
      border-color: #94a3b8;
    }
    .step {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    .step.active {
      display: grid;
    }
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }
    .actions button {
      flex: 1;
    }
    .alert {
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 0.96rem;
      display: none;
      margin-bottom: 16px;
    }
    .alert.show {
      display: block;
    }
    .alert.success {
      background: #ecfdf5;
      color: #047857;
      border: 1px solid #a7f3d0;
    }
    .alert.error {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    textarea {
      min-height: 96px;
      resize: vertical;
      font-family: inherit;
    }
    small {
      color: #64748b;
      font-size: 0.875rem;
      display: block;
      margin-top: 4px;
      line-height: 1.4;
    }
    a {
      text-decoration: none;
      display: block;
    }
    a button {
      width: 100%;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <main class="card">
    <h1>è¨»å†ŠæŒ‰æ‘©å¸«å¸³è™Ÿ</h1>
    <p class="lead">ä»¥æ‰‹æ©Ÿè™Ÿç¢¼è¨»å†Šï¼Œå®Œæˆé©—è­‰å¾Œå³å¯è¨­å®šå¯†ç¢¼èˆ‡åŸºæœ¬è³‡æ–™ã€‚</p>

    <div id="alert" class="alert" role="alert"></div>

    <section id="step-send" class="step active" aria-labelledby="send-heading">
      <form>
        {% csrf_token %}
        <div>
          <label for="country-code-select">åœ‹ç¢¼</label>
          <select id="country-code-select" required>
            <option value="886" selected>ğŸ‡¹ğŸ‡¼ å°ç£ (+886)</option>
            <option value="86">ğŸ‡¨ğŸ‡³ ä¸­åœ‹ (+86)</option>
            <option value="852">ğŸ‡­ğŸ‡° é¦™æ¸¯ (+852)</option>
            <option value="853">ğŸ‡²ğŸ‡´ æ¾³é–€ (+853)</option>
            <option value="65">ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡ (+65)</option>
            <option value="60">ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº (+60)</option>
            <option value="1">ğŸ‡ºğŸ‡¸ ç¾åœ‹/åŠ æ‹¿å¤§ (+1)</option>
            <option value="81">ğŸ‡¯ğŸ‡µ æ—¥æœ¬ (+81)</option>
            <option value="82">ğŸ‡°ğŸ‡· éŸ“åœ‹ (+82)</option>
            <option value="44">ğŸ‡¬ğŸ‡§ è‹±åœ‹ (+44)</option>
          </select>
        </div>
        <div>
          <label for="phone-input">æ‰‹æ©Ÿè™Ÿç¢¼</label>
          <input id="phone-input" type="tel" placeholder="900000000" autocomplete="tel" required>
          <small>è«‹å‹¿è¼¸å…¥é–‹é ­çš„ 0ï¼Œç³»çµ±æœƒè‡ªå‹•è™•ç†</small>
          <small id="phone-preview" style="color: #2563eb; font-weight: 600; display: none;">
            å®Œæ•´è™Ÿç¢¼ï¼š<span id="phone-preview-text"></span>
          </small>
        </div>
        <div class="actions">
          <button id="send-code-btn" class="primary" type="submit">å¯„é€é©—è­‰ç¢¼</button>
        </div>
      </form>
    </section>

    <section id="step-verify" class="step" aria-labelledby="verify-heading">
      <form>
        {% csrf_token %}
        <div>
          <label for="code-input">ç°¡è¨Šé©—è­‰ç¢¼</label>
          <input id="code-input" type="text" inputmode="numeric" maxlength="6" placeholder="è¼¸å…¥é©—è­‰ç¢¼" required>
        </div>
        <div class="actions">
          <button id="verify-code-btn" class="primary" type="submit">é©—è­‰æ‰‹æ©Ÿ</button>
          <button id="resend-btn" class="secondary" type="button">é‡æ–°å¯„é€</button>
        </div>
      </form>
    </section>

    <section id="step-complete" class="step" aria-labelledby="complete-heading">
      <form>
        {% csrf_token %}
        <div>
          <label for="password-input">å¯†ç¢¼</label>
          <input id="password-input" type="password" minlength="8" autocomplete="new-password" required>
        </div>
        <div>
          <label for="confirm-password-input">ç¢ºèªå¯†ç¢¼</label>
          <input id="confirm-password-input" type="password" minlength="8" autocomplete="new-password" required>
        </div>
        <div>
          <label for="nickname-input">é¡¯ç¤ºæš±ç¨±</label>
          <input id="nickname-input" type="text" maxlength="150" required>
          <small>ç™»å…¥å¾Œå¯æ–¼è³‡æ–™ç®¡ç†è¨­å®šçœŸå¯¦å§“åèˆ‡å…¶ä»–è³‡è¨Šã€‚</small>
        </div>
        <div>
          <label for="timezone-select">æ‰€åœ¨æ™‚å€</label>
          <select id="timezone-select" required>
            <option value="" disabled selected>é¸æ“‡æ™‚å€</option>
            {% for value, label in timezone_choices %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
          <small style="color: #64748b;">æ­£åœ¨åµæ¸¬æ‚¨çš„æ™‚å€...</small>
        </div>
        <div>
          <label for="address-input">æœå‹™åœ°å€ / åœ°å€</label>
          <textarea id="address-input" placeholder="ä¾‹ï¼šå°åŒ—å¸‚ä¿¡ç¾©å€..." required></textarea>
        </div>
        <div class="actions">
          <button id="complete-btn" class="primary" type="submit">å®Œæˆè¨»å†Š</button>
        </div>
      </form>
    </section>

    <section id="step-success" class="step" aria-live="polite">
      <p class="lead">è¨»å†ŠæˆåŠŸï¼è«‹ä»¥æ‰‹æ©Ÿè™Ÿç¢¼ç™»å…¥ç³»çµ±ï¼Œé–‹å§‹è¨­å®šæœå‹™å…§å®¹èˆ‡æ™‚æ®µã€‚</p>
      <div class="actions">
        <a href="{% url 'accounts:login' %}">
          <button class="primary" type="button">å‰å¾€ç™»å…¥</button>
        </a>
      </div>
    </section>
  </main>

  <script>
    const endpoints = {
      send: "{{ send_code_url }}",
      verify: "{{ verify_code_url }}",
      complete: "{{ complete_url }}"
    };

    const elements = {
      alert: document.getElementById("alert"),
      steps: {
        send: document.getElementById("step-send"),
        verify: document.getElementById("step-verify"),
        complete: document.getElementById("step-complete"),
        success: document.getElementById("step-success"),
      },
      countryCodeSelect: document.getElementById("country-code-select"),
      phoneInput: document.getElementById("phone-input"),
      phonePreview: document.getElementById("phone-preview"),
      phonePreviewText: document.getElementById("phone-preview-text"),
      codeInput: document.getElementById("code-input"),
      passwordInput: document.getElementById("password-input"),
      confirmPasswordInput: document.getElementById("confirm-password-input"),
      nicknameInput: document.getElementById("nickname-input"),
      timezoneSelect: document.getElementById("timezone-select"),
      addressInput: document.getElementById("address-input"),
      sendBtn: document.getElementById("send-code-btn"),
      verifyBtn: document.getElementById("verify-code-btn"),
      resendBtn: document.getElementById("resend-btn"),
      completeBtn: document.getElementById("complete-btn"),
    };

    let registrationToken = null;
    let normalizedPhone = null;

    function getCsrfToken() {
      const value = document.cookie?.match(/csrftoken=([^;]+)/);
      if (value) {
        return decodeURIComponent(value[1]);
      }
      const input = document.querySelector("input[name=csrfmiddlewaretoken]");
      return input ? input.value : "";
    }

    function showAlert(message, type = "success") {
      elements.alert.textContent = message;
      elements.alert.className = `alert ${type} show`;
    }

    function hideAlert() {
      elements.alert.classList.remove("show");
    }

    function switchStep(stepKey) {
      Object.entries(elements.steps).forEach(([key, section]) => {
        section.classList.toggle("active", key === stepKey);
      });
    }

    /**
     * æ ¼å¼åŒ–æ‰‹æ©Ÿè™Ÿç¢¼ç‚º E.164 æ ¼å¼
     * @param {string} countryCode - åœ‹ç¢¼ï¼ˆä¸å«+è™Ÿï¼‰
     * @param {string} phoneNumber - æ‰‹æ©Ÿè™Ÿç¢¼
     * @returns {string} - E.164 æ ¼å¼çš„å®Œæ•´è™Ÿç¢¼ (ä¾‹: +886900000000)
     */
    function formatPhoneE164(countryCode, phoneNumber) {
      // ç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦
      let cleanNumber = phoneNumber.replace(/\D/g, '');
      
      // å¦‚æœè™Ÿç¢¼ä»¥ 0 é–‹é ­ï¼Œç§»é™¤é–‹é ­çš„ 0
      if (cleanNumber.startsWith('0')) {
        cleanNumber = cleanNumber.substring(1);
      }
      
      // çµ„åˆæˆ E.164 æ ¼å¼
      return `+${countryCode}${cleanNumber}`;
    }

    /**
     * æ­£è¦åŒ–ä¸¦é¡¯ç¤ºè™•ç†å¾Œçš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆä¸å«åœ‹ç¢¼éƒ¨åˆ†ï¼‰
     */
    function normalizePhoneInput() {
      const phone = elements.phoneInput.value.trim();
      if (!phone) {
        elements.phonePreview.style.display = 'none';
        return;
      }
      
      // ç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦
      let cleanNumber = phone.replace(/\D/g, '');
      
      // å¦‚æœè™Ÿç¢¼ä»¥ 0 é–‹é ­ï¼Œç§»é™¤é–‹é ­çš„ 0
      if (cleanNumber.startsWith('0')) {
        cleanNumber = cleanNumber.substring(1);
      }
      
      // æ›´æ–°è¼¸å…¥æ¡†é¡¯ç¤ºè™•ç†å¾Œçš„è™Ÿç¢¼
      if (cleanNumber !== phone.replace(/\D/g, '')) {
        elements.phoneInput.value = cleanNumber;
      }
      
      // é¡¯ç¤ºå®Œæ•´çš„ E.164 æ ¼å¼é è¦½
      if (cleanNumber) {
        const countryCode = elements.countryCodeSelect.value;
        const fullNumber = `+${countryCode}${cleanNumber}`;
        elements.phonePreviewText.textContent = fullNumber;
        elements.phonePreview.style.display = 'block';
      } else {
        elements.phonePreview.style.display = 'none';
      }
    }

    // ç•¶æ‰‹æ©Ÿè™Ÿç¢¼è¼¸å…¥æ¡†å¤±ç„¦æ™‚ï¼Œè‡ªå‹•æ­£è¦åŒ–é¡¯ç¤º
    elements.phoneInput.addEventListener('blur', normalizePhoneInput);
    
    // ç•¶åœ‹ç¢¼æ”¹è®Šæ™‚ï¼Œä¹Ÿé‡æ–°æ­£è¦åŒ–è™Ÿç¢¼
    elements.countryCodeSelect.addEventListener('change', normalizePhoneInput);

    /**
     * è‡ªå‹•åµæ¸¬ä¸¦è¨­å®šç”¨æˆ¶çš„ç€è¦½å™¨æ™‚å€
     */
    function detectAndSetTimezone() {
      const hintElement = elements.timezoneSelect.nextElementSibling; // ç²å–æç¤ºæ–‡å­—å…ƒç´ 
      
      try {
        // ç²å–ç€è¦½å™¨çš„æ™‚å€ï¼ˆIANA æ™‚å€åç¨±ï¼Œä¾‹å¦‚ï¼šAsia/Taipeiï¼‰
        const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        
        if (!userTimezone) {
          if (hintElement) {
            hintElement.textContent = 'ç„¡æ³•è‡ªå‹•åµæ¸¬æ™‚å€ï¼Œè«‹æ‰‹å‹•é¸æ“‡';
            hintElement.style.color = '#f59e0b';
          }
          return;
        }
        
        // å˜—è©¦åœ¨ select é¸é …ä¸­æ‰¾åˆ°åŒ¹é…çš„æ™‚å€
        const options = elements.timezoneSelect.options;
        for (let i = 0; i < options.length; i++) {
          if (options[i].value === userTimezone) {
            elements.timezoneSelect.selectedIndex = i;
            if (hintElement) {
              hintElement.textContent = `å·²è‡ªå‹•åµæ¸¬ç‚ºã€Œ${options[i].text}ã€ï¼Œå¦‚ä¸æ­£ç¢ºè«‹ä¿®æ”¹`;
              hintElement.style.color = '#10b981';
            }
            console.log('è‡ªå‹•è¨­å®šæ™‚å€ç‚º:', userTimezone);
            return;
          }
        }
        
        // å¦‚æœæ‰¾ä¸åˆ°å®Œå…¨åŒ¹é…ï¼Œå˜—è©¦æ‰¾ç›¸åŒåŸå¸‚çš„æ™‚å€ï¼ˆä¾‹å¦‚ï¼šTaipeiï¼‰
        const cityName = userTimezone.split('/').pop();
        for (let i = 0; i < options.length; i++) {
          if (options[i].value.includes(cityName)) {
            elements.timezoneSelect.selectedIndex = i;
            if (hintElement) {
              hintElement.textContent = `å·²è‡ªå‹•åµæ¸¬ç‚ºã€Œ${options[i].text}ã€ï¼Œå¦‚ä¸æ­£ç¢ºè«‹ä¿®æ”¹`;
              hintElement.style.color = '#10b981';
            }
            console.log('è‡ªå‹•è¨­å®šæ™‚å€ç‚º:', options[i].value, '(æ ¹æ“šåŸå¸‚åŒ¹é…)');
            return;
          }
        }
        
        // æ‰¾ä¸åˆ°åŒ¹é…çš„æ™‚å€
        if (hintElement) {
          hintElement.textContent = `åµæ¸¬åˆ°æ™‚å€ç‚º ${userTimezone}ï¼Œä½†åˆ—è¡¨ä¸­ç„¡æ­¤é¸é …ï¼Œè«‹æ‰‹å‹•é¸æ“‡`;
          hintElement.style.color = '#f59e0b';
        }
        console.log('ç„¡æ³•æ‰¾åˆ°åŒ¹é…çš„æ™‚å€:', userTimezone);
      } catch (error) {
        console.error('ç„¡æ³•åµæ¸¬æ™‚å€:', error);
        if (hintElement) {
          hintElement.textContent = 'ç„¡æ³•è‡ªå‹•åµæ¸¬æ™‚å€ï¼Œè«‹æ‰‹å‹•é¸æ“‡';
          hintElement.style.color = '#f59e0b';
        }
      }
    }

    async function postJSON(url, payload) {
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCsrfToken(),
        },
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        const message = data.message || Object.values(data)[0] || "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚";
        throw new Error(message);
      }
      return data;
    }

    elements.steps.send.querySelector("form").addEventListener("submit", async (event) => {
      event.preventDefault();
      hideAlert();
      
      const countryCode = elements.countryCodeSelect.value;
      const phone = elements.phoneInput.value.trim();
      
      if (!phone) {
        showAlert("è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ã€‚", "error");
        return;
      }
      
      // æ ¼å¼åŒ–ç‚º E.164 æ ¼å¼
      const formattedPhone = formatPhoneE164(countryCode, phone);
      
      elements.sendBtn.disabled = true;
      try {
        await postJSON(endpoints.send, { phone_number: formattedPhone });
        normalizedPhone = formattedPhone;
        showAlert("é©—è­‰ç¢¼å·²å¯„å‡ºï¼Œè«‹æ–¼ 5 åˆ†é˜å…§è¼¸å…¥ã€‚");
        switchStep("verify");
        elements.codeInput.focus();
      } catch (error) {
        showAlert(error.message, "error");
      } finally {
        elements.sendBtn.disabled = false;
      }
    });

    elements.resendBtn.addEventListener("click", async () => {
      if (!normalizedPhone) return;
      hideAlert();
      elements.resendBtn.disabled = true;
      try {
        await postJSON(endpoints.send, { phone_number: normalizedPhone });
        showAlert("æ–°çš„é©—è­‰ç¢¼å·²å¯„å‡ºã€‚");
      } catch (error) {
        showAlert(error.message, "error");
      } finally {
        elements.resendBtn.disabled = false;
      }
    });

    elements.steps.verify.querySelector("form").addEventListener("submit", async (event) => {
      event.preventDefault();
      hideAlert();
      if (!normalizedPhone) {
        showAlert("è«‹å…ˆè¼¸å…¥æ‰‹æ©Ÿä¸¦å–å¾—é©—è­‰ç¢¼ã€‚", "error");
        return;
      }
      const code = elements.codeInput.value.trim();
      if (!code) {
        showAlert("è«‹è¼¸å…¥é©—è­‰ç¢¼ã€‚", "error");
        return;
      }
      elements.verifyBtn.disabled = true;
      try {
        const data = await postJSON(endpoints.verify, {
          phone_number: normalizedPhone,
          code,
        });
        registrationToken = data.registration_token;
        showAlert("æ‰‹æ©Ÿé©—è­‰æˆåŠŸï¼Œè«‹ç¹¼çºŒå¡«å¯«åŸºæœ¬è³‡æ–™ã€‚");
        switchStep("complete");
        
        // è‡ªå‹•åµæ¸¬ä¸¦è¨­å®šæ™‚å€
        detectAndSetTimezone();
        
        elements.nicknameInput.focus();
      } catch (error) {
        showAlert(error.message, "error");
      } finally {
        elements.verifyBtn.disabled = false;
      }
    });

    elements.steps.complete.querySelector("form").addEventListener("submit", async (event) => {
      event.preventDefault();
      hideAlert();
      if (!registrationToken) {
        showAlert("è«‹å…ˆå®Œæˆæ‰‹æ©Ÿé©—è­‰ã€‚", "error");
        return;
      }
      const password = elements.passwordInput.value;
      const confirmPassword = elements.confirmPasswordInput.value;
      if (password !== confirmPassword) {
        showAlert("å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´ã€‚", "error");
        return;
      }
      const payload = {
        phone_token: registrationToken,
        password,
        nickname: elements.nicknameInput.value.trim(),
        timezone: elements.timezoneSelect.value,
        address: elements.addressInput.value.trim(),
      };
      if (!payload.nickname || !payload.timezone || !payload.address) {
        showAlert("è«‹å®Œæ•´å¡«å¯«å¿…å¡«æ¬„ä½ã€‚", "error");
        return;
      }
      elements.completeBtn.disabled = true;
      try {
        await postJSON(endpoints.complete, payload);
        hideAlert();
        switchStep("success");
      } catch (error) {
        showAlert(error.message, "error");
      } finally {
        elements.completeBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
