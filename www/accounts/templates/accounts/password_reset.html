<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>é‡è¨­å¯†ç¢¼</title>
  <style>
    * {
      box-sizing: border-box;
    }
    :root {
      color-scheme: light;
      font-family: "Noto Sans TC", system-ui, sans-serif;
    }
    body {
      margin: 0;
      background: #f8fafc;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: #ffffff;
      width: min(480px, 92%);
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.14);
      padding: 32px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 1.75rem;
      color: #0f172a;
    }
    p.lead {
      margin: 0 0 24px;
      color: #475569;
      line-height: 1.6;
    }
    form {
      display: grid;
      gap: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #1e293b;
      font-size: 0.95rem;
    }
    input, select, button {
      font: inherit;
      box-sizing: border-box;
    }
    input, select {
      display: block;
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #cbd5e1;
      background: #f8fbff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      font-size: 1rem;
      line-height: 1.5;
    }
    input::placeholder {
      color: #94a3b8;
      opacity: 1;
    }
    input:disabled,
    select:disabled {
      background: #f1f5f9;
      color: #94a3b8;
      cursor: not-allowed;
    }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 40px;
      cursor: pointer;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
      background: #ffffff;
    }
    button {
      display: inline-block;
      padding: 12px 16px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s ease;
      font-size: 1rem;
      line-height: 1.5;
      box-sizing: border-box;
    }
    button.primary {
      background: #2563eb;
      color: #ffffff;
    }
    button.primary:hover:not(:disabled) {
      background: #1d4ed8;
    }
    button.primary:disabled {
      background: #93c5fd;
      cursor: not-allowed;
    }
    button.secondary {
      background: transparent;
      border: 1px solid #cbd5e1;
      color: #1e40af;
    }
    button.secondary:hover:not(:disabled) {
      background: #f1f5f9;
      border-color: #94a3b8;
    }
    .step {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    .step.active {
      display: grid;
    }
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }
    .actions button {
      flex: 1;
    }
    .alert {
      display: none;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 0.96rem;
      margin-bottom: 16px;
    }
    .alert.show {
      display: block;
    }
    .alert.success {
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      color: #047857;
    }
    .alert.error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #b91c1c;
    }
    small {
      color: #64748b;
      font-size: 0.875rem;
      display: block;
      margin-top: 4px;
      line-height: 1.4;
    }
    a {
      text-decoration: none;
      display: block;
    }
    a button {
      width: 100%;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <main class="card">
    <h1>é‡è¨­å¯†ç¢¼</h1>
    <p class="lead">è¼¸å…¥è¨»å†Šæ‰‹æ©Ÿè™Ÿç¢¼ï¼Œæˆ‘å€‘æœƒå¯„é€ä¸€æ¬¡æ€§é©—è­‰ç¢¼å”åŠ©ä½ é‡è¨­å¯†ç¢¼ã€‚</p>

    <div id="alert" class="alert" role="alert"></div>

    <section id="step-phone" class="step active">
      <form>
        {% csrf_token %}
        <div>
          <label for="country-code-select">åœ‹ç¢¼</label>
          <select id="country-code-select" required>
            <option value="886" selected>ğŸ‡¹ğŸ‡¼ å°ç£ (+886)</option>
            <option value="86">ğŸ‡¨ğŸ‡³ ä¸­åœ‹ (+86)</option>
            <option value="852">ğŸ‡­ğŸ‡° é¦™æ¸¯ (+852)</option>
            <option value="853">ğŸ‡²ğŸ‡´ æ¾³é–€ (+853)</option>
            <option value="65">ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡ (+65)</option>
            <option value="60">ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº (+60)</option>
            <option value="1">ğŸ‡ºğŸ‡¸ ç¾åœ‹/åŠ æ‹¿å¤§ (+1)</option>
            <option value="81">ğŸ‡¯ğŸ‡µ æ—¥æœ¬ (+81)</option>
            <option value="82">ğŸ‡°ğŸ‡· éŸ“åœ‹ (+82)</option>
            <option value="44">ğŸ‡¬ğŸ‡§ è‹±åœ‹ (+44)</option>
          </select>
        </div>
        <div>
          <label for="phone-input">æ‰‹æ©Ÿè™Ÿç¢¼</label>
          <input id="phone-input" type="tel" placeholder="900000000" autocomplete="tel" required>
          <small>è«‹å‹¿è¼¸å…¥é–‹é ­çš„ 0ï¼Œç³»çµ±æœƒè‡ªå‹•è™•ç†</small>
          <small id="phone-preview" style="color: #2563eb; font-weight: 600; display: none;">
            å®Œæ•´è™Ÿç¢¼ï¼š<span id="phone-preview-text"></span>
          </small>
        </div>
        <div class="actions">
          <button id="send-btn" class="primary" type="submit">å¯„é€é©—è­‰ç¢¼</button>
        </div>
      </form>
    </section>

    <section id="step-reset" class="step">
      <form>
        {% csrf_token %}
        <div>
          <label for="code-input">é©—è­‰ç¢¼</label>
          <input id="code-input" type="text" maxlength="6" inputmode="numeric" placeholder="è¼¸å…¥ç°¡è¨Šé©—è­‰ç¢¼" required>
        </div>
        <div>
          <label for="password-input">æ–°å¯†ç¢¼</label>
          <input id="password-input" type="password" minlength="8" autocomplete="new-password" required>
        </div>
        <div>
          <label for="confirm-password-input">ç¢ºèªæ–°å¯†ç¢¼</label>
          <input id="confirm-password-input" type="password" minlength="8" autocomplete="new-password" required>
        </div>
        <div class="actions">
          <button id="reset-btn" class="primary" type="submit">æ›´æ–°å¯†ç¢¼</button>
          <button id="resend-btn" class="secondary" type="button">é‡æ–°å¯„é€é©—è­‰ç¢¼</button>
        </div>
      </form>
    </section>

    <section id="step-success" class="step">
      <p class="lead">å¯†ç¢¼æ›´æ–°æˆåŠŸï¼è«‹å›åˆ°ç™»å…¥é é¢ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥ã€‚</p>
      <div class="actions">
        <a href="{% url 'accounts:login' %}">
          <button class="primary" type="button">è¿”å›ç™»å…¥</button>
        </a>
      </div>
    </section>
  </main>

  <script>
    const endpoints = {
      send: "{{ send_code_url }}",
      confirm: "{{ confirm_url }}"
    };

    const el = {
      alert: document.getElementById("alert"),
      steps: {
        phone: document.getElementById("step-phone"),
        reset: document.getElementById("step-reset"),
        success: document.getElementById("step-success"),
      },
      countryCodeSelect: document.getElementById("country-code-select"),
      phoneInput: document.getElementById("phone-input"),
      phonePreview: document.getElementById("phone-preview"),
      phonePreviewText: document.getElementById("phone-preview-text"),
      codeInput: document.getElementById("code-input"),
      passwordInput: document.getElementById("password-input"),
      confirmPasswordInput: document.getElementById("confirm-password-input"),
      sendBtn: document.getElementById("send-btn"),
      resetBtn: document.getElementById("reset-btn"),
      resendBtn: document.getElementById("resend-btn"),
    };

    let normalizedPhone = null;

    function getCsrfToken() {
      const cookie = document.cookie.match(/csrftoken=([^;]+)/);
      if (cookie) {
        return decodeURIComponent(cookie[1]);
      }
      const input = document.querySelector("input[name=csrfmiddlewaretoken]");
      return input ? input.value : "";
    }

    function showAlert(message, type = "success") {
      el.alert.textContent = message;
      el.alert.className = `alert ${type} show`;
    }

    function hideAlert() {
      el.alert.classList.remove("show", "success", "error");
    }

    function switchStep(key) {
      Object.entries(el.steps).forEach(([name, section]) => {
        section.classList.toggle("active", name === key);
      });
    }

    /**
     * æ ¼å¼åŒ–æ‰‹æ©Ÿè™Ÿç¢¼ç‚º E.164 æ ¼å¼
     * @param {string} countryCode - åœ‹ç¢¼ï¼ˆä¸å«+è™Ÿï¼‰
     * @param {string} phoneNumber - æ‰‹æ©Ÿè™Ÿç¢¼
     * @returns {string} - E.164 æ ¼å¼çš„å®Œæ•´è™Ÿç¢¼ (ä¾‹: +886900000000)
     */
    function formatPhoneE164(countryCode, phoneNumber) {
      // ç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦
      let cleanNumber = phoneNumber.replace(/\D/g, '');
      
      // å¦‚æœè™Ÿç¢¼ä»¥ 0 é–‹é ­ï¼Œç§»é™¤é–‹é ­çš„ 0
      if (cleanNumber.startsWith('0')) {
        cleanNumber = cleanNumber.substring(1);
      }
      
      // çµ„åˆæˆ E.164 æ ¼å¼
      return `+${countryCode}${cleanNumber}`;
    }

    /**
     * æ­£è¦åŒ–ä¸¦é¡¯ç¤ºè™•ç†å¾Œçš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆä¸å«åœ‹ç¢¼éƒ¨åˆ†ï¼‰
     */
    function normalizePhoneInput() {
      const phone = el.phoneInput.value.trim();
      if (!phone) {
        el.phonePreview.style.display = 'none';
        return;
      }
      
      // ç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦
      let cleanNumber = phone.replace(/\D/g, '');
      
      // å¦‚æœè™Ÿç¢¼ä»¥ 0 é–‹é ­ï¼Œç§»é™¤é–‹é ­çš„ 0
      if (cleanNumber.startsWith('0')) {
        cleanNumber = cleanNumber.substring(1);
      }
      
      // æ›´æ–°è¼¸å…¥æ¡†é¡¯ç¤ºè™•ç†å¾Œçš„è™Ÿç¢¼
      if (cleanNumber !== phone.replace(/\D/g, '')) {
        el.phoneInput.value = cleanNumber;
      }
      
      // é¡¯ç¤ºå®Œæ•´çš„ E.164 æ ¼å¼é è¦½
      if (cleanNumber) {
        const countryCode = el.countryCodeSelect.value;
        const fullNumber = `+${countryCode}${cleanNumber}`;
        el.phonePreviewText.textContent = fullNumber;
        el.phonePreview.style.display = 'block';
      } else {
        el.phonePreview.style.display = 'none';
      }
    }

    // ç•¶æ‰‹æ©Ÿè™Ÿç¢¼è¼¸å…¥æ¡†å¤±ç„¦æ™‚ï¼Œè‡ªå‹•æ­£è¦åŒ–é¡¯ç¤º
    el.phoneInput.addEventListener('blur', normalizePhoneInput);
    
    // ç•¶åœ‹ç¢¼æ”¹è®Šæ™‚ï¼Œä¹Ÿé‡æ–°æ­£è¦åŒ–è™Ÿç¢¼
    el.countryCodeSelect.addEventListener('change', normalizePhoneInput);

    async function postJSON(url, payload) {
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCsrfToken(),
        },
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        const message = data.message || "æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        throw new Error(message);
      }
      return data;
    }

    el.steps.phone.querySelector("form").addEventListener("submit", async (event) => {
      event.preventDefault();
      hideAlert();
      
      const countryCode = el.countryCodeSelect.value;
      const phone = el.phoneInput.value.trim();
      
      if (!phone) {
        showAlert("è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ã€‚", "error");
        return;
      }
      
      // æ ¼å¼åŒ–ç‚º E.164 æ ¼å¼
      const formattedPhone = formatPhoneE164(countryCode, phone);
      
      el.sendBtn.disabled = true;
      try {
        const result = await postJSON(endpoints.send, { phone_number: formattedPhone });
        normalizedPhone = formattedPhone;
        showAlert(result.message || "é©—è­‰ç¢¼å·²å¯„å‡ºã€‚");
        switchStep("reset");
        el.codeInput.focus();
      } catch (error) {
        showAlert(error.message, "error");
      } finally {
        el.sendBtn.disabled = false;
      }
    });

    el.resendBtn.addEventListener("click", async () => {
      if (!normalizedPhone) return;
      hideAlert();
      el.resendBtn.disabled = true;
      try {
        const result = await postJSON(endpoints.send, { phone_number: normalizedPhone });
        showAlert(result.message || "æ–°çš„é©—è­‰ç¢¼å·²å¯„å‡ºã€‚");
      } catch (error) {
        showAlert(error.message, "error");
      } finally {
        el.resendBtn.disabled = false;
      }
    });

    el.steps.reset.querySelector("form").addEventListener("submit", async (event) => {
      event.preventDefault();
      hideAlert();
      if (!normalizedPhone) {
        showAlert("è«‹å…ˆè¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ä¸¦å–å¾—é©—è­‰ç¢¼ã€‚", "error");
        return;
      }
      const code = el.codeInput.value.trim();
      const password = el.passwordInput.value;
      const confirm = el.confirmPasswordInput.value;
      if (!code) {
        showAlert("è«‹è¼¸å…¥é©—è­‰ç¢¼ã€‚", "error");
        return;
      }
      if (password !== confirm) {
        showAlert("å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´ã€‚", "error");
        return;
      }
      el.resetBtn.disabled = true;
      try {
        const payload = {
          phone_number: normalizedPhone,
          code,
          new_password: password,
          confirm_password: confirm,
        };
        const result = await postJSON(endpoints.confirm, payload);
        showAlert(result.message || "å¯†ç¢¼å·²æ›´æ–°ã€‚");
        switchStep("success");
      } catch (error) {
        showAlert(error.message, "error");
      } finally {
        el.resetBtn.disabled = false;
      }
    });
  </script>
</body>
</html>