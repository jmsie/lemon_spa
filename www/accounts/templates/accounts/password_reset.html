<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>重設密碼</title>
  <style>
    :root { color-scheme: light; font-family: "Noto Sans TC", system-ui, sans-serif; }
    body {
      margin: 0;
      background: #f8fafc;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: #ffffff;
      width: min(480px, 92%);
      border-radius: 16px;
      box-shadow: 0 18px 36px rgba(15, 23, 42, 0.14);
      padding: 32px;
    }
    h1 { margin: 0 0 12px; font-size: 1.75rem; color: #0f172a; }
    p.lead { margin: 0 0 24px; color: #475569; line-height: 1.6; }
    form { display: grid; gap: 16px; }
    label { font-weight: 600; color: #1e293b; margin-bottom: 6px; display:block; }
    input, button { font: inherit; }
    input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #cbd5f5;
      background: #f8fbff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
      background: #ffffff;
    }
    button {
      padding: 12px 16px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button.primary { background: #2563eb; color: #ffffff; }
    button.primary:disabled { background: #93c5fd; cursor: wait; }
    button.secondary {
      background: transparent;
      border: 1px solid rgba(30, 64, 175, 0.35);
      color: #1e3a8a;
    }
    .actions { display: flex; gap: 12px; }
    .step { display: none; animation: fade 0.25s ease; }
    .step.active { display: grid; }
    .alert {
      display: none;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 0.95rem;
    }
    .alert.show { display: block; }
    .alert.success { background: #ecfdf5; border: 1px solid #a7f3d0; color: #047857; }
    .alert.error { background: #fef2f2; border: 1px solid #fecaca; color: #b91c1c; }
    @keyframes fade { from { opacity: 0; transform: translateY(8px);} to { opacity:1; transform: translateY(0);} }
  </style>
</head>
<body>
  <main class="card">
    <h1>重設密碼</h1>
    <p class="lead">輸入註冊手機號碼，我們會寄送一次性驗證碼協助你重設密碼。</p>

    <div id="alert" class="alert" role="alert"></div>

    <section id="step-phone" class="step active">
      <form>
        {% csrf_token %}
        <div>
          <label for="phone-input">手機號碼</label>
          <input id="phone-input" type="tel" placeholder="+886 900 000 000" autocomplete="tel" required>
        </div>
        <div class="actions">
          <button id="send-btn" class="primary" type="submit">寄送驗證碼</button>
        </div>
      </form>
    </section>

    <section id="step-reset" class="step">
      <form>
        {% csrf_token %}
        <div>
          <label for="code-input">驗證碼</label>
          <input id="code-input" type="text" maxlength="6" inputmode="numeric" placeholder="輸入簡訊驗證碼" required>
        </div>
        <div>
          <label for="password-input">新密碼</label>
          <input id="password-input" type="password" minlength="8" autocomplete="new-password" required>
        </div>
        <div>
          <label for="confirm-password-input">確認新密碼</label>
          <input id="confirm-password-input" type="password" minlength="8" autocomplete="new-password" required>
        </div>
        <div class="actions">
          <button id="reset-btn" class="primary" type="submit">更新密碼</button>
          <button id="resend-btn" class="secondary" type="button">重新寄送驗證碼</button>
        </div>
      </form>
    </section>

    <section id="step-success" class="step">
      <p class="lead">密碼更新成功！請回到登入頁面使用新密碼登入。</p>
      <div class="actions">
        <a href="{% url 'accounts:login' %}">
          <button class="primary" type="button">返回登入</button>
        </a>
      </div>
    </section>
  </main>

  <script>
    const endpoints = {
      send: "{{ send_code_url }}",
      confirm: "{{ confirm_url }}"
    };

    const el = {
      alert: document.getElementById("alert"),
      steps: {
        phone: document.getElementById("step-phone"),
        reset: document.getElementById("step-reset"),
        success: document.getElementById("step-success"),
      },
      phoneInput: document.getElementById("phone-input"),
      codeInput: document.getElementById("code-input"),
      passwordInput: document.getElementById("password-input"),
      confirmPasswordInput: document.getElementById("confirm-password-input"),
      sendBtn: document.getElementById("send-btn"),
      resetBtn: document.getElementById("reset-btn"),
      resendBtn: document.getElementById("resend-btn"),
    };

    let normalizedPhone = null;

    function getCsrfToken() {
      const cookie = document.cookie.match(/csrftoken=([^;]+)/);
      if (cookie) {
        return decodeURIComponent(cookie[1]);
      }
      const input = document.querySelector("input[name=csrfmiddlewaretoken]");
      return input ? input.value : "";
    }

    function showAlert(message, type = "success") {
      el.alert.textContent = message;
      el.alert.className = `alert ${type} show`;
    }

    function hideAlert() {
      el.alert.classList.remove("show", "success", "error");
    }

    function switchStep(key) {
      Object.entries(el.steps).forEach(([name, section]) => {
        section.classList.toggle("active", name === key);
      });
    }

    async function postJSON(url, payload) {
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCsrfToken(),
        },
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        const message = data.message || "操作失敗，請稍後再試。";
        throw new Error(message);
      }
      return data;
    }

    el.steps.phone.querySelector("form").addEventListener("submit", async (event) => {
      event.preventDefault();
      hideAlert();
      const phone = el.phoneInput.value.trim();
      if (!phone) {
        showAlert("請輸入手機號碼。", "error");
        return;
      }
      el.sendBtn.disabled = true;
      try {
        const result = await postJSON(endpoints.send, { phone_number: phone });
        normalizedPhone = phone;
        showAlert(result.message || "驗證碼已寄出。");
        switchStep("reset");
        el.codeInput.focus();
      } catch (error) {
        showAlert(error.message, "error");
      } finally {
        el.sendBtn.disabled = false;
      }
    });

    el.resendBtn.addEventListener("click", async () => {
      if (!normalizedPhone) return;
      hideAlert();
      el.resendBtn.disabled = true;
      try {
        const result = await postJSON(endpoints.send, { phone_number: normalizedPhone });
        showAlert(result.message || "新的驗證碼已寄出。");
      } catch (error) {
        showAlert(error.message, "error");
      } finally {
        el.resendBtn.disabled = false;
      }
    });

    el.steps.reset.querySelector("form").addEventListener("submit", async (event) => {
      event.preventDefault();
      hideAlert();
      if (!normalizedPhone) {
        showAlert("請先輸入手機號碼並取得驗證碼。", "error");
        return;
      }
      const code = el.codeInput.value.trim();
      const password = el.passwordInput.value;
      const confirm = el.confirmPasswordInput.value;
      if (!code) {
        showAlert("請輸入驗證碼。", "error");
        return;
      }
      if (password !== confirm) {
        showAlert("兩次輸入的密碼不一致。", "error");
        return;
      }
      el.resetBtn.disabled = true;
      try {
        const payload = {
          phone_number: normalizedPhone,
          code,
          new_password: password,
          confirm_password: confirm,
        };
        const result = await postJSON(endpoints.confirm, payload);
        showAlert(result.message || "密碼已更新。");
        switchStep("success");
      } catch (error) {
        showAlert(error.message, "error");
      } finally {
        el.resetBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
