<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ç™»å…¥ Lemon Spa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¦†è“‹ Django form ç”Ÿæˆçš„ input æ¨£å¼ */
        html {
            height: 100%;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            min-height: 100%;
            min-height: -webkit-fill-available;
        }
        input[type="text"],
        input[type="tel"],
        input[type="password"],
        select {
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            transition: all 0.2s;
        }
        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="password"]:focus,
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        input[type="password"] {
            padding-left: 3rem;
        }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
            cursor: pointer;
        }
        #id_username {
            display: none;
        }
        .errorlist {
            margin: 0;
            padding: 0;
            list-style: none;
        }
    </style>
</head>
<body class="bg-gradient-to-b from-blue-50 to-white md:bg-gray-100 md:flex md:items-center md:justify-center">
    <!-- ç§»å‹•ç‰ˆï¼šå…¨å± | æ¡Œé¢ç‰ˆï¼šç½®ä¸­å¡ç‰‡ -->
    <main class="min-h-screen md:min-h-0 flex flex-col px-6 py-8 md:bg-white md:rounded-2xl md:shadow-2xl md:max-w-md md:w-full md:m-8">
        
        <!-- Logo/Brand å€åŸŸ -->
        <div class="flex-shrink-0 text-center mb-8 mt-4 md:mt-2 md:mb-6">
            <!-- ç§»å‹•ç‰ˆï¼šå¤§åœ–æ¨™ | æ¡Œé¢ç‰ˆï¼šå°åœ–æ¨™ -->
            <div class="inline-flex items-center justify-center w-16 h-16 md:w-14 md:h-14 bg-blue-600 rounded-2xl mb-4 md:mb-3 shadow-lg shadow-blue-500/30">
                <svg class="w-8 h-8 md:w-7 md:h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
            </div>
            <h1 class="text-3xl md:text-2xl font-bold text-gray-900 mb-2 md:mb-1">æ­¡è¿å›ä¾†</h1>
            <p class="text-gray-600 text-sm md:text-xs">ç™»å…¥ä»¥ç¹¼çºŒä½¿ç”¨æœå‹™</p>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        {% if form.non_field_errors %}
        <div class="mb-6 md:mb-4 p-4 md:p-3 bg-red-50 border-2 border-red-200 rounded-xl md:rounded-lg">
            <ul class="errorlist space-y-1">
                {% for error in form.non_field_errors %}
                <li class="text-red-700 text-sm md:text-xs font-medium flex items-start">
                    <svg class="w-5 h-5 md:w-4 md:h-4 mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    {{ error }}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- è¡¨å–®å€åŸŸ -->
        <div class="flex-1 md:flex-none flex flex-col">
            <form method="post" novalidate class="space-y-5 md:space-y-4">
                {% csrf_token %}
                {% if next %}
                <input type="hidden" name="next" value="{{ next }}">
                {% endif %}
                
                <!-- æ‰‹æ©Ÿè™Ÿç¢¼è¼¸å…¥ -->
                <div>
                    <label for="country-code-select" class="block text-sm md:text-xs font-semibold text-gray-700 mb-2">
                        {{ form.username.label }}
                    </label>

                    <!-- éš±è—çš„åŸå§‹è¡¨å–®æ¬„ä½ -->
                    {{ form.username }}

                    <!-- åœ‹ç¢¼é¸æ“‡å™¨ -->
                    <div class="mb-3 md:mb-2">
                        <label for="country-code-select" class="block text-xs md:text-xs font-medium text-gray-600 mb-1.5">åœ‹ç¢¼</label>
                        <select id="country-code-select" required>
                            <option value="886" selected>ğŸ‡¹ğŸ‡¼ å°ç£ (+886)</option>
                            <option value="86">ğŸ‡¨ğŸ‡³ ä¸­åœ‹ (+86)</option>
                            <option value="852">ğŸ‡­ğŸ‡° é¦™æ¸¯ (+852)</option>
                            <option value="853">ğŸ‡²ğŸ‡´ æ¾³é–€ (+853)</option>
                            <option value="65">ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡ (+65)</option>
                            <option value="60">ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº (+60)</option>
                            <option value="1">ğŸ‡ºğŸ‡¸ ç¾åœ‹/åŠ æ‹¿å¤§ (+1)</option>
                            <option value="81">ğŸ‡¯ğŸ‡µ æ—¥æœ¬ (+81)</option>
                            <option value="82">ğŸ‡°ğŸ‡· éŸ“åœ‹ (+82)</option>
                            <option value="44">ğŸ‡¬ğŸ‡§ è‹±åœ‹ (+44)</option>
                        </select>
                    </div>

                    <!-- æ‰‹æ©Ÿè™Ÿç¢¼è¼¸å…¥æ¡† -->
                    <div>
                        <label for="phone-input" class="block text-xs md:text-xs font-medium text-gray-600 mb-1.5">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                        <input id="phone-input" type="tel" placeholder="900000000" autocomplete="tel" required>
                        <small class="block mt-1.5 text-gray-500 text-xs">è«‹å‹¿è¼¸å…¥é–‹é ­çš„ 0ï¼Œç³»çµ±æœƒè‡ªå‹•è™•ç†</small>
                        <small id="phone-preview" class="hidden mt-1 text-blue-600 font-semibold text-xs">
                            å®Œæ•´è™Ÿç¢¼ï¼š<span id="phone-preview-text"></span>
                        </small>
                    </div>

                    {% if form.username.errors %}
                    <ul class="errorlist mt-2">
                        {% for error in form.username.errors %}
                        <li class="text-red-600 text-sm md:text-xs">{{ error }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>

                <!-- å¯†ç¢¼è¼¸å…¥ -->
                <div>
                    <label for="{{ form.password.id_for_label }}" class="block text-sm md:text-xs font-semibold text-gray-700 mb-2">
                        å¯†ç¢¼
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-4 md:pl-3 flex items-center pointer-events-none z-10">
                            <svg class="w-5 h-5 md:w-4 md:h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                        </div>
                        {{ form.password }}
                    </div>
                    {% if form.password.errors %}
                    <ul class="errorlist mt-2">
                        {% for error in form.password.errors %}
                        <li class="text-red-600 text-sm md:text-xs">{{ error }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>

                <!-- ä¸»è¦ç™»å…¥æŒ‰éˆ• -->
                <button 
                    type="submit"
                    class="w-full py-4 md:py-3 px-4 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-base md:text-sm font-semibold rounded-xl md:rounded-lg shadow-lg shadow-blue-500/30 transition-all duration-200 active:scale-[0.98] mt-8 md:mt-6">
                    ç™»å…¥
                </button>
            </form>

            <!-- æ¬¡è¦æ“ä½œæŒ‰éˆ• -->
            <div class="mt-6 md:mt-4 space-y-3 md:space-y-2">
                <a 
                    href="{% url 'accounts:register' %}"
                    class="flex items-center justify-center w-full py-4 md:py-3 px-4 bg-white md:bg-gray-50 border-2 border-gray-200 hover:border-gray-300 hover:bg-gray-50 md:hover:bg-gray-100 active:bg-gray-100 text-gray-700 text-base md:text-sm font-semibold rounded-xl md:rounded-lg transition-all duration-200 active:scale-[0.98]">
                    <svg class="w-5 h-5 md:w-4 md:h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                    </svg>
                    å»ºç«‹æ–°å¸³è™Ÿ
                </a>
                
                <a 
                    href="{% url 'accounts:password_reset' %}"
                    class="flex items-center justify-center w-full py-4 md:py-3 px-4 bg-white md:bg-gray-50 border-2 border-gray-200 hover:border-gray-300 hover:bg-gray-50 md:hover:bg-gray-100 active:bg-gray-100 text-gray-700 text-base md:text-sm font-semibold rounded-xl md:rounded-lg transition-all duration-200 active:scale-[0.98]">
                    <svg class="w-5 h-5 md:w-4 md:h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                    </svg>
                    å¿˜è¨˜å¯†ç¢¼
                </a>
            </div>

            <!-- æç¤ºæ–‡å­— -->
            <p class="mt-8 md:mt-6 text-center text-sm md:text-xs text-gray-500 leading-relaxed px-4 md:px-0">
                è«‹ä½¿ç”¨è¨»å†Šæ™‚çš„æ‰‹æ©Ÿè™Ÿç¢¼èˆ‡å¯†ç¢¼ç™»å…¥<br>
                ç™»å…¥å¾Œå¯åˆ‡æ›å°æ‡‰çš„è§’è‰²ä»‹é¢
            </p>
        </div>
    </main>

    <script>
        // å–å¾— DOM å…ƒç´ 
        const countryCodeSelect = document.getElementById('country-code-select');
        const phoneInput = document.getElementById('phone-input');
        const phonePreview = document.getElementById('phone-preview');
        const phonePreviewText = document.getElementById('phone-preview-text');
        const usernameField = document.getElementById('{{ form.username.id_for_label }}');
        const loginForm = document.querySelector('form');

        /**
         * æ ¼å¼åŒ–æ‰‹æ©Ÿè™Ÿç¢¼ç‚º E.164 æ ¼å¼
         * @param {string} countryCode - åœ‹ç¢¼ï¼ˆä¸å« + è™Ÿï¼‰
         * @param {string} phoneNumber - æ‰‹æ©Ÿè™Ÿç¢¼
         * @returns {string} E.164 æ ¼å¼çš„å®Œæ•´è™Ÿç¢¼
         */
        function formatPhoneE164(countryCode, phoneNumber) {
            let cleanNumber = phoneNumber.replace(/\D/g, '');
            if (cleanNumber.startsWith('0')) {
                cleanNumber = cleanNumber.substring(1);
            }
            return `+${countryCode}${cleanNumber}`;
        }

        /**
         * æ­£è¦åŒ–ä¸¦é¡¯ç¤ºè™•ç†å¾Œçš„æ‰‹æ©Ÿè™Ÿç¢¼
         */
        function normalizePhoneInput() {
            const phone = phoneInput.value.trim();
            if (!phone) {
                phonePreview.classList.add('hidden');
                return;
            }

            // ç§»é™¤éæ•¸å­—å­—å…ƒ
            let cleanNumber = phone.replace(/\D/g, '');

            // ç§»é™¤é–‹é ­çš„ 0
            if (cleanNumber.startsWith('0')) {
                cleanNumber = cleanNumber.substring(1);
            }

            // å¦‚æœè™Ÿç¢¼è¢«ä¿®æ”¹ï¼Œæ›´æ–°è¼¸å…¥æ¡†
            if (cleanNumber !== phone.replace(/\D/g, '')) {
                phoneInput.value = cleanNumber;
            }

            // é¡¯ç¤ºå®Œæ•´è™Ÿç¢¼é è¦½
            if (cleanNumber) {
                const countryCode = countryCodeSelect.value;
                const fullNumber = `+${countryCode}${cleanNumber}`;
                phonePreviewText.textContent = fullNumber;
                phonePreview.classList.remove('hidden');
            } else {
                phonePreview.classList.add('hidden');
            }
        }

        // ç›£è½è¼¸å…¥æ¡†å¤±ç„¦äº‹ä»¶
        phoneInput.addEventListener('blur', normalizePhoneInput);

        // ç›£è½åœ‹ç¢¼é¸æ“‡å™¨è®Šæ›´äº‹ä»¶
        countryCodeSelect.addEventListener('change', normalizePhoneInput);

        // è¡¨å–®é€å‡ºå‰ï¼Œå°‡çµ„åˆå¾Œçš„å®Œæ•´è™Ÿç¢¼å¡«å…¥éš±è—æ¬„ä½
        loginForm.addEventListener('submit', (event) => {
            const countryCode = countryCodeSelect.value;
            const phone = phoneInput.value.trim();

            if (phone) {
                const fullPhoneNumber = formatPhoneE164(countryCode, phone);
                usernameField.value = fullPhoneNumber;
            }
        });

        // é é¢è¼‰å…¥æ™‚ï¼Œå¦‚æœéš±è—æ¬„ä½æœ‰å€¼ï¼ˆä¾‹å¦‚è¡¨å–®é©—è­‰å¤±æ•—å¾Œé‡æ–°è¼‰å…¥ï¼‰ï¼Œè§£æä¸¦å¡«å›
        window.addEventListener('DOMContentLoaded', () => {
            const existingValue = usernameField.value;
            if (existingValue && existingValue.startsWith('+')) {
                // å˜—è©¦è§£æå·²æœ‰çš„ E.164 æ ¼å¼è™Ÿç¢¼
                const match = existingValue.match(/^\+(\d+)(\d+)$/);
                if (match) {
                    // é€™è£¡ç°¡å–®è™•ç†ï¼Œå¯¦éš›ä¸Šå¯èƒ½éœ€è¦æ›´è¤‡é›œçš„é‚è¼¯ä¾†åˆ¤æ–·åœ‹ç¢¼é•·åº¦
                    // ç”±æ–¼æˆ‘å€‘çš„åœ‹ç¢¼é¸æ“‡å™¨æœ‰å›ºå®šçš„å€¼ï¼Œå¯ä»¥å˜—è©¦åŒ¹é…
                    const fullNumber = match[0].substring(1); // å»æ‰ +
                    for (let option of countryCodeSelect.options) {
                        if (fullNumber.startsWith(option.value)) {
                            countryCodeSelect.value = option.value;
                            phoneInput.value = fullNumber.substring(option.value.length);
                            normalizePhoneInput();
                            break;
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
