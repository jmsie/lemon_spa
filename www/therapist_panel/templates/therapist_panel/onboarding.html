{% extends "therapist_panel/base.html" %}

{% block title %}導覽設定 | 治療師面板{% endblock %}

{% block extra_head %}
  <style>
    /* 步骤指示器 - 响应式设计 */
    .onboarding-stepper {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
      margin-bottom: 2rem;
    }
    @media (min-width: 768px) {
      .onboarding-stepper {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }
    .onboarding-stepper .step-indicator {
      position: relative;
      padding: 0.875rem 0.5rem;
      border-radius: 0.75rem;
      background-color: var(--bs-secondary-bg);
      color: var(--bs-secondary-color);
      text-align: center;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }
    @media (min-width: 768px) {
      .onboarding-stepper .step-indicator {
        padding: 0.875rem;
        font-size: 0.95rem;
      }
    }
    .onboarding-stepper .step-indicator.active {
      background: var(--bs-primary);
      color: #fff;
      box-shadow: 0 0.5rem 1rem rgba(13, 110, 253, 0.15);
      transform: translateY(-2px);
    }
    .onboarding-stepper .step-indicator.completed {
      background: rgba(13, 110, 253, 0.15);
      color: var(--bs-primary);
    }
    .onboarding-section {
      display: none;
      animation: fadeInUp 300ms ease-out;
    }
    .onboarding-section.active {
      display: block;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(16px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* 表格响应式优化 */
    .collection-table td,
    .collection-table th {
      vertical-align: middle;
    }
    @media (max-width: 767.98px) {
      .table-responsive {
        border-radius: 0.5rem;
      }
      .collection-table {
        font-size: 0.875rem;
      }
      .collection-table .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
      }
    }
    
    /* 周选择器优化 */
    .weekday-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .weekday-selector .form-check-inline {
      margin: 0;
    }
    .weekday-selector .btn {
      min-width: 3rem;
      font-weight: 600;
    }
    @media (max-width: 575.98px) {
      .weekday-selector .btn {
        min-width: 2.5rem;
        font-size: 0.875rem;
        padding: 0.5rem 0.25rem;
      }
    }
    
    /* 表单提示文字 */
    .form-hint {
      font-size: 0.875rem;
      color: var(--bs-secondary-color);
      margin-top: 0.25rem;
    }
    
    /* 操作按钮组响应式 */
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    @media (min-width: 576px) {
      .action-buttons {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
    }
    
    /* 卡片优化 */
    .card {
      border: none;
      box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.075);
    }
    @media (max-width: 767.98px) {
      .card {
        border-radius: 1rem;
      }
      .card-body {
        padding: 1.5rem !important;
      }
    }
    
    /* 成功页面样式 */
    .success-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    @media (min-width: 768px) {
      .success-icon {
        font-size: 4rem;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container-fluid px-3 px-md-4 py-4">
    <!-- 页面标题 -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
      <div>
        <h1 class="h3 h2-md mb-2">歡迎加入 Lemon Spa！</h1>
        <p class="mb-0 text-body-secondary">只要 4 個步驟，建立療程、上班時間與休假，馬上開啟線上預約。</p>
      </div>
      <div>
        <span class="badge text-bg-light border fs-6 py-2 px-3">
          <i class="bi bi-info-circle me-1"></i>
          導覽完成後即可取得預約連結
        </span>
      </div>
    </div>

    <!-- 步骤指示器 -->
    <div class="onboarding-stepper mb-4" id="onboarding-stepper">
      <div class="step-indicator active" data-step-index="1">
        <span class="d-none d-md-inline">1. </span>建立療程
      </div>
      <div class="step-indicator" data-step-index="2">
        <span class="d-none d-md-inline">2. </span>上班時間
      </div>
      <div class="step-indicator" data-step-index="3">
        <span class="d-none d-md-inline">3. </span>休假設定
      </div>
      <div class="step-indicator" data-step-index="4">
        <span class="d-none d-md-inline">4. </span>完成
      </div>
    </div>

    <!-- 主卡片 -->
    <div class="card">
      <div class="card-body p-3 p-md-4 p-lg-5">
        
        <!-- 步驟 1：建立療程 -->
        <section class="onboarding-section active" data-step="1">
          <header class="mb-4">
            <h2 class="h4 h3-md mb-2">步驟 1：新增你提供的療程</h2>
            <p class="text-body-secondary mb-0">至少需要一個療程，才能讓客戶選擇服務項目。</p>
          </header>

          <form id="treatment-form" class="needs-validation" novalidate>
            <input type="hidden" name="id" id="treatment-id">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="treatment-name" class="form-label fw-semibold">療程名稱</label>
                <input type="text" class="form-control form-control-lg" id="treatment-name" name="name" required placeholder="例如：深層按摩 60 分鐘">
              </div>
              <div class="col-6 col-md-3">
                <label for="treatment-duration" class="form-label fw-semibold">服務時間</label>
                <div class="input-group input-group-lg">
                  <input type="number" class="form-control" id="treatment-duration" name="duration_minutes" min="1" required value="60">
                  <span class="input-group-text">分鐘</span>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <label for="treatment-preparation" class="form-label fw-semibold">預留準備</label>
                <div class="input-group input-group-lg">
                  <input type="number" class="form-control" id="treatment-preparation" name="preparation_minutes" min="0" value="10">
                  <span class="input-group-text">分鐘</span>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <label for="treatment-price" class="form-label fw-semibold">價格</label>
                <div class="input-group input-group-lg">
                  <span class="input-group-text">NT$</span>
                  <input type="number" class="form-control" id="treatment-price" name="price" min="0" step="0.01" required placeholder="1500">
                </div>
              </div>
              <div class="col-12 col-md-8">
                <label for="treatment-notes" class="form-label fw-semibold">備註 <span class="text-muted fw-normal">(選填)</span></label>
                <textarea class="form-control" id="treatment-notes" name="notes" rows="2" placeholder="提供可選加值項目或注意事項"></textarea>
              </div>
              <div class="col-12">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" value="1" id="treatment-active" name="is_active" checked>
                  <label class="form-check-label" for="treatment-active">
                    上架此療程（若稍後要暫停，可取消勾選）
                  </label>
                </div>
              </div>
            </div>
            
            <div class="action-buttons mt-4">
              <div id="treatment-form-errors" class="flex-grow-1"></div>
              <div class="d-flex gap-2 flex-grow-1 flex-sm-grow-0">
                <button type="button" class="btn btn-outline-secondary flex-fill flex-sm-grow-0" id="reset-treatment-form">
                  <i class="bi bi-x-circle me-1"></i>
                  清除
                </button>
                <button type="submit" class="btn btn-primary flex-fill flex-sm-grow-0" id="submit-treatment-btn">
                  <i class="bi bi-plus-circle me-1"></i>
                  儲存療程
                </button>
              </div>
            </div>
          </form>

          <hr class="my-4">

          <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-3 mb-3">
            <h3 class="h5 mb-0">已建立的療程</h3>
            <span class="badge bg-primary-subtle text-primary border border-primary-subtle fs-6 py-2 px-3" id="treatment-count-badge">0 個療程</span>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover align-middle collection-table">
              <thead class="table-light">
                <tr>
                  <th scope="col">名稱</th>
                  <th scope="col" class="d-none d-md-table-cell">時間</th>
                  <th scope="col">價格</th>
                  <th scope="col" class="d-none d-lg-table-cell">備註</th>
                  <th scope="col" class="text-center">狀態</th>
                  <th scope="col" class="text-end">操作</th>
                </tr>
              </thead>
              <tbody id="treatments-list">
                <tr>
                  <td colspan="6" class="text-center py-5 text-body-secondary">
                    <i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>
                    目前尚未建立療程
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="d-flex justify-content-end mt-4">
            <button class="btn btn-primary btn-lg" data-action="next" data-target-step="2" id="step-1-next" disabled>
              下一步：設定上班時間
              <i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
        </section>

        <!-- 步驟 2：設定上班時間 -->
        <section class="onboarding-section" data-step="2">
          <header class="mb-4">
            <h2 class="h4 h3-md mb-2">步驟 2：設定上班時間</h2>
            <p class="text-body-secondary mb-0">建立至少一段可預約的時段，客戶才能在這些時間預約你。</p>
          </header>

          <form id="working-hours-form" class="needs-validation" novalidate>
            <input type="hidden" name="uuid" id="working-hours-id">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label fw-semibold d-block mb-3">選擇上班星期（可複選）</label>
                <div class="weekday-selector" id="working-weekdays">
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="0" id="working-weekday-0" autocomplete="off">
                    <label class="btn btn-outline-primary" for="working-weekday-0">週一</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="1" id="working-weekday-1" autocomplete="off">
                    <label class="btn btn-outline-primary" for="working-weekday-1">週二</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="2" id="working-weekday-2" autocomplete="off">
                    <label class="btn btn-outline-primary" for="working-weekday-2">週三</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="3" id="working-weekday-3" autocomplete="off">
                    <label class="btn btn-outline-primary" for="working-weekday-3">週四</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="4" id="working-weekday-4" autocomplete="off">
                    <label class="btn btn-outline-primary" for="working-weekday-4">週五</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="5" id="working-weekday-5" autocomplete="off">
                    <label class="btn btn-outline-primary" for="working-weekday-5">週六</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="6" id="working-weekday-6" autocomplete="off">
                    <label class="btn btn-outline-primary" for="working-weekday-6">週日</label>
                  </div>
                </div>
              </div>
              
              <!-- 手機版：每個欄位獨立一行 | 桌面版：三欄並排 -->
              <div class="col-12 col-md-4">
                <label for="working-start-time" class="form-label fw-semibold">開始時間</label>
                <input type="time" class="form-control form-control-lg" id="working-start-time" step="1800" value="09:00" required>
              </div>
              <div class="col-12 col-md-4">
                <label for="working-end-time" class="form-label fw-semibold">結束時間</label>
                <input type="time" class="form-control form-control-lg" id="working-end-time" step="1800" value="17:00" required>
              </div>
              <div class="col-12 col-md-4">
                <label for="working-repeat-weeks" class="form-label fw-semibold">持續週數</label>
                <select class="form-select form-select-lg" id="working-repeat-weeks">
                  <option value="1">1 週（本週）</option>
                  <option value="2">2 週</option>
                  <option value="3">3 週</option>
                  <option value="4">4 週</option>
                  <option value="5">5 週</option>
                  <option value="6">6 週</option>
                  <option value="7">7 週</option>
                  <option value="8">8 週</option>
                </select>
                <div class="form-text">系統會每週排班，最多可一次建立 8 週</div>
              </div>
              
              <div class="col-12">
                <label for="working-note" class="form-label fw-semibold">備註 <span class="text-muted fw-normal">(選填)</span></label>
                <input type="text" class="form-control form-control-lg" id="working-note" placeholder="例如：現場服務">
              </div>
            </div>
            <div class="form-text mt-3">
              <i class="bi bi-info-circle me-1"></i>
              系統會自動從最近的對應星期開始排程
            </div>
            
            <div class="action-buttons mt-4">
              <div id="working-form-errors" class="flex-grow-1"></div>
              <div class="d-flex gap-2 flex-grow-1 flex-sm-grow-0">
                <button type="button" class="btn btn-outline-secondary flex-fill flex-sm-grow-0" id="reset-working-form">
                  <i class="bi bi-x-circle me-1"></i>
                  清除
                </button>
                <button type="submit" class="btn btn-primary flex-fill flex-sm-grow-0" id="submit-working-btn">
                  <i class="bi bi-plus-circle me-1"></i>
                  儲存時段
                </button>
              </div>
            </div>
          </form>

          <hr class="my-4">

          <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-3 mb-3">
            <h3 class="h5 mb-0">已設定的上班時間</h3>
            <span class="badge bg-primary-subtle text-primary border border-primary-subtle fs-6 py-2 px-3" id="working-count-badge">0 段時段</span>
          </div>
          <div id="working-log" class="mb-3 small text-body-secondary"></div>
          
          <div class="table-responsive">
            <table class="table table-hover align-middle collection-table">
              <thead class="table-light">
                <tr>
                  <th scope="col">時間區間</th>
                  <th scope="col" class="d-none d-md-table-cell">星期 / 循環</th>
                  <th scope="col" class="d-none d-lg-table-cell">備註</th>
                  <th scope="col" class="text-end">操作</th>
                </tr>
              </thead>
              <tbody id="working-hours-list">
                <tr>
                  <td colspan="4" class="text-center py-5 text-body-secondary">
                    <i class="bi bi-calendar3 fs-1 d-block mb-2 opacity-50"></i>
                    尚未設定上班時間
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="d-flex flex-column flex-sm-row justify-content-between gap-3 mt-4">
            <button class="btn btn-outline-secondary btn-lg order-2 order-sm-1" data-action="prev" data-target-step="1">
              <i class="bi bi-arrow-left me-2"></i>
              上一步
            </button>
            <button class="btn btn-primary btn-lg order-1 order-sm-2" data-action="next" data-target-step="3" id="step-2-next" disabled>
              下一步：設定休假
              <i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
        </section>

        <!-- 步驟 3：建立休假 -->
        <section class="onboarding-section" data-step="3">
          <header class="mb-4">
            <h2 class="h4 h3-md mb-2">步驟 3：建立休假與不可預約時間</h2>
            <p class="text-body-secondary mb-0">避免客戶在你不在的時段預約，至少新增一段休假。</p>
          </header>

          <form id="time-off-form" class="needs-validation" novalidate>
            <input type="hidden" name="uuid" id="time-off-id">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label fw-semibold d-block mb-3">選擇休假星期（可複選）</label>
                <div class="weekday-selector" id="timeoff-weekdays">
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="0" id="timeoff-weekday-0" autocomplete="off">
                    <label class="btn btn-outline-primary" for="timeoff-weekday-0">週一</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="1" id="timeoff-weekday-1" autocomplete="off">
                    <label class="btn btn-outline-primary" for="timeoff-weekday-1">週二</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="2" id="timeoff-weekday-2" autocomplete="off">
                    <label class="btn btn-outline-primary" for="timeoff-weekday-2">週三</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="3" id="timeoff-weekday-3" autocomplete="off">
                    <label class="btn btn-outline-primary" for="timeoff-weekday-3">週四</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="4" id="timeoff-weekday-4" autocomplete="off">
                    <label class="btn btn-outline-primary" for="timeoff-weekday-4">週五</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="5" id="timeoff-weekday-5" autocomplete="off">
                    <label class="btn btn-outline-primary" for="timeoff-weekday-5">週六</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="6" id="timeoff-weekday-6" autocomplete="off">
                    <label class="btn btn-outline-primary" for="timeoff-weekday-6">週日</label>
                  </div>
                </div>
              </div>
              
              <!-- 手機版：每個欄位獨立一行 | 桌面版：三欄並排 -->
              <div class="col-12 col-md-4">
                <label for="timeoff-start-time" class="form-label fw-semibold">開始時間</label>
                <input type="time" class="form-control form-control-lg" id="timeoff-start-time" step="1800" value="12:00" required>
              </div>
              <div class="col-12 col-md-4">
                <label for="timeoff-end-time" class="form-label fw-semibold">結束時間</label>
                <input type="time" class="form-control form-control-lg" id="timeoff-end-time" step="1800" value="13:00" required>
              </div>
              <div class="col-12 col-md-4">
                <label for="timeoff-repeat-weeks" class="form-label fw-semibold">持續週數</label>
                <select class="form-select form-select-lg" id="timeoff-repeat-weeks">
                  <option value="1">1 週（本週）</option>
                  <option value="2">2 週</option>
                  <option value="3">3 週</option>
                  <option value="4">4 週</option>
                  <option value="5">5 週</option>
                  <option value="6">6 週</option>
                  <option value="7">7 週</option>
                  <option value="8">8 週</option>
                </select>
              </div>
              
              <div class="col-12">
                <label for="timeoff-note" class="form-label fw-semibold">備註 <span class="text-muted fw-normal">(選填)</span></label>
                <input type="text" class="form-control form-control-lg" id="timeoff-note" placeholder="例如：午休、外出、進修">
              </div>
            </div>
            <div class="form-text mt-3">
              <i class="bi bi-info-circle me-1"></i>
              系統會從最近的該星期開始設定休假，並每週套用，最多 8 週
            </div>
            
            <div class="action-buttons mt-4">
              <div id="timeoff-form-errors" class="flex-grow-1"></div>
              <div class="d-flex gap-2 flex-grow-1 flex-sm-grow-0">
                <button type="button" class="btn btn-outline-secondary flex-fill flex-sm-grow-0" id="reset-timeoff-form">
                  <i class="bi bi-x-circle me-1"></i>
                  清除
                </button>
                <button type="submit" class="btn btn-primary flex-fill flex-sm-grow-0" id="submit-timeoff-btn">
                  <i class="bi bi-plus-circle me-1"></i>
                  儲存休假
                </button>
              </div>
            </div>
          </form>

          <hr class="my-4">

          <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-3 mb-3">
            <h3 class="h5 mb-0">已設定的休假/封鎖時段</h3>
            <span class="badge bg-primary-subtle text-primary border border-primary-subtle fs-6 py-2 px-3" id="timeoff-count-badge">0 段休假</span>
          </div>
          <div id="timeoff-log" class="mb-3 small text-body-secondary"></div>
          
          <div class="table-responsive">
            <table class="table table-hover align-middle collection-table">
              <thead class="table-light">
                <tr>
                  <th scope="col">時間區間</th>
                  <th scope="col" class="d-none d-md-table-cell">循環</th>
                  <th scope="col" class="d-none d-lg-table-cell">備註</th>
                  <th scope="col" class="text-end">操作</th>
                </tr>
              </thead>
              <tbody id="timeoff-list">
                <tr>
                  <td colspan="4" class="text-center py-5 text-body-secondary">
                    <i class="bi bi-moon-stars fs-1 d-block mb-2 opacity-50"></i>
                    尚未設定休假
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="d-flex flex-column flex-sm-row justify-content-between gap-3 mt-4">
            <button class="btn btn-outline-secondary btn-lg order-2 order-sm-1" data-action="prev" data-target-step="2">
              <i class="bi bi-arrow-left me-2"></i>
              上一步
            </button>
            <button class="btn btn-success btn-lg order-1 order-sm-2" data-action="next" data-target-step="4" id="step-3-next" disabled>
              完成設定
              <i class="bi bi-check-circle ms-2"></i>
            </button>
          </div>
        </section>

        <!-- 步驟 4：完成 -->
        <section class="onboarding-section" data-step="4">
          <div class="text-center mb-5">
            <div class="success-icon text-success">
              <i class="bi bi-check-circle-fill"></i>
            </div>
            <h2 class="h3 h2-md mb-3">恭喜完成！你的預約頁面準備好了</h2>
            <p class="text-body-secondary mb-0 fs-5 fs-6-sm">以下提供你的專屬預約連結<br class="d-md-none">將網址分享給客戶即可開始接受預約</p>
          </div>

          <div class="card border-2 border-primary bg-primary-subtle mb-4">
            <div class="card-body p-4">
              <h3 class="h6 text-uppercase text-body-secondary mb-3 d-flex align-items-center">
                <i class="bi bi-link-45deg me-2"></i>
                專屬預約連結，放在IG/Threads/Line上分享給你的客戶吧！
              </h3>
              <div class="d-flex flex-column flex-lg-row gap-3 align-items-stretch align-items-lg-center mb-3">
                <code class="text-wrap bg-white border p-3 rounded flex-grow-1 fs-6 user-select-all" id="booking-link-display">
                  {{ appointment_booking_url|default:appointments_booking_path }}
                </code>
                <a
                  href="{{ appointment_booking_url|default:appointments_booking_path }}"
                  class="btn btn-primary btn-lg"
                  target="_blank"
                  rel="noopener"
                >
                  <i class="bi bi-box-arrow-up-right me-2"></i>
                  開啟預約頁面
                </a>
              </div>
              <div class="alert alert-light border mb-0" role="alert">
                <i class="bi bi-lightbulb me-2"></i>
                <strong>提示：</strong>有空時也歡迎前往 
                <a href="{% url 'therapist_panel:treatments' %}" class="alert-link">療程管理</a> 或 
                <a href="{% url 'therapist_panel:appointments' %}" class="alert-link">預約總覽</a> 
                持續更新你的資訊。
              </div>
            </div>
          </div>

          <div class="d-flex flex-column flex-sm-row justify-content-between gap-3">
            <button class="btn btn-outline-secondary btn-lg order-2 order-sm-1" data-action="prev" data-target-step="3">
              <i class="bi bi-arrow-left me-2"></i>
              回上一頁
            </button>
            <a class="btn btn-success btn-lg order-1 order-sm-2" href="{% url 'therapist_panel:index' %}">
              進入治療師主控台
              <i class="bi bi-box-arrow-in-right ms-2"></i>
            </a>
          </div>
        </section>
      </div>
    </div>
  </div>

  {{ onboarding_status|json_script:"onboarding-status" }}
  <script type="application/json" id="onboarding-config">
    {
      "urls": {
        "treatments": "{{ treatments_api_url }}",
        "workingHours": "{{ working_hours_api_url }}",
        "timeOff": "{{ time_off_api_url }}",
        "booking": "{{ appointments_booking_path }}"
      },
      "therapistUuid": "{{ therapist_uuid }}",
      "timezone": "{{ therapist_timezone }}"
    }
  </script>
{% endblock %}

{% block extra_scripts %}
  <script>
    (function () {
      const stepper = document.getElementById("onboarding-stepper");
      const sections = Array.from(document.querySelectorAll(".onboarding-section"));
      const stepIndicators = Array.from(stepper.querySelectorAll(".step-indicator"));
      const onboardingStatus = JSON.parse(document.getElementById("onboarding-status").textContent);
      const config = JSON.parse(document.getElementById("onboarding-config").textContent);
      const therapistTimeZone = config.timezone || "UTC";

      let currentStep = onboardingStatus.is_complete ? 4 : 1;
      const store = {
        treatments: [],
        workingHours: [],
        timeOff: [],
      };

      const csrfRegex = new RegExp("(^|; )csrftoken=([^;]*)");
      function getCsrfToken() {
        const match = document.cookie.match(csrfRegex);
        return match ? decodeURIComponent(match[2]) : "";
      }

      const weekdayLabels = ["週一", "週二", "週三", "週四", "週五", "週六", "週日"];
      const weekdayNameMap = {
        Sun: 6,
        Mon: 0,
        Tue: 1,
        Wed: 2,
        Thu: 3,
        Fri: 4,
        Sat: 5,
      };
      function weekdayLabel(index) {
        if (Number.isInteger(index) && index >= 0 && index < weekdayLabels.length) {
          return weekdayLabels[index];
        }
        return "單次";
      }

      function formatDateInTimeZone(date, timeZone) {
        return new Intl.DateTimeFormat("en-CA", {
          timeZone,
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        }).format(date);
      }

      function addWeeksToDateString(dateStr, weeksMinusOne) {
        if (!dateStr) {
          return null;
        }
        const [year, month, day] = dateStr.split("-").map(Number);
        if ([year, month, day].some((value) => Number.isNaN(value))) {
          return null;
        }
        const date = new Date(Date.UTC(year, month - 1, day));
        date.setUTCDate(date.getUTCDate() + weeksMinusOne * 7);
        const resultYear = date.getUTCFullYear();
        const resultMonth = String(date.getUTCMonth() + 1).padStart(2, "0");
        const resultDay = String(date.getUTCDate()).padStart(2, "0");
        return `${resultYear}-${resultMonth}-${resultDay}`;
      }

      function getNextDateStringForWeekday(weekday, timeZone) {
        const now = new Date();
        const tzNow = new Date(now.toLocaleString("en-US", { timeZone }));
        const currentWeekday = (tzNow.getDay() + 6) % 7;
        const diff = (weekday - currentWeekday + 7) % 7;
        tzNow.setDate(tzNow.getDate() + diff);
        return formatDateInTimeZone(tzNow, timeZone);
      }

      function isoToTime(isoString) {
        if (!isoString) {
          return "";
        }
        const timePart = isoString.split("T")[1] || "";
        return timePart.slice(0, 5);
      }

      function getWeekdayIndexFromISO(isoString, timeZone) {
        if (!isoString) {
          return null;
        }
        const date = new Date(isoString);
        if (Number.isNaN(date.getTime())) {
          return null;
        }
        const weekdayShort = new Intl.DateTimeFormat("en-US", {
          timeZone,
          weekday: "short",
        }).format(date);
        return weekdayNameMap[weekdayShort] ?? null;
      }

      function getSelectedWeekdays(inputs) {
        return inputs
          .filter((input) => input.checked && !input.disabled)
          .map((input) => Number(input.value));
      }

      function setCheckboxSelection(inputs, values, disableOthers = false) {
        const valueSet = new Set(values.map(String));
        inputs.forEach((input) => {
          const isSelected = valueSet.has(input.value);
          input.checked = isSelected;
          input.disabled = disableOthers ? !isSelected : false;
        });
      }

      function resetCheckboxes(inputs) {
        inputs.forEach((input) => {
          input.checked = false;
          input.disabled = false;
        });
      }

      function appendSecondsToTime(timeValue) {
        if (!timeValue) {
          return "";
        }
        return timeValue.length === 5 ? `${timeValue}:00` : timeValue;
      }

      function formatWeeksText(weeks) {
        const safeWeeks = Number.isFinite(Number(weeks)) ? Number(weeks) : 1;
        return `持續${safeWeeks}週`;
      }

      function appendLogEntries(container, entries) {
        if (!container || !entries.length) {
          return;
        }
        const content = entries.map((line) => `<div class="alert alert-success py-2 px-3 mb-2"><i class="bi bi-check-circle me-2"></i>${line}</div>`).join("");
        container.insertAdjacentHTML("beforeend", content);
      }

      function buildWorkingSummary(weekday, startTime, endTime, note, weeks) {
        const label = Number.isInteger(weekday) ? weekdayLabel(weekday) : "單次";
        const noteText = note ? ` (${note})` : "";
        return `${label} 上班時間 ${startTime}~${endTime}${noteText} ${formatWeeksText(weeks)}`;
      }

      function buildTimeoffSummary(weekday, startTime, endTime, note, weeks) {
        const label = Number.isInteger(weekday) ? weekdayLabel(weekday) : "單次";
        const noteText = note ? ` (${note})` : "";
        return `${label} 休假時間 ${startTime}~${endTime}${noteText} ${formatWeeksText(weeks)}`;
      }

      function formatCurrency(value) {
        if (value === null || value === undefined) {
          return "—";
        }
        const num = Number(value);
        if (Number.isNaN(num)) {
          return value;
        }
        return new Intl.NumberFormat(undefined, {
          style: "currency",
          currency: "TWD",
          minimumFractionDigits: 0,
        }).format(num);
      }

      function formatDateTime(isoString) {
        if (!isoString) {
          return "—";
        }
        try {
          const date = new Date(isoString);
          if (Number.isNaN(date.getTime())) {
            return isoString;
          }
          return date.toLocaleString('zh-TW', {
            month: 'numeric',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          });
        } catch (error) {
          return isoString;
        }
      }

      function setStep(step) {
        currentStep = step;
        sections.forEach((section) => {
          section.classList.toggle("active", Number(section.dataset.step) === step);
        });
        stepIndicators.forEach((indicator, index) => {
          const indicatorStep = index + 1;
          indicator.classList.toggle("active", indicatorStep === step);
          indicator.classList.toggle("completed", indicatorStep < step);
        });
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function refreshNextButtonsState() {
        const treatmentsCount = Number(document.getElementById("treatment-count-badge").dataset.count || 0);
        const workingCount = Number(document.getElementById("working-count-badge").dataset.count || 0);
        const timeoffCount = Number(document.getElementById("timeoff-count-badge").dataset.count || 0);

        document.getElementById("step-1-next").disabled = treatmentsCount === 0;
        document.getElementById("step-2-next").disabled = workingCount === 0;
        document.getElementById("step-3-next").disabled = timeoffCount === 0;
      }

      function renderEmptyRow(container, colspan, message) {
        container.innerHTML = `
          <tr>
            <td colspan="${colspan}" class="text-center py-5 text-body-secondary">
              ${message}
            </td>
          </tr>
        `;
      }

      function hydrateCountBadge(elementId, count, emptyLabel) {
        const badge = document.getElementById(elementId);
        badge.dataset.count = count;
        const label = count === 0 ? emptyLabel : `${count} ${emptyLabel.replace("0 ", "")}`;
        badge.textContent = label;
      }

      function showFieldErrors(container, payload) {
        if (!payload || typeof payload !== "object") {
          container.innerHTML = "";
          return;
        }
        const messages = Object.entries(payload)
          .map(([field, errors]) => {
            const text = Array.isArray(errors) ? errors.join(" ") : String(errors);
            const label = field === "non_field_errors" ? "錯誤" : field;
            return `<div class="alert alert-danger mb-2 py-2 px-3" role="alert"><i class="bi bi-exclamation-triangle me-2"></i><strong>${label}:</strong> ${text}</div>`;
          })
          .join("");
        container.innerHTML = messages || "";
      }

      /* Treatments logic */
      const treatmentsList = document.getElementById("treatments-list");
      const treatmentForm = document.getElementById("treatment-form");
      const treatmentErrors = document.getElementById("treatment-form-errors");
      const resetTreatmentBtn = document.getElementById("reset-treatment-form");
      const treatmentFields = {
        id: document.getElementById("treatment-id"),
        name: document.getElementById("treatment-name"),
        duration: document.getElementById("treatment-duration"),
        preparation: document.getElementById("treatment-preparation"),
        price: document.getElementById("treatment-price"),
        notes: document.getElementById("treatment-notes"),
        active: document.getElementById("treatment-active"),
      };

      function resetTreatmentForm() {
        treatmentForm.reset();
        treatmentErrors.innerHTML = "";
        treatmentFields.id.value = "";
        treatmentFields.preparation.value = treatmentFields.preparation.value || 10;
        treatmentFields.active.checked = true;
      }

      async function loadTreatments() {
        renderEmptyRow(treatmentsList, 6, '<div class="spinner-border spinner-border-sm me-2" role="status"></div>載入中...');
        try {
          const response = await fetch(config.urls.treatments, {
            headers: { Accept: "application/json" },
          });
          if (!response.ok) {
          throw new Error("無法載入療程資料");
          }
          const data = await response.json();
          const items = Array.isArray(data) ? data : data.results || [];
          store.treatments = items;
          if (items.length === 0) {
            renderEmptyRow(treatmentsList, 6, '<i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>目前尚未建立療程');
          } else {
            treatmentsList.innerHTML = items
              .map((item) => {
                const badge = item.is_active
                  ? '<span class="badge bg-success"><i class="bi bi-eye me-1"></i>顯示中</span>'
                  : '<span class="badge bg-secondary"><i class="bi bi-eye-slash me-1"></i>已隱藏</span>';
                const timeInfo = `${item.duration_minutes} 分 <span class="d-none d-md-inline">+ ${item.preparation_minutes ?? 0} 分準備</span>`;
                return `
                  <tr data-id="${item.id}">
                    <td class="fw-semibold">${item.name}</td>
                    <td class="d-none d-md-table-cell">${timeInfo}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td class="d-none d-lg-table-cell text-truncate" style="max-width: 200px;">${item.notes || "—"}</td>
                    <td class="text-center">${badge}</td>
                    <td class="text-end">
                      <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" data-action="edit" title="編輯">
                          <i class="bi bi-pencil"></i>
                          <span class="d-none d-lg-inline ms-1">編輯</span>
                        </button>
                        <button class="btn btn-outline-danger" data-action="delete" title="刪除">
                          <i class="bi bi-trash"></i>
                          <span class="d-none d-lg-inline ms-1">刪除</span>
                        </button>
                      </div>
                    </td>
                  </tr>
                `;
              })
              .join("");
          }
          hydrateCountBadge("treatment-count-badge", items.length, "0 個療程");
        } catch (error) {
          renderEmptyRow(treatmentsList, 6, '<i class="bi bi-exclamation-triangle fs-1 d-block mb-2 text-danger opacity-50"></i>載入失敗，請稍候再試');
        } finally {
          refreshNextButtonsState();
        }
      }

      async function submitTreatment(event) {
        event.preventDefault();
        showFieldErrors(treatmentErrors, null);

        const payload = {
          name: treatmentFields.name.value.trim(),
          duration_minutes: Number(treatmentFields.duration.value),
          preparation_minutes: Number(treatmentFields.preparation.value || 0),
          price: treatmentFields.price.value,
          notes: treatmentFields.notes.value.trim(),
          is_active: treatmentFields.active.checked,
        };

        const isEditing = Boolean(treatmentFields.id.value);
        const url = isEditing
          ? `${config.urls.treatments}${payloadIdSegment(treatmentFields.id.value)}/`
          : config.urls.treatments;
        const method = isEditing ? "PATCH" : "POST";

        try {
          const response = await fetch(url, {
            method,
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCsrfToken(),
              Accept: "application/json",
            },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            showFieldErrors(treatmentErrors, errorData);
            return;
          }
          resetTreatmentForm();
          await loadTreatments();
        } catch (error) {
          showFieldErrors(treatmentErrors, { __all__: ["儲存失敗，請稍候再試。"] });
        }
      }

      async function deleteTreatment(id) {
        if (!window.confirm("確定要刪除此療程嗎？刪除後客戶將無法再預約。")) {
          return;
        }
        try {
          const response = await fetch(`${config.urls.treatments}${payloadIdSegment(id)}/`, {
            method: "DELETE",
            headers: {
              "X-CSRFToken": getCsrfToken(),
            },
          });
          if (!response.ok && response.status !== 204) {
            throw new Error("刪除失敗，請稍後再試。");
          }
          if (treatmentFields.id.value === String(id)) {
            resetTreatmentForm();
          }
          await loadTreatments();
        } catch (error) {
          alert("刪除失敗，請稍候再試。");
        }
      }

      treatmentsList.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) {
          return;
        }
        const row = button.closest("tr[data-id]");
        if (!row) {
          return;
        }
        const id = row.dataset.id;
        if (button.dataset.action === "edit") {
          const record = store.treatments.find((item) => String(item.id) === String(id));
          if (!record) {
            return;
          }
          treatmentFields.id.value = record.id;
          treatmentFields.name.value = record.name;
          treatmentFields.duration.value = record.duration_minutes ?? 60;
          treatmentFields.preparation.value = record.preparation_minutes ?? 0;
          treatmentFields.price.value = record.price;
          treatmentFields.notes.value = record.notes || "";
          treatmentFields.active.checked = Boolean(record.is_active);
          treatmentFields.name.focus();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } else if (button.dataset.action === "delete") {
          deleteTreatment(id);
        }
      });

      treatmentForm.addEventListener("submit", submitTreatment);
      resetTreatmentBtn.addEventListener("click", resetTreatmentForm);

      /* Working hours logic */
      const workingList = document.getElementById("working-hours-list");
      const workingLog = document.getElementById("working-log");
      const workingForm = document.getElementById("working-hours-form");
      const workingErrors = document.getElementById("working-form-errors");
      const resetWorkingBtn = document.getElementById("reset-working-form");
      const workingCheckboxes = Array.from(
        document.querySelectorAll("#working-weekdays input[type='checkbox']")
      );

      const workingFields = {
        uuid: document.getElementById("working-hours-id"),
        weekdays: workingCheckboxes,
        startTime: document.getElementById("working-start-time"),
        endTime: document.getElementById("working-end-time"),
        repeatWeeks: document.getElementById("working-repeat-weeks"),
        note: document.getElementById("working-note"),
      };

      function resetWorkingForm() {
        workingForm.reset();
        workingErrors.innerHTML = "";
        workingFields.uuid.value = "";
        resetCheckboxes(workingFields.weekdays);
        workingFields.startTime.value = "09:00";
        workingFields.endTime.value = "17:00";
        workingFields.repeatWeeks.disabled = false;
        workingFields.repeatWeeks.value = "1";
        workingFields.note.value = "";
      }

      async function loadWorkingHours() {
        renderEmptyRow(workingList, 4, '<div class="spinner-border spinner-border-sm me-2" role="status"></div>載入中...');
        try {
          const response = await fetch(config.urls.workingHours, {
            headers: { Accept: "application/json" },
          });
          if (!response.ok) {
          throw new Error("無法載入上班時段資料");
          }
          const data = await response.json();
          const items = Array.isArray(data) ? data : data.results || [];
          store.workingHours = items;
          if (items.length === 0) {
            renderEmptyRow(workingList, 4, '<i class="bi bi-calendar3 fs-1 d-block mb-2 opacity-50"></i>尚未設定上班時間');
          } else {
            workingList.innerHTML = items
              .map((item) => {
                const weekdayIndex =
                  typeof item.weekday === "number"
                    ? item.weekday
                    : getWeekdayIndexFromISO(item.starts_at, therapistTimeZone);
                const weekdayText = weekdayIndex !== null ? weekdayLabel(weekdayIndex) : "單次";
                const repeatBadge = item.series_uuid ? '<span class="badge bg-info-subtle text-info ms-2"><i class="bi bi-arrow-repeat me-1"></i>循環</span>' : '';
                const note = item.note || "—";
                const dateTime = `${formatDateTime(item.starts_at)} ~ ${formatDateTime(item.ends_at)}`;
                return `
                  <tr data-uuid="${item.uuid}" data-series="${item.series_uuid || ""}" data-weekday="${weekdayIndex ?? ""}">
                    <td>
                      <div class="fw-semibold">${dateTime}</div>
                      <small class="text-muted d-md-none">${weekdayText}${repeatBadge}</small>
                    </td>
                    <td class="d-none d-md-table-cell">${weekdayText}${repeatBadge}</td>
                    <td class="d-none d-lg-table-cell text-truncate" style="max-width: 150px;">${note}</td>
                    <td class="text-end">
                      <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" data-action="edit" title="編輯">
                          <i class="bi bi-pencil"></i>
                          <span class="d-none d-lg-inline ms-1">編輯</span>
                        </button>
                        <button class="btn btn-outline-danger" data-action="delete" title="刪除">
                          <i class="bi bi-trash"></i>
                          <span class="d-none d-lg-inline ms-1">刪除</span>
                        </button>
                      </div>
                    </td>
                  </tr>
                `;
              })
              .join("");
          }
          hydrateCountBadge("working-count-badge", items.length, "0 段時段");
        } catch (error) {
          renderEmptyRow(workingList, 4, '<i class="bi bi-exclamation-triangle fs-1 d-block mb-2 text-danger opacity-50"></i>載入失敗，請稍候再試');
        } finally {
          refreshNextButtonsState();
        }
      }

      async function submitWorkingHours(event) {
        event.preventDefault();
        showFieldErrors(workingErrors, null);

        const selectedWeekdays = getSelectedWeekdays(workingFields.weekdays);
        if (!selectedWeekdays.length && !workingFields.uuid.value) {
          showFieldErrors(workingErrors, { weekday: ["請至少選擇一天。"] });
          return;
        }

        const startTime = workingFields.startTime.value;
        const endTime = workingFields.endTime.value;
        if (!startTime || !endTime) {
          showFieldErrors(workingErrors, { starts_at: ["請輸入完整的開始與結束時間。"] });
          return;
        }
        if (startTime >= endTime) {
          showFieldErrors(workingErrors, { ends_at: ["結束時間需晚於開始時間。"] });
          return;
        }

        const repeatWeeks = Number(workingFields.repeatWeeks.value) || 1;
        const note = workingFields.note.value.trim();
        const isEditing = Boolean(workingFields.uuid.value);
        const newLogEntries = [];

        if (isEditing) {
          const record = store.workingHours.find((item) => item.uuid === workingFields.uuid.value);
          if (!record) {
            showFieldErrors(workingErrors, { __all__: ["找不到要編輯的上班時段。"] });
            return;
          }
          const datePart = record.starts_at.slice(0, 10);
          const payload = {
            starts_at: `${datePart}T${appendSecondsToTime(startTime)}`,
            ends_at: `${datePart}T${appendSecondsToTime(endTime)}`,
            note,
          };

          try {
            const response = await fetch(
              `${config.urls.workingHours}${payloadIdSegment(record.uuid)}/`,
              {
                method: "PATCH",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCsrfToken(),
                  Accept: "application/json",
                },
                body: JSON.stringify(payload),
              }
            );
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              showFieldErrors(workingErrors, errorData);
              return;
            }
            const editWeekday =
              typeof record.weekday === "number"
                ? record.weekday
                : getWeekdayIndexFromISO(record.starts_at, therapistTimeZone);
            appendLogEntries(workingLog, [
              buildWorkingSummary(editWeekday, startTime, endTime, note, repeatWeeks),
            ]);
            resetWorkingForm();
            await loadWorkingHours();
          } catch (error) {
            showFieldErrors(workingErrors, { __all__: ["儲存失敗，請稍候再試。"] });
          }
          return;
        }

        try {
          for (const weekday of selectedWeekdays) {
            const dateStr = getNextDateStringForWeekday(weekday, therapistTimeZone);
            const payload = {
              starts_at: `${dateStr}T${appendSecondsToTime(startTime)}`,
              ends_at: `${dateStr}T${appendSecondsToTime(endTime)}`,
              note,
              weekday,
              repeat_interval: 1,
            };
            if (repeatWeeks > 1) {
              const repeatUntil = addWeeksToDateString(dateStr, repeatWeeks - 1);
              if (repeatUntil) {
                payload.repeat_until = repeatUntil;
              }
            }
            const response = await fetch(config.urls.workingHours, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCsrfToken(),
                Accept: "application/json",
              },
              body: JSON.stringify(payload),
            });
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              showFieldErrors(workingErrors, errorData);
              return;
            }
            newLogEntries.push(
              buildWorkingSummary(weekday, startTime, endTime, note, repeatWeeks)
            );
          }
          appendLogEntries(workingLog, newLogEntries);
          resetWorkingForm();
          await loadWorkingHours();
        } catch (error) {
          showFieldErrors(workingErrors, { __all__: ["儲存失敗，請稍候再試。"] });
        }
      }

      async function deleteWorkingHours(uuid, seriesUuid) {
        if (!window.confirm("確定要刪除此上班時段嗎？")) {
          return;
        }
        const deleteSeries =
          Boolean(seriesUuid) &&
          window.confirm("此時段屬於循環班表，要刪除整個循環嗎？按「取消」僅暫停這筆。");
        const scope = deleteSeries ? "?scope=series" : "";
        const endpoint = `${config.urls.workingHours}${payloadIdSegment(uuid)}/`;
        const url = scope ? `${endpoint}${scope}` : endpoint;
        try {
          const response = await fetch(url, {
            method: "DELETE",
            headers: {
              "X-CSRFToken": getCsrfToken(),
            },
          });
          if (!response.ok && response.status !== 204) {
            throw new Error("刪除失敗，請稍後再試。");
          }
          if (workingFields.uuid.value === String(uuid)) {
            resetWorkingForm();
          }
          await loadWorkingHours();
        } catch (error) {
          alert("刪除失敗，請稍候再試。");
        }
      }

      workingList.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) {
          return;
        }
        const row = button.closest("tr[data-uuid]");
        if (!row) {
          return;
        }
        const uuid = row.dataset.uuid;
        if (button.dataset.action === "edit") {
          const record = store.workingHours.find((item) => item.uuid === uuid);
          if (!record) {
            return;
          }
          workingFields.uuid.value = record.uuid;
          const weekdayIndex =
            row.dataset.weekday !== ""
              ? Number(row.dataset.weekday)
              : getWeekdayIndexFromISO(record.starts_at, therapistTimeZone);
          if (weekdayIndex !== null && !Number.isNaN(weekdayIndex)) {
            setCheckboxSelection(workingFields.weekdays, [weekdayIndex], Boolean(record.series_uuid));
          }
          workingFields.startTime.value = isoToTime(record.starts_at) || "09:00";
          workingFields.endTime.value = isoToTime(record.ends_at) || "17:00";
          workingFields.note.value = record.note || "";
          workingFields.repeatWeeks.disabled = Boolean(record.series_uuid);
          workingFields.repeatWeeks.value = record.repeat_interval || "1";
          workingFields.startTime.focus();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } else if (button.dataset.action === "delete") {
          deleteWorkingHours(uuid, row.dataset.series);
        }
      });

      workingForm.addEventListener("submit", submitWorkingHours);
      resetWorkingBtn.addEventListener("click", resetWorkingForm);

      /* Time off logic */
      const timeoffList = document.getElementById("timeoff-list");
      const timeoffLog = document.getElementById("timeoff-log");
      const timeoffForm = document.getElementById("time-off-form");
      const timeoffErrors = document.getElementById("timeoff-form-errors");
      const resetTimeoffBtn = document.getElementById("reset-timeoff-form");
      const timeoffCheckboxes = Array.from(
        document.querySelectorAll("#timeoff-weekdays input[type='checkbox']")
      );

      const timeoffFields = {
        uuid: document.getElementById("time-off-id"),
        weekdays: timeoffCheckboxes,
        startTime: document.getElementById("timeoff-start-time"),
        endTime: document.getElementById("timeoff-end-time"),
        repeatWeeks: document.getElementById("timeoff-repeat-weeks"),
        note: document.getElementById("timeoff-note"),
      };

      function resetTimeoffForm() {
        timeoffForm.reset();
        timeoffErrors.innerHTML = "";
        timeoffFields.uuid.value = "";
        resetCheckboxes(timeoffFields.weekdays);
        timeoffFields.startTime.value = "12:00";
        timeoffFields.endTime.value = "13:00";
        timeoffFields.repeatWeeks.disabled = false;
        timeoffFields.repeatWeeks.value = "1";
        timeoffFields.note.value = "";
      }

      async function loadTimeOff() {
        renderEmptyRow(timeoffList, 4, '<div class="spinner-border spinner-border-sm me-2" role="status"></div>載入中...');
        try {
          const response = await fetch(config.urls.timeOff, {
            headers: { Accept: "application/json" },
          });
          if (!response.ok) {
          throw new Error("無法載入休假資料");
          }
          const data = await response.json();
          const items = Array.isArray(data) ? data : data.results || [];
          store.timeOff = items;
          if (items.length === 0) {
            renderEmptyRow(timeoffList, 4, '<i class="bi bi-moon-stars fs-1 d-block mb-2 opacity-50"></i>尚未設定休假');
          } else {
            timeoffList.innerHTML = items
              .map((item) => {
                const weekdayIndex = getWeekdayIndexFromISO(item.starts_at, therapistTimeZone);
                const weekdayText = weekdayIndex !== null ? weekdayLabel(weekdayIndex) : "單次";
                const repeatBadge = item.series_uuid ? '<span class="badge bg-warning-subtle text-warning ms-2"><i class="bi bi-arrow-repeat me-1"></i>循環</span>' : '';
                const note = item.note || "—";
                const dateTime = `${formatDateTime(item.starts_at)} ~ ${formatDateTime(item.ends_at)}`;
                return `
                  <tr data-uuid="${item.uuid}" data-series="${item.series_uuid || ""}" data-weekday="${weekdayIndex ?? ""}">
                    <td>
                      <div class="fw-semibold">${dateTime}</div>
                      <small class="text-muted d-md-none">${weekdayText}${repeatBadge}</small>
                    </td>
                    <td class="d-none d-md-table-cell">${weekdayText}${repeatBadge}</td>
                    <td class="d-none d-lg-table-cell text-truncate" style="max-width: 150px;">${note}</td>
                    <td class="text-end">
                      <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" data-action="edit" title="編輯">
                          <i class="bi bi-pencil"></i>
                          <span class="d-none d-lg-inline ms-1">編輯</span>
                        </button>
                        <button class="btn btn-outline-danger" data-action="delete" title="刪除">
                          <i class="bi bi-trash"></i>
                          <span class="d-none d-lg-inline ms-1">刪除</span>
                        </button>
                      </div>
                    </td>
                  </tr>
                `;
              })
              .join("");
          }
          hydrateCountBadge("timeoff-count-badge", items.length, "0 段休假");
        } catch (error) {
          renderEmptyRow(timeoffList, 4, '<i class="bi bi-exclamation-triangle fs-1 d-block mb-2 text-danger opacity-50"></i>載入失敗，請稍候再試');
        } finally {
          refreshNextButtonsState();
        }
      }

      async function submitTimeoff(event) {
        event.preventDefault();
        showFieldErrors(timeoffErrors, null);

        const selectedWeekdays = getSelectedWeekdays(timeoffFields.weekdays);
        if (!selectedWeekdays.length && !timeoffFields.uuid.value) {
          showFieldErrors(timeoffErrors, { weekday: ["請至少選擇一天。"] });
          return;
        }

        const startTime = timeoffFields.startTime.value;
        const endTime = timeoffFields.endTime.value;
        if (!startTime || !endTime) {
          showFieldErrors(timeoffErrors, { starts_at: ["請輸入完整的開始與結束時間。"] });
          return;
        }
        if (startTime >= endTime) {
          showFieldErrors(timeoffErrors, { ends_at: ["結束時間需晚於開始時間。"] });
          return;
        }

        const repeatWeeks = Number(timeoffFields.repeatWeeks.value) || 1;
        const note = timeoffFields.note.value.trim();
        const isEditing = Boolean(timeoffFields.uuid.value);
        const logEntries = [];

        if (isEditing) {
          const record = store.timeOff.find((item) => item.uuid === timeoffFields.uuid.value);
          if (!record) {
            showFieldErrors(timeoffErrors, { __all__: ["找不到要編輯的休假時段。"] });
            return;
          }
          const datePart = record.starts_at.slice(0, 10);
          const payload = {
            starts_at: `${datePart}T${appendSecondsToTime(startTime)}`,
            ends_at: `${datePart}T${appendSecondsToTime(endTime)}`,
            note,
          };

          try {
            const response = await fetch(
              `${config.urls.timeOff}${payloadIdSegment(record.uuid)}/`,
              {
                method: "PATCH",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCsrfToken(),
                  Accept: "application/json",
                },
                body: JSON.stringify(payload),
              }
            );
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              showFieldErrors(timeoffErrors, errorData);
              return;
            }
            const editWeekday = getWeekdayIndexFromISO(record.starts_at, therapistTimeZone);
            appendLogEntries(timeoffLog, [
              buildTimeoffSummary(editWeekday, startTime, endTime, note, repeatWeeks),
            ]);
            resetTimeoffForm();
            await loadTimeOff();
          } catch (error) {
            showFieldErrors(timeoffErrors, { __all__: ["儲存失敗，請稍候再試。"] });
          }
          return;
        }

        try {
          for (const weekday of selectedWeekdays) {
            const dateStr = getNextDateStringForWeekday(weekday, therapistTimeZone);
            const payload = {
              starts_at: `${dateStr}T${appendSecondsToTime(startTime)}`,
              ends_at: `${dateStr}T${appendSecondsToTime(endTime)}`,
              note,
            };
            if (repeatWeeks > 1) {
              const repeatUntil = addWeeksToDateString(dateStr, repeatWeeks - 1);
              if (repeatUntil) {
                payload.repeat_type = "weekly";
                payload.repeat_interval = 1;
                payload.repeat_until = repeatUntil;
              }
            }
            const response = await fetch(config.urls.timeOff, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCsrfToken(),
                Accept: "application/json",
              },
              body: JSON.stringify(payload),
            });
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              showFieldErrors(timeoffErrors, errorData);
              return;
            }
            logEntries.push(
              buildTimeoffSummary(weekday, startTime, endTime, note, repeatWeeks)
            );
          }
          appendLogEntries(timeoffLog, logEntries);
          resetTimeoffForm();
          await loadTimeOff();
        } catch (error) {
          showFieldErrors(timeoffErrors, { __all__: ["儲存失敗，請稍候再試。"] });
        }
      }

      async function deleteTimeoff(uuid, seriesUuid) {
        if (!window.confirm("確定要刪除此休假時段嗎？")) {
          return;
        }
        const deleteSeries =
          Boolean(seriesUuid) &&
          window.confirm("此休假屬於循環系列，要刪除整個系列嗎？按「取消」僅將此筆標記為跳過。");
        const scope = deleteSeries ? "?scope=series" : "";
        const endpoint = `${config.urls.timeOff}${payloadIdSegment(uuid)}/`;
        const url = scope ? `${endpoint}${scope}` : endpoint;
        try {
          const response = await fetch(url, {
            method: "DELETE",
            headers: {
              "X-CSRFToken": getCsrfToken(),
            },
          });
          if (!response.ok && response.status !== 204) {
            throw new Error("刪除失敗，請稍後再試。");
          }
          if (timeoffFields.uuid.value === String(uuid)) {
            resetTimeoffForm();
          }
          await loadTimeOff();
        } catch (error) {
          alert("刪除失敗，請稍候再試。");
        }
      }

      timeoffList.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) {
          return;
        }
        const row = button.closest("tr[data-uuid]");
        if (!row) {
          return;
        }
        const uuid = row.dataset.uuid;
        if (button.dataset.action === "edit") {
          const record = store.timeOff.find((item) => item.uuid === uuid);
          if (!record) {
            return;
          }
          timeoffFields.uuid.value = record.uuid;
          const weekdayIndex = getWeekdayIndexFromISO(record.starts_at, therapistTimeZone);
          if (weekdayIndex !== null && !Number.isNaN(weekdayIndex)) {
            setCheckboxSelection(timeoffFields.weekdays, [weekdayIndex], Boolean(record.series_uuid));
          }
          timeoffFields.startTime.value = isoToTime(record.starts_at) || "12:00";
          timeoffFields.endTime.value = isoToTime(record.ends_at) || "13:00";
          timeoffFields.note.value = record.note || "";
          timeoffFields.repeatWeeks.disabled = Boolean(record.series_uuid);
          timeoffFields.repeatWeeks.value = record.repeat_interval || "1";
          timeoffFields.startTime.focus();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } else if (button.dataset.action === "delete") {
          deleteTimeoff(uuid, row.dataset.series);
        }
      });

      timeoffForm.addEventListener("submit", submitTimeoff);
      resetTimeoffBtn.addEventListener("click", resetTimeoffForm);

      function payloadIdSegment(value) {
        return String(value).replace(/\/+$/, "");
      }

      /* Navigation */
      document.body.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) {
          return;
        }
        const action = button.dataset.action;
        if (action !== "next" && action !== "prev") {
          return;
        }
        event.preventDefault();
        const target = Number(button.dataset.targetStep);
        if (!Number.isInteger(target)) {
          return;
        }
        setStep(target);
      });

      async function initialize() {
        setStep(currentStep);
        await Promise.all([loadTreatments(), loadWorkingHours(), loadTimeOff()]);
        refreshNextButtonsState();
      }

      initialize();
    })();
  </script>
{% endblock %}  
