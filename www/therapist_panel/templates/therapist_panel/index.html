{% extends "therapist_panel/base.html" %}

{% block title %}主控台 | 治療師面板{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <style>
    /* 最少量的自定義樣式 */
    .appointment-item.past {
      opacity: 0.6;
    }
  </style>
{% endblock %}

{% block content %}
  {% csrf_token %}
  <!-- 歡迎區域 -->
  <div class="row align-items-center mb-4">
    <div class="col-12 col-lg-8">
      <h1 class="h3 mb-1">嗨 {{ therapist_profile.nickname|default:user.first_name|default:user.get_username }}</h1>
      <p class="text-body-secondary mb-0">歡迎回到治療師工作區</p>
    </div>
    {% if has_client_role %}
      <div class="col-12 col-lg-4">
        <div class="d-flex justify-content-lg-end mt-3 mt-lg-0">
          <form method="post" action="{% url 'accounts:switch_role' 'client' %}" class="w-100">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-secondary w-100">
              <i class="bi bi-arrow-right-circle me-1"></i>
              切換到客戶主控台
            </button>
          </form>
        </div>
      </div>
    {% endif %}
  </div>

  <div class="row g-4">
    <!-- 主要內容區域 -->
    <div class="col-12 col-xl-8">
      <!-- 1. 專屬預約網址 -->
      {% if therapist_profile and appointment_booking_url %}
        <div class="card border-primary shadow-sm mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-link-45deg me-2"></i>專屬預約網址
            </h5>
          </div>
          <div class="card-body">
            <p class="card-text mb-3">分享此連結給客戶，讓他們直接預約您的服務</p>
            <div class="input-group input-group-lg">
              <input
                type="text"
                class="form-control"
                value="{{ appointment_booking_url }}"
                readonly
                id="booking-link-input"
              >
              <button class="btn btn-primary" type="button" data-copy-target="#booking-link-input">
                <i class="bi bi-clipboard"></i>
                <span class="ms-1">複製連結</span>
              </button>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- 2. 今日預約 -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              <i class="bi bi-calendar-day me-2 text-primary"></i>今日預約
            </h5>
            <span class="badge bg-light text-dark fs-6">
              <i class="bi bi-clock me-1"></i>{{ current_time|date:"H:i" }}
            </span>
          </div>
        </div>
        <div class="card-body">
          {% if today_appointments %}
            <div class="list-group list-group-flush">
              {% for appointment in today_appointments %}
                <div class="list-group-item px-0 {% if appointment.end_time <= current_time %}appointment-item past{% endif %}" data-appointment-item="{{ appointment.uuid }}">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-primary me-2">{{ appointment.start_time|date:"H:i" }} — {{ appointment.end_time|date:"H:i" }}</span>
                        {% if appointment.is_cancelled %}
                          <span class="badge bg-secondary">已取消</span>
                        {% elif appointment.end_time <= current_time %}
                          <span class="badge bg-success">已完成</span>
                        {% elif appointment.start_time <= current_time %}
                          <span class="badge bg-warning text-dark">進行中</span>
                        {% else %}
                          <span class="badge bg-info text-white">即將開始</span>
                        {% endif %}
                      </div>
                      <h6 class="mb-1">{{ appointment.customer_name }}</h6>
                      <p class="mb-1 text-muted">
                        <i class="bi bi-heart-pulse me-1"></i>{{ appointment.treatment.name }}
                      </p>
                      <small class="text-muted">
                        <i class="bi bi-telephone me-1"></i>{{ appointment.customer_phone }}
                      </small>
                    </div>
                    <div class="ms-3">
                      {% if not appointment.is_cancelled and appointment.end_time > current_time %}
                        <button
                          class="btn btn-sm btn-outline-danger cancel-appointment-btn"
                          data-appointment-uuid="{{ appointment.uuid }}"
                          data-customer-name="{{ appointment.customer_name }}"
                          title="取消預約">
                          <i class="bi bi-x-circle">取消預約</i>
                        </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-5">
              <i class="bi bi-calendar-x display-1 text-muted"></i>
              <h6 class="mt-3 text-muted">今日沒有預約</h6>
              <p class="text-muted mb-0">享受您的空閒時光！</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- 3. 快速操作 -->
    <div class="col-12 col-xl-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white border-bottom">
          <h5 class="card-title mb-0">
            <i class="bi bi-lightning-charge text-warning me-2"></i>快速操作
          </h5>
        </div>
        <div class="list-group list-group-flush">
          <a href="{% url 'therapist_panel:scheduling:therapist_schedule' %}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
            <i class="bi bi-clock fs-4 me-3 text-success"></i>
            <div>
              <div class="fw-semibold">更新可預約時段</div>
              <small class="text-muted">設定您的工作時間</small>
            </div>
          </a>
          <a href="{% url 'therapist_panel:treatments' %}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
            <i class="bi bi-heart-pulse fs-4 me-3 text-info"></i>
            <div>
              <div class="fw-semibold">編輯療程資訊</div>
              <small class="text-muted">管理服務項目與價格</small>
            </div>
          </a>
          <a href="{% url 'therapist_panel:appointments' %}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
            <i class="bi bi-calendar-check fs-4 me-3 text-primary"></i>
            <div>
              <div class="fw-semibold">查看預約紀錄</div>
              <small class="text-muted">瀏覽所有預約</small>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Toast 容器
      const toastContainer = document.createElement('div');
      toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
      toastContainer.style.zIndex = '1055';
      document.body.appendChild(toastContainer);

      // 顯示 Toast 訊息
      function showToast(message, isSuccess = true) {
        const toastHTML = `
          <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
              <i class="bi ${isSuccess ? 'bi-check-circle text-success' : 'bi-x-circle text-danger'} me-2"></i>
              <strong class="me-auto">${isSuccess ? '成功' : '錯誤'}</strong>
              <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">${message}</div>
          </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        const toastElement = toastContainer.lastElementChild;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();

        // 自動清理 toast 元素
        toastElement.addEventListener('hidden.bs.toast', function() {
          toastElement.remove();
        });
      }

      // 取消預約功能
      document.querySelectorAll('.cancel-appointment-btn').forEach(button => {
        button.addEventListener('click', async function() {
          const appointmentUuid = this.dataset.appointmentUuid;
          const customerName = this.dataset.customerName;

          if (!confirm(`確定要取消 ${customerName} 的預約嗎？`)) {
            return;
          }

          const originalHTML = this.innerHTML;
          this.disabled = true;
          this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

          try {
            const response = await fetch(`/api/appointments/appointments/${appointmentUuid}/cancel/`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken')
              }
            });

            const data = await response.json().catch(() => ({}));

            if (response.ok) {
              showToast(data.detail || '預約已成功取消');
              // 更新 UI
              const appointmentItem = document.querySelector(`[data-appointment-item="${appointmentUuid}"]`);
              if (appointmentItem) {
                // 更新狀態徽章
                const statusBadge = appointmentItem.querySelector('.badge.bg-info, .badge.bg-warning');
                if (statusBadge) {
                  statusBadge.className = 'badge bg-secondary';
                  statusBadge.textContent = '已取消';
                }
                // 移除取消按鈕
                this.remove();
              }
            } else {
              showToast(data.detail || '取消失敗，請稍後再試', false);
              this.disabled = false;
              this.innerHTML = originalHTML;
            }
          } catch (error) {
            console.error('取消預約失敗:', error);
            showToast('網路錯誤，請稍後再試', false);
            this.disabled = false;
            this.innerHTML = originalHTML;
          }
        });
      });

      // 獲取 CSRF token
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      // 複製連結功能
      const copyButton = document.querySelector('[data-copy-target="#booking-link-input"]');
      if (copyButton) {
        copyButton.addEventListener('click', function() {
          const input = document.querySelector('#booking-link-input');
          if (!input) return;

          const text = input.value;
          const originalHTML = copyButton.innerHTML;

          // 顯示載入狀態
          copyButton.disabled = true;
          copyButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>複製中...';

          const resetButton = () => {
            copyButton.disabled = false;
            copyButton.innerHTML = originalHTML;
          };

          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text)
              .then(() => {
                resetButton();
                showToast('預約連結已複製到剪貼簿！');
              })
              .catch(() => {
                // 降級到舊方法
                input.select();
                try {
                  document.execCommand('copy');
                  resetButton();
                  showToast('預約連結已複製到剪貼簿！');
                } catch (err) {
                  resetButton();
                  showToast('複製失敗，請手動複製', false);
                }
              });
          } else {
            // 降級方法
            input.select();
            try {
              document.execCommand('copy');
              resetButton();
              showToast('預約連結已複製到剪貼簿！');
            } catch (err) {
              resetButton();
              showToast('複製失敗，請手動複製', false);
            }
          }
        });
      }
    });
  </script>
{% endblock %}
