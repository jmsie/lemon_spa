{% extends "therapist_panel/base.html" %}

{% block title %}行程排程 | 治療師面板{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <style>
    /* 使用 Bootstrap 的 min-height utilities 和自定義 CSS variables */
    :root {
      --calendar-height-desktop: 720px;
      --calendar-height-mobile: 600px; /* 增加手機版高度以提供更好的視覺體驗 */
    }

    #schedule-calendar {
      min-height: var(--calendar-height-desktop);
    }

    /* 簡化響應式設計 - 更多使用 Bootstrap utilities */
    @media (max-width: 767.98px) {
      #schedule-calendar {
        min-height: var(--calendar-height-mobile);
      }

      /* 手機版優化：日曆使用更多可用空間 */
      .fc .fc-timegrid-slot {
        height: 3em; /* 增加時間槽高度，更易於點擊 */
      }
    }
    
    /* FullCalendar 自定義樣式 - 保持必要的樣式 */
    .fc-event-title { font-weight: 600; }
    .fc-event-time { font-weight: 500; }
    .fc-event-customer { font-size: 0.85rem; }
    .fc-event-phone { font-size: 0.8rem; }
    
    /* 事件狀態樣式 */
    .fc-event.appointment-cancelled,
    .fc-event.appointment-cancelled .fc-event-main {
      opacity: 0.6;
      text-decoration: line-through;
    }
    
    .fc-event.time-off-event,
    .fc-event.time-off-event .fc-event-main {
      background-color: var(--bs-gray-200);
      border-color: var(--bs-blue-200);
      color: var(--bs-gray-800);
    }

    .fc-event.working-hours-event,
    .fc-event.working-hours-event .fc-event-main {
      background-color: var(--bs-success-bg-subtle);
      border-color: var(--bs-success-border-subtle);
      color: var(--bs-success-text);
    }

    .fc-event.working-hours-event {
      opacity: 0.85;
    }
    
    .working-hours-label {
      font-weight: 500;
      font-size: 0.85rem;
    }
    
    .time-off-label {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .calendar-background-event {
      pointer-events: none;
    }

    #calendar-mode-toggle.btn-secondary.active {
      background-color: var(--bs-primary);
      border-color: var(--bs-primary);
    }
  </style>
{% endblock %}

{% block content %}
  <!-- 使用 Bootstrap 的 d-flex 和 justify-content-between -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
      <h1 class="h3 mb-1">本週預約行程</h1>
      <p class="text-body-secondary mb-0 d-none d-sm-block">檢視並管理您的按摩行程與營業時間。</p>
    </div>
    <div class="btn-group flex-wrap">
      <button type="button" class="btn btn-outline-secondary btn-sm" id="calendar-mode-toggle">
        <i class="bi bi-pencil-square me-1"></i><span class="d-none d-sm-inline">開啟</span>編輯<span class="d-none d-sm-inline">模式</span>
      </button>
      <button type="button" class="btn btn-outline-success btn-sm" id="working-hours-create-button">
        <i class="bi bi-clock-history me-1"></i><span class="d-none d-sm-inline">設定</span>上班時間
      </button>
      <button type="button" class="btn btn-outline-primary btn-sm" id="time-off-create-button">
        <i class="bi bi-calendar-minus me-1"></i>新增休假
      </button>
    </div>
  </div>
  
  <div class="card shadow-sm">
    <div class="card-body">
      <!-- 使用 Bootstrap alert component -->
      <div id="schedule-feedback" class="alert d-none" role="alert"></div>
      <div id="schedule-calendar"></div>
    </div>
  </div>

  <!-- 模態框組件 - 簡化重複的結構 -->
  <!-- 編輯預約 Modal -->
  <div class="modal fade" id="appointmentModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5">編輯預約</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="appointment-form" novalidate>
            <div class="mb-3">
              <label for="appointment-treatment" class="form-label">療程</label>
              <select class="form-select" id="appointment-treatment" name="treatment" required></select>
            </div>
            <div class="mb-3">
              <label for="appointment-customer-name" class="form-label">顧客姓名</label>
              <input type="text" class="form-control" id="appointment-customer-name" name="customer_name" required>
            </div>
            <div class="mb-3">
              <label for="appointment-customer-phone" class="form-label">顧客電話</label>
              <input type="tel" class="form-control" id="appointment-customer-phone" name="customer_phone" required>
            </div>
            <div class="mb-3">
              <label for="appointment-note" class="form-label">備註</label>
              <textarea class="form-control" id="appointment-note" name="note" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-outline-danger" id="appointment-cancel">取消預約</button>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="appointment-save">
              <span class="spinner-border spinner-border-sm me-1 d-none"></span>儲存變更
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增預約 Modal -->
  <div class="modal fade" id="appointmentCreateModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5">新增預約</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="appointment-create-form" novalidate>
            <div class="mb-3">
              <label for="create-start-time" class="form-label">開始時間</label>
              <input type="datetime-local" class="form-control" id="create-start-time" name="start_time" required>
            </div>
            <div class="mb-3">
              <label for="create-treatment" class="form-label">療程</label>
              <select class="form-select" id="create-treatment" name="treatment" required></select>
            </div>
            <div class="mb-3">
              <label for="create-customer-name" class="form-label">顧客姓名</label>
              <input type="text" class="form-control" id="create-customer-name" name="customer_name" required>
            </div>
            <div class="mb-3">
              <label for="create-customer-phone" class="form-label">顧客電話</label>
              <input type="tel" class="form-control" id="create-customer-phone" name="customer_phone" required>
            </div>
            <div class="mb-3">
              <label for="create-note" class="form-label">備註</label>
              <textarea class="form-control" id="create-note" name="note" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="appointment-create-save">
            <span class="spinner-border spinner-border-sm me-1 d-none"></span>建立預約
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 上班時間 Modal -->
  <div class="modal fade" id="workingHoursModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="workingHoursModalLabel">新增上班時間</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="working-hours-form" novalidate>
            <input type="hidden" id="working-hours-id" name="uuid">
            <div class="row g-3">
              <div class="col-12" data-working-section="weekdays">
                <label class="form-label d-block mb-2">選擇上班星期（可複選）</label>
                <div class="d-flex flex-wrap gap-2" id="working-weekdays">
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="0" id="working-weekday-0" data-working-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="working-weekday-0">週一</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="1" id="working-weekday-1" data-working-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="working-weekday-1">週二</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="2" id="working-weekday-2" data-working-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="working-weekday-2">週三</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="3" id="working-weekday-3" data-working-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="working-weekday-3">週四</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="4" id="working-weekday-4" data-working-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="working-weekday-4">週五</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="5" id="working-weekday-5" data-working-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="working-weekday-5">週六</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="6" id="working-weekday-6" data-working-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="working-weekday-6">週日</label>
                  </div>
                </div>
              </div>
              <div class="col-md-4" id="working-start-date-display">
                <label for="working-start-date" class="form-label">開始日期</label>
                <input type="date" class="form-control" id="working-start-date" required>
                <div class="form-control-plaintext d-none px-2 py-1 border rounded" ></div>
                <div class="form-text">系統會從此日期所在週開始排程。</div>
              </div>
              <div class="col-md-4">
                <label for="working-start-time" class="form-label">開始時間</label>
                <input type="time" class="form-control" id="working-start-time" step="1800" value="09:00" required>
              </div>
              <div class="col-md-4">
                <label for="working-end-time" class="form-label">結束時間</label>
                <input type="time" class="form-control" id="working-end-time" step="1800" value="17:00" required>
              </div>
              <div class="col-md-12" data-working-section="repeat-weeks">
                <label for="working-repeat-weeks" class="form-label">持續週數</label>
                <select class="form-select" id="working-repeat-weeks">
                  <option value="1">1 週（本週）</option>
                  <option value="2">2 週</option>
                  <option value="3">3 週</option>
                  <option value="4">4 週</option>
                  <option value="5">5 週</option>
                  <option value="6">6 週</option>
                  <option value="7">7 週</option>
                  <option value="8">8 週</option>
                </select>
                <div class="form-text">最多一次建立 8 週。</div>
                <div class="form-text mt-2">系統會依照所選星期，自開始日期當週向後建立時段。</div>
              </div>
              <div class="col-md-12">
                <label for="working-note" class="form-label">備註（選填）</label>
                <input type="text" class="form-control" id="working-note" placeholder="例如：現場服務或線上諮詢">
              </div>
            </div>
            <div class="alert alert-info d-none mt-3 small" data-working-repeat-edit-warning>
              編輯重複上班時段時無法調整重複設定。如需變更，請刪除後重新建立。
            </div>
            <div id="working-form-errors" class="mt-3"></div>
          </form>
        </div>
        <div class="modal-footer justify-content-between">
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary" id="reset-working-form">清除</button>
            <button type="button" class="btn btn-outline-danger d-none" id="working-hours-delete">
              <i class="bi bi-trash"></i> 刪除
            </button>
          </div>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-success" id="working-hours-save">
              <span class="spinner-border spinner-border-sm me-1 d-none"></span>建立上班時間
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 上班時間刪除確認 Modal -->
  <div class="modal fade" id="workingHoursDeleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5">刪除上班時間</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0" id="working-hours-delete-message">確定要刪除此上班時段嗎？</p>
        </div>
        <div class="modal-footer justify-content-end">
          <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-outline-danger" id="working-hours-delete-single">刪除此筆</button>
          <button type="button" class="btn btn-danger d-none" id="working-hours-delete-series">刪除整個序列</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 休假 Modal -->
  <div class="modal fade" id="timeOffModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="timeOffModalLabel">新增休假</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="time-off-form" novalidate>
            <div class="row g-3 mb-3">
              <div class="col-12" data-timeoff-section="weekdays">
                <label class="form-label d-block mb-2">選擇休假星期（可複選）</label>
                <div class="d-flex flex-wrap gap-2" id="time-off-weekdays">
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="0" id="time-off-weekday-0" data-timeoff-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="time-off-weekday-0">週一</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="1" id="time-off-weekday-1" data-timeoff-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="time-off-weekday-1">週二</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="2" id="time-off-weekday-2" data-timeoff-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="time-off-weekday-2">週三</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="3" id="time-off-weekday-3" data-timeoff-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="time-off-weekday-3">週四</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="4" id="time-off-weekday-4" data-timeoff-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="time-off-weekday-4">週五</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="5" id="time-off-weekday-5" data-timeoff-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="time-off-weekday-5">週六</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="btn-check" type="checkbox" value="6" id="time-off-weekday-6" data-timeoff-weekday-checkbox autocomplete="off">
                    <label class="btn btn-outline-secondary" for="time-off-weekday-6">週日</label>
                  </div>
                </div>
              </div>
              <div class="col-md-4" data-timeoff-section="date">
                <label for="time-off-date" class="form-label">日期</label>
                <input type="date" class="form-control" id="time-off-date" required>
              </div>
              <div class="col-md-4">
                <label for="time-off-start-time" class="form-label">開始時間</label>
                <input type="time" class="form-control" id="time-off-start-time" step="1800" required>
              </div>
              <div class="col-md-4">
                <label for="time-off-end-time" class="form-label">結束時間</label>
                <input type="time" class="form-control" id="time-off-end-time" step="1800" required>
              </div>
              <div class="col-md-4" data-timeoff-section="repeat-weeks">
                <label for="time-off-repeat-weeks" class="form-label">持續週數</label>
                <select class="form-select" id="time-off-repeat-weeks">
                  <option value="1">1 週（本週）</option>
                  <option value="2">2 週</option>
                  <option value="3">3 週</option>
                  <option value="4">4 週</option>
                  <option value="5">5 週</option>
                  <option value="6">6 週</option>
                  <option value="7">7 週</option>
                  <option value="8">8 週</option>
                </select>
                <div class="form-text">最多一次建立 8 週。</div>
              </div>
            </div>
            <div class="mb-3">
              <label for="time-off-note" class="form-label">備註</label>
              <textarea class="form-control" id="time-off-note" name="note" rows="3" placeholder="例如：請假、進修..."></textarea>
            </div>
            
            <!-- 重複設定區塊 -->
            <div class="border-top pt-3" id="time-off-repeat-section" hidden>
              <h6 class="mb-3">重複設定</h6>
              <div class="mb-3">
                <select class="form-select" id="time-off-repeat-type" name="repeat_type">
                  <option value="">不重複</option>
                  <option value="daily">每天</option>
                  <option value="weekly">每週</option>
                </select>
              </div>
              <div class="row g-2 mb-3 d-none" data-repeat-settings>
                <div class="col-6">
                  <label for="time-off-repeat-interval" class="form-label">間隔</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="time-off-repeat-interval" name="repeat_interval" min="1" value="1">
                    <span class="input-group-text" data-repeat-interval-label>天</span>
                  </div>
                </div>
                <div class="col-6">
                  <label for="time-off-repeat-until" class="form-label">重複至</label>
                  <input type="date" class="form-control" id="time-off-repeat-until" name="repeat_until">
                </div>
              </div>
              <div class="alert alert-info d-none" data-repeat-edit-warning>
                編輯休假時無法調整重複設定。如需變更，請刪除後重新建立。
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-outline-danger d-none" id="time-off-delete">
            <i class="bi bi-trash"></i> 刪除
          </button>
          <div class="d-flex gap-2 ms-auto">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="time-off-save">
              <span class="spinner-border spinner-border-sm me-1 d-none"></span>建立休假
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 刪除確認 Modal -->
  <div class="modal fade" id="timeOffDeleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5">刪除休假</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0" id="time-off-delete-message">確定要刪除此休假嗎？</p>
        </div>
        <div class="modal-footer justify-content-end">
          <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-outline-danger me-2" id="time-off-delete-single">刪除</button>
          <button type="button" class="btn btn-danger d-none" id="time-off-delete-series">刪除整個序列</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
  <script>
    // 重構後的模組化 JavaScript
    class ScheduleManager {
      constructor() {
        this.calendar = null;
        this.activeEvent = null;
        this.activeTimeOffEvent = null;
        this.activeWorkingHoursEvent = null;
        this.isEditingTimeOff = false;
        this.isEditingWorkingHours = false;
        this.isEditMode = false;
        this.cachedTreatments = null;
        
        // API URLs
        this.appointmentsApiBase = '{{ appointments_api_url }}';
        this.timeOffApiBase = '{{ time_off_api_url }}';
        this.workingHoursApiBase = '{{ working_hours_api_url }}';
        this.treatmentsApiUrl = '{% url "therapist_panel:api:treatments:treatment-list" %}';
        
        // DOM 元素快取
        this.initElements();
        
        // 初始化
        this.init();
      }

      // 初始化 DOM 元素
      initElements() {
        this.elements = {
          calendar: document.getElementById('schedule-calendar'),
          feedback: document.getElementById('schedule-feedback'),
          
          // 模態框
          appointmentModal: new bootstrap.Modal(document.getElementById('appointmentModal')),
          appointmentCreateModal: new bootstrap.Modal(document.getElementById('appointmentCreateModal')),
          workingHoursModal: new bootstrap.Modal(document.getElementById('workingHoursModal')),
          timeOffModal: new bootstrap.Modal(document.getElementById('timeOffModal')),
          timeOffDeleteConfirmModal: new bootstrap.Modal(document.getElementById('timeOffDeleteConfirmModal')),
          
          // 表單
          appointmentForm: document.getElementById('appointment-form'),
          appointmentCreateForm: document.getElementById('appointment-create-form'),
          workingHoursForm: document.getElementById('working-hours-form'),
          timeOffForm: document.getElementById('time-off-form'),
          
          // 按鈕
          appointmentSave: document.getElementById('appointment-save'),
          appointmentCancel: document.getElementById('appointment-cancel'),
          appointmentCreateSave: document.getElementById('appointment-create-save'),
          workingHoursCreateButton: document.getElementById('working-hours-create-button'),
          workingHoursSave: document.getElementById('working-hours-save'),
          workingHoursDelete: document.getElementById('working-hours-delete'),
          workingHoursDeleteConfirmModal: (() => {
            const el = document.getElementById('workingHoursDeleteConfirmModal');
            return el ? new bootstrap.Modal(el) : null;
          })(),
          workingHoursDeleteSingle: document.getElementById('working-hours-delete-single'),
          workingHoursDeleteSeries: document.getElementById('working-hours-delete-series'),
          workingHoursDeleteMessage: document.getElementById('working-hours-delete-message'),
          calendarModeToggle: document.getElementById('calendar-mode-toggle'),
          timeOffCreateButton: document.getElementById('time-off-create-button'),
          timeOffSave: document.getElementById('time-off-save'),
          timeOffDelete: document.getElementById('time-off-delete'),
          timeOffDeleteSingle: document.getElementById('time-off-delete-single'),
          timeOffDeleteSeries: document.getElementById('time-off-delete-series'),
          
          // 其他
          treatmentSelects: {
            edit: document.getElementById('appointment-treatment'),
            create: document.getElementById('create-treatment')
          },
          workingHoursModalTitle: document.getElementById('workingHoursModalLabel'),
          workingHoursRepeatEditWarning: document.querySelector('[data-working-repeat-edit-warning]'),
          workingHoursWeekdayCheckboxes: Array.from(document.querySelectorAll('[data-working-weekday-checkbox]')),
          workingHoursWeekdaySection: document.querySelector('[data-working-section="weekdays"]'),
          workingHoursStartDate: document.getElementById('working-start-date'),
          workingHoursStartDateDisplay: document.getElementById('working-start-date-display'),
          workingHoursStartTime: document.getElementById('working-start-time'),
          workingHoursEndTime: document.getElementById('working-end-time'),
          workingHoursRepeatWeeks: document.getElementById('working-repeat-weeks'),
          workingHoursRepeatWeeksSection: document.querySelector('[data-working-section="repeat-weeks"]'),
          workingHoursNote: document.getElementById('working-note'),
          workingHoursErrors: document.getElementById('working-form-errors'),
          workingHoursResetButton: document.getElementById('reset-working-form'),
          workingHoursIdInput: document.getElementById('working-hours-id'),
          timeOffModalTitle: document.getElementById('timeOffModalLabel'),
          timeOffRepeatSection: document.getElementById('time-off-repeat-section'),
          timeOffWeekdaySection: document.querySelector('[data-timeoff-section="weekdays"]'),
          timeOffWeekdayCheckboxes: Array.from(document.querySelectorAll('[data-timeoff-weekday-checkbox]')),
          timeOffDateSection: document.querySelector('[data-timeoff-section="date"]'),
          timeOffDate: document.getElementById('time-off-date'),
          timeOffStartTime: document.getElementById('time-off-start-time'),
          timeOffEndTime: document.getElementById('time-off-end-time'),
          timeOffRepeatWeeks: document.getElementById('time-off-repeat-weeks'),
          timeOffRepeatWeeksSection: document.querySelector('[data-timeoff-section="repeat-weeks"]'),
          repeatType: document.getElementById('time-off-repeat-type'),
          repeatSettings: document.querySelector('[data-repeat-settings]'),
          repeatIntervalLabel: document.querySelector('[data-repeat-interval-label]'),
          repeatEditWarning: document.querySelector('[data-repeat-edit-warning]')
        };

        if (this.elements.workingHoursRepeatEditWarning && !this.elements.workingHoursRepeatEditWarning.dataset.defaultText) {
          this.elements.workingHoursRepeatEditWarning.dataset.defaultText = this.elements.workingHoursRepeatEditWarning.textContent.trim();
        }

        this.elements.workingHoursWeekdayCheckboxes?.forEach((checkbox) => {
          checkbox.addEventListener('change', () => this.updateWeekdayButtonState(checkbox));
          this.updateWeekdayButtonState(checkbox);
        });
        this.elements.timeOffWeekdayCheckboxes?.forEach((checkbox) => {
          checkbox.addEventListener('change', () => this.updateWeekdayButtonState(checkbox));
          this.updateWeekdayButtonState(checkbox);
        });
        this.elements.timeOffDate?.addEventListener('change', () => this.syncTimeOffWeekdayFromDate());
      }

      // 主要初始化方法
      async init() {
        if (!this.elements.calendar) return;
        
        this.initCalendar();
        this.bindEvents();
        await this.loadTreatments();
        this.updateCalendarModeButton();
      }

      // 工具方法
      getCsrfToken() {
        const name = 'csrftoken=';
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
          const trimmed = cookie.trim();
          if (trimmed.startsWith(name)) {
            return decodeURIComponent(trimmed.substring(name.length));
          }
        }
        return '';
      }

      showFeedback(message, variant = 'success') {
        if (!this.elements.feedback) return;
        
        this.elements.feedback.className = `alert alert-${variant}`;
        this.elements.feedback.textContent = message;
        this.elements.feedback.classList.remove('d-none');
        
        setTimeout(() => {
          this.elements.feedback.classList.add('d-none');
        }, 3000);
      }

      toLocalInputValue(date) {
        if (!date) return '';
        const local = new Date(date);
        local.setMinutes(local.getMinutes() - local.getTimezoneOffset());
        return local.toISOString().slice(0, 16);
      }

      async getErrorMessage(response, fallback) {
        try {
          const data = await response.json();
          if (typeof data === 'string') return data;
          if (data?.detail) return data.detail;
          
          // 檢查第一個錯誤字段
          for (const value of Object.values(data)) {
            if (Array.isArray(value) && value[0]) return value[0];
            if (typeof value === 'string') return value;
          }
        } catch (e) {
          console.debug('Error parsing response:', e);
        }
        return fallback;
      }

      toggleButtonLoading(button, isLoading) {
        if (!button) return;
        
        const spinner = button.querySelector('.spinner-border');
        if (spinner) {
          spinner.classList.toggle('d-none', !isLoading);
        }
        button.disabled = isLoading;
      }

      // API 方法
      async apiRequest(url, options = {}) {
        const defaultOptions = {
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': this.getCsrfToken(),
            'Accept': 'application/json',
            ...options.headers
          }
        };

        return fetch(url, { ...defaultOptions, ...options });
      }

      async loadTreatments() {
        if (this.cachedTreatments) return this.cachedTreatments;
        
        try {
          const response = await this.apiRequest(this.treatmentsApiUrl);
          if (!response.ok) throw new Error('無法載入療程資料');
          
          this.cachedTreatments = await response.json();
          return this.cachedTreatments;
        } catch (error) {
          console.error(error);
          this.showFeedback('無法載入療程清單，請稍後再試。', 'danger');
          return [];
        }
      }

      async populateTreatmentSelect(selectElement) {
        if (!selectElement) return;
        
        const treatments = await this.loadTreatments();
        selectElement.innerHTML = '';
        
        treatments
          .filter(t => t.is_active)
          .forEach(treatment => {
            const option = document.createElement('option');
            option.value = treatment.id;
            option.textContent = `${treatment.name} (${treatment.duration_minutes} 分)`;
            option.dataset.duration = treatment.duration_minutes;
            selectElement.appendChild(option);
          });
      }

      // 日曆初始化
      initCalendar() {
        // 手機版預設使用周曆 (timeGridWeek)，提供更好的視覺體驗
        const getInitialView = () => window.innerWidth < 768 ? 'timeGridWeek' : 'timeGridWeek';

        this.calendar = new FullCalendar.Calendar(this.elements.calendar, {
          initialView: getInitialView(),
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            // 手機版按鈕順序：周曆、日曆、列表，更符合使用習慣
            right: window.innerWidth < 768 ? 'timeGridWeek,timeGridDay,listWeek' : 'timeGridWeek,timeGridDay,listWeek'
          },
          slotMinTime: '08:00:00',
          slotMaxTime: '23:00:00',
          nowIndicator: true,
          locale: 'zh-tw',
          firstDay: 1,
          scrollTime: '09:00:00',
          editable: true,
          eventDurationEditable: false,
          selectable: true,
          height: 'auto',
          
          eventSources: [
            this.createWorkingHoursEventSource(),
            this.createAppointmentEventSource(),
            this.createTimeOffEventSource()
          ],
          
          eventContent: (arg) => this.renderEventContent(arg),
          eventClick: (info) => this.handleEventClick(info),
          eventDrop: (info) => this.handleEventDrop(info),
          select: (selectionInfo) => this.handleSelect(selectionInfo)
        });

        this.calendar.render();
        
        // 響應式更新
        window.addEventListener('resize', () => this.calendar.updateSize());
      }

      createWorkingHoursEventSource() {
        return {
          events: async (info, successCallback, failureCallback) => {
            try {
              const url = new URL(this.workingHoursApiBase, window.location.origin);
              url.searchParams.set('start', info.startStr);
              url.searchParams.set('end', info.endStr);

              const response = await this.apiRequest(url.toString());
              if (!response.ok) throw new Error('無法載入上班時段');

              const data = await response.json();
              const events = data.map(item => {
                const baseClassNames = ['working-hours-event'];
                const eventType = 'workingHours';
                return {
                  id: item.uuid,
                  title: item.note ? `上班：${item.note}` : '上班時間',
                  start: item.starts_at,
                  end: item.ends_at,
                  editable: false,
                  display: this.getEventDisplay(eventType),
                  classNames: this.getEventClassNames(eventType, baseClassNames),
                  backgroundColor: this.getEventBackgroundColor(eventType),
                  borderColor: this.getEventBackgroundColor(eventType),
                  extendedProps: {
                    eventType,
                    note: item.note,
                    seriesUuid: item.series_uuid || null,
                    isRecurring: Boolean(item.series_uuid),
                    isGenerated: Boolean(item.is_generated),
                    weekday: item.weekday,
                    baseClassNames,
                  }
                };
              });

              // 根據營業時間自動調整日曆顯示範圍
              this.updateCalendarTimeRange(data);

              successCallback(events);
              this.applyCalendarMode();
            } catch (error) {
              console.error(error);
              failureCallback(error);
            }
          }
        };
      }

      // 根據營業時間動態調整日曆顯示的時間範圍
      updateCalendarTimeRange(workingHoursData) {
        if (!workingHoursData || workingHoursData.length === 0) {
          // 沒有營業時間，使用預設範圍 08:00-22:00
          this.calendar.setOption('slotMinTime', '08:00:00');
          this.calendar.setOption('slotMaxTime', '22:00:00');
          return;
        }

        let minHour = 24;
        let maxHour = 0;

        // 遍歷所有營業時間，找出最早和最晚的時間
        workingHoursData.forEach(item => {
          const startTime = new Date(item.starts_at);
          const endTime = new Date(item.ends_at);

          const startHour = startTime.getHours() + startTime.getMinutes() / 60;
          const endHour = endTime.getHours() + endTime.getMinutes() / 60;

          minHour = Math.min(minHour, startHour);
          maxHour = Math.max(maxHour, endHour);
        });

        // 向下取整最早時間，向上取整最晚時間，並增加一些緩衝
        const slotMinHour = Math.max(0, Math.floor(minHour) - 1);
        const slotMaxHour = Math.min(24, Math.ceil(maxHour) + 1);

        // 格式化為 HH:00:00 格式
        const slotMinTime = `${String(slotMinHour).padStart(2, '0')}:00:00`;
        const slotMaxTime = `${String(slotMaxHour).padStart(2, '0')}:00:00`;

        // 更新日曆選項
        this.calendar.setOption('slotMinTime', slotMinTime);
        this.calendar.setOption('slotMaxTime', slotMaxTime);
      }

      createAppointmentEventSource() {
        return {
          events: async (info, successCallback, failureCallback) => {
            try {
              const url = new URL(this.appointmentsApiBase, window.location.origin);
              url.searchParams.set('start', info.startStr);
              url.searchParams.set('end', info.endStr);
              
              const response = await this.apiRequest(url.toString());
              if (!response.ok) throw new Error('無法載入預約資料');
              
              const data = await response.json();
              const events = data.map(item => ({
                id: item.uuid,
                title: item.treatment_name || '療程',
                start: item.start_time,
                end: item.end_time,
                extendedProps: {
                  eventType: 'appointment',
                  therapistUuid: item.therapist_uuid,
                  customerName: item.customer_name,
                  customerPhone: item.customer_phone,
                  note: item.note,
                  isCancelled: item.is_cancelled,
                  treatmentId: item.treatment
                },
                classNames: item.is_cancelled ? ['appointment-cancelled'] : []
              }));
              
              successCallback(events);
              this.applyCalendarMode();
            } catch (error) {
              console.error(error);
              failureCallback(error);
            }
          }
        };
      }

      createTimeOffEventSource() {
        return {
          events: async (info, successCallback, failureCallback) => {
            try {
              const url = new URL(this.timeOffApiBase, window.location.origin);
              url.searchParams.set('start', info.startStr);
              url.searchParams.set('end', info.endStr);
              
              const response = await this.apiRequest(url.toString());
              if (!response.ok) throw new Error('無法載入休假資料');
              
              const data = await response.json();
              const events = data.map(item => {
                const baseClassNames = ['time-off-event'];
                const eventType = 'timeOff';
                return {
                  id: item.uuid,
                  title: item.note ? `休假：${item.note}` : '休假',
                  start: item.starts_at,
                  end: item.ends_at,
                  editable: false,
                  display: this.getEventDisplay(eventType),
                  classNames: this.getEventClassNames(eventType, baseClassNames),
                  backgroundColor: this.getEventBackgroundColor(eventType),
                  borderColor: this.getEventBackgroundColor(eventType),
                  extendedProps: {
                    eventType,
                    note: item.note,
                    seriesUuid: item.series_uuid || null,
                    isRecurring: Boolean(item.is_recurring),
                    baseClassNames,
                  }
                };
              });
              
              successCallback(events);
            } catch (error) {
              console.error(error);
              failureCallback(error);
            }
          }
        };
      }

      renderEventContent(arg) {
        if (!this.isEditMode && ['workingHours', 'timeOff'].includes(arg.event.extendedProps.eventType)) {
          return { domNodes: [] };
        }

        if (arg.event.extendedProps.eventType === 'workingHours') {
          const wrapper = document.createElement('div');
          wrapper.classList.add('working-hours-label', 'text-body-secondary');
          const base = arg.timeText ? `${arg.timeText} 上班` : '上班時間';
          wrapper.textContent = arg.event.extendedProps.note ? `${base}｜${arg.event.extendedProps.note}` : base;
          return { domNodes: [wrapper] };
        }

        if (arg.event.extendedProps.eventType === 'timeOff') {
          const wrapper = document.createElement('div');
          wrapper.classList.add('time-off-label');
          wrapper.textContent = arg.event.extendedProps.note ? `休假：${arg.event.extendedProps.note}` : '休假';
          return { domNodes: [wrapper] };
        }

        const container = document.createElement('div');
        const props = arg.event.extendedProps;
        
        // 標題
        const titleEl = document.createElement('div');
        titleEl.classList.add('fc-event-title');
        titleEl.textContent = props.isCancelled ? `${arg.event.title} (已取消)` : arg.event.title;
        container.appendChild(titleEl);

        // 顧客姓名
        if (props.customerName) {
          const customerEl = document.createElement('div');
          customerEl.classList.add('fc-event-customer');
          customerEl.textContent = props.customerName;
          container.appendChild(customerEl);
        }

        // 電話（僅桌面版顯示）
        if (props.customerPhone && window.innerWidth >= 768) {
          const phoneEl = document.createElement('div');
          phoneEl.classList.add('fc-event-phone', 'text-body-secondary');
          phoneEl.textContent = `☎ ${props.customerPhone}`;
          container.appendChild(phoneEl);
        }

        return { domNodes: [container] };
      }

      async handleEventClick(info) {
        info.jsEvent.preventDefault();
        
        if (!this.isEditMode && ['timeOff', 'workingHours'].includes(info.event.extendedProps.eventType)) {
          return;
        }

        if (info.event.extendedProps.eventType === 'timeOff') {
          await this.handleTimeOffEdit(info.event);
        } else if (info.event.extendedProps.eventType === 'workingHours') {
          await this.handleWorkingHoursEdit(info.event);
        } else {
          await this.handleAppointmentEdit(info.event);
        }
      }

      async handleAppointmentEdit(event) {
        this.activeEvent = event;
        const form = this.elements.appointmentForm;
        
        form.reset();
        await this.populateTreatmentSelect(this.elements.treatmentSelects.edit);
        
        // 填充表單
        form.customer_name.value = event.extendedProps.customerName || '';
        form.customer_phone.value = event.extendedProps.customerPhone || '';
        form.note.value = event.extendedProps.note || '';
        
        if (this.elements.treatmentSelects.edit) {
          this.elements.treatmentSelects.edit.value = event.extendedProps.treatmentId || '';
        }
        
        this.elements.appointmentCancel.disabled = Boolean(event.extendedProps.isCancelled);
        this.elements.appointmentModal.show();
      }

      resetWorkingHoursModal() {
        this.isEditingWorkingHours = false;
        this.activeWorkingHoursEvent = null;

        const form = this.elements.workingHoursForm;
        form?.reset?.();
        if (this.elements.workingHoursIdInput) {
          this.elements.workingHoursIdInput.value = '';
        }

        if (this.elements.workingHoursModalTitle) {
          this.elements.workingHoursModalTitle.textContent = '新增上班時間';
        }
        if (this.elements.workingHoursSave) {
          this.elements.workingHoursSave.textContent = '建立上班時間';
        }
        this.elements.workingHoursDelete?.classList.add('d-none');

        this.resetWorkingWeekdayButtons();
        this.elements.workingHoursWeekdaySection?.classList.remove('d-none');

        const today = new Date();
        if (this.elements.workingHoursStartDate) {
          this.elements.workingHoursStartDate.value = this.formatDateValue(today);
          this.elements.workingHoursStartDate.removeAttribute('disabled');
          this.elements.workingHoursStartDate.classList.remove('d-none');
        }
        if (this.elements.workingHoursStartDateDisplay) {
          this.elements.workingHoursStartDateDisplay.textContent = '';
          this.elements.workingHoursStartDateDisplay.classList.add('d-none');
        }
        if (this.elements.workingHoursStartTime) {
          this.elements.workingHoursStartTime.value = '09:00';
          this.elements.workingHoursStartTime.removeAttribute('disabled');
        }
        if (this.elements.workingHoursEndTime) {
          this.elements.workingHoursEndTime.value = '17:00';
          this.elements.workingHoursEndTime.removeAttribute('disabled');
        }
        if (this.elements.workingHoursRepeatWeeks) {
          this.elements.workingHoursRepeatWeeks.value = '1';
          this.elements.workingHoursRepeatWeeks.removeAttribute('disabled');
        }
        this.elements.workingHoursRepeatWeeksSection?.classList.remove('d-none');
        if (this.elements.workingHoursNote) {
          this.elements.workingHoursNote.value = '';
        }

        this.clearWorkingHoursErrors();

        if (this.elements.workingHoursRepeatEditWarning) {
          const warningEl = this.elements.workingHoursRepeatEditWarning;
          if (warningEl.dataset.defaultText) {
            warningEl.textContent = warningEl.dataset.defaultText;
          }
          warningEl.classList.add('d-none');
        }

        this.syncWorkingWeekdayFromDate();
      }

      syncWorkingWeekdayFromDate() {
        if (this.isEditingWorkingHours) return;
        const dateValue = this.elements.workingHoursStartDate?.value;
        if (!dateValue) return;

        const date = this.parseDateValue(dateValue);
        if (!date) return;

        const hasSelection = this.elements.workingHoursWeekdayCheckboxes?.some((checkbox) => checkbox.checked);
        if (hasSelection) return;

        this.setWorkingWeekdaySelection([this.getWeekdayIndex(date)]);
      }

      getWeekdayIndex(date) {
        return (date.getDay() + 6) % 7;
      }

      getSelectedWorkingWeekdays() {
        return this.elements.workingHoursWeekdayCheckboxes
          ?.filter((checkbox) => checkbox.checked && !checkbox.disabled)
          .map((checkbox) => Number(checkbox.value)) ?? [];
      }

      shiftDateToWeekday(baseDate, targetWeekday) {
        const baseWeekday = this.getWeekdayIndex(baseDate);
        let diff = targetWeekday - baseWeekday;
        if (diff < 0) diff += 7;
        const adjusted = new Date(baseDate.getTime());
        adjusted.setDate(adjusted.getDate() + diff);
        return adjusted;
      }

      formatDateValue(date) {
        if (!date) return '';
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      formatTimeValue(date) {
        if (!date) return '';
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      formatDateWithWeekday(date) {
        if (!date) return '';
        return date.toLocaleDateString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          weekday: 'short',
        });
      }

      parseDateValue(value) {
        if (!value) return null;
        const [yearStr, monthStr, dayStr] = value.split('-');
        const year = Number.parseInt(yearStr ?? '', 10);
        const month = Number.parseInt(monthStr ?? '', 10);
        const day = Number.parseInt(dayStr ?? '', 10);
        if ([year, month, day].some((num) => Number.isNaN(num))) {
          return null;
        }
        return new Date(year, month - 1, day, 0, 0, 0, 0);
      }

      combineDateAndTime(date, timeValue) {
        if (!date || !timeValue) return null;
        const [hourStr, minuteStr] = timeValue.split(':');
        const hours = Number.parseInt(hourStr ?? '', 10);
        const minutes = Number.parseInt(minuteStr ?? '', 10);
        if (Number.isNaN(hours) || Number.isNaN(minutes)) {
          return null;
        }
        const result = new Date(date.getTime());
        result.setHours(hours, minutes, 0, 0);
        return result;
      }

      addWeeksToDate(date, weeks) {
        const copy = new Date(date.getTime());
        copy.setDate(copy.getDate() + weeks * 7);
        return copy;
      }

      getTimeRangeDuration(startTime, endTime) {
        const toMinutes = (value) => {
          if (!value) return NaN;
          const [hourStr, minuteStr] = value.split(':');
          const hours = Number.parseInt(hourStr ?? '', 10);
          const minutes = Number.parseInt(minuteStr ?? '', 10);
          if (Number.isNaN(hours) || Number.isNaN(minutes)) {
            return NaN;
          }
          return hours * 60 + minutes;
        };
        const startMinutes = toMinutes(startTime);
        const endMinutes = toMinutes(endTime);
        if (Number.isNaN(startMinutes) || Number.isNaN(endMinutes)) {
          return NaN;
        }
        return (endMinutes - startMinutes) * 60 * 1000;
      }

      resetWorkingWeekdayButtons() {
        this.elements.workingHoursWeekdayCheckboxes?.forEach((checkbox) => {
          checkbox.checked = false;
          checkbox.disabled = false;
          this.updateWeekdayButtonState(checkbox);
        });
      }

      setWorkingWeekdaySelection(values = [], disableAll = false) {
        const valueSet = new Set(values.map(String));
        this.elements.workingHoursWeekdayCheckboxes?.forEach((checkbox) => {
          checkbox.checked = valueSet.has(checkbox.value);
          checkbox.disabled = disableAll;
          this.updateWeekdayButtonState(checkbox);
        });
      }

      resetTimeOffWeekdayButtons() {
        this.elements.timeOffWeekdayCheckboxes?.forEach((checkbox) => {
          checkbox.checked = false;
          checkbox.disabled = false;
          this.updateWeekdayButtonState(checkbox);
        });
      }

      setTimeOffWeekdaySelection(values = [], disableAll = false) {
        const valueSet = new Set(values.map(String));
        this.elements.timeOffWeekdayCheckboxes?.forEach((checkbox) => {
          checkbox.checked = valueSet.has(checkbox.value);
          checkbox.disabled = disableAll;
          this.updateWeekdayButtonState(checkbox);
        });
      }

      getSelectedTimeOffWeekdays() {
        return this.elements.timeOffWeekdayCheckboxes
          ?.filter((checkbox) => checkbox.checked && !checkbox.disabled)
          .map((checkbox) => Number(checkbox.value)) ?? [];
      }

      syncTimeOffWeekdayFromDate() {
        if (this.isEditingTimeOff) return;
        const dateValue = this.elements.timeOffDate?.value;
        if (!dateValue) return;

        const date = this.parseDateValue(dateValue);
        if (!date) return;

        const hasSelection = this.elements.timeOffWeekdayCheckboxes?.some((checkbox) => checkbox.checked);
        if (hasSelection) return;

        this.setTimeOffWeekdaySelection([this.getWeekdayIndex(date)]);
      }

      updateWeekdayButtonState(checkbox) {
        if (!checkbox) return;
        const label = checkbox.nextElementSibling;
        if (!label || !label.classList.contains('btn')) return;
        if (checkbox.checked) {
          label.classList.add('btn-primary');
          label.classList.remove('btn-outline-secondary');
        } else {
          label.classList.remove('btn-primary');
          label.classList.add('btn-outline-secondary');
        }
        label.classList.toggle('disabled', checkbox.disabled);
      }

      showWorkingHoursErrors(payload) {
        const container = this.elements.workingHoursErrors;
        if (!container) return;
        if (!payload) {
          container.innerHTML = '';
          return;
        }

        if (typeof payload === 'string') {
          container.innerHTML = `<div class="alert alert-danger mb-2 py-2 px-3">${payload}</div>`;
          return;
        }

        const entries = Object.entries(payload).map(([field, errors]) => {
          const messages = Array.isArray(errors) ? errors.join(' ') : String(errors);
          const label = field === '__all__' ? '一般' : field;
          return `<div class="alert alert-danger mb-2 py-2 px-3"><strong>${label}</strong> ${messages}</div>`;
        });
        container.innerHTML = entries.join('');
      }

      clearWorkingHoursErrors() {
        this.showWorkingHoursErrors(null);
      }

      showWorkingHoursModal() {
        this.resetWorkingHoursModal();

        const now = new Date();
        const roundedStart = new Date(now);
        const minutes = roundedStart.getMinutes();
        const remainder = minutes % 30;
        if (remainder !== 0) {
          roundedStart.setMinutes(minutes + (30 - remainder), 0, 0);
        } else {
          roundedStart.setSeconds(0, 0);
        }
        const roundedEnd = new Date(roundedStart.getTime() + 60 * 60 * 1000);

        if (this.elements.workingHoursStartDate) {
          this.elements.workingHoursStartDate.value = this.formatDateValue(roundedStart);
        }
        if (this.elements.workingHoursStartTime) {
          this.elements.workingHoursStartTime.value = this.formatTimeValue(roundedStart);
        }
        if (this.elements.workingHoursEndTime) {
          this.elements.workingHoursEndTime.value = this.formatTimeValue(roundedEnd);
        }

        this.syncWorkingWeekdayFromDate();
        this.elements.workingHoursModal?.show();
      }

      async saveWorkingHours() {
        const button = this.elements.workingHoursSave;
        this.toggleButtonLoading(button, true);
        this.clearWorkingHoursErrors();

        const startDateValue = this.elements.workingHoursStartDate?.value || '';
        const startTimeValue = this.elements.workingHoursStartTime?.value || '';
        const endTimeValue = this.elements.workingHoursEndTime?.value || '';
        const repeatWeeksRaw = Number.parseInt(this.elements.workingHoursRepeatWeeks?.value ?? '1', 10);
        const repeatWeeks = Number.isNaN(repeatWeeksRaw) ? 1 : Math.min(Math.max(repeatWeeksRaw, 1), 8);
        const note = (this.elements.workingHoursNote?.value || '').trim();
        const selectedWeekdays = this.getSelectedWorkingWeekdays();
        const isEditing = this.isEditingWorkingHours && this.activeWorkingHoursEvent;
        const canUpdateTimes = true;

        if (!startTimeValue || !endTimeValue) {
          this.showWorkingHoursErrors({ starts_at: ['請填寫開始與結束時間。'] });
          this.toggleButtonLoading(button, false);
          return;
        }

        const durationMs = this.getTimeRangeDuration(startTimeValue, endTimeValue);
        if (!Number.isFinite(durationMs) || durationMs <= 0) {
          this.showWorkingHoursErrors({ ends_at: ['結束時間需晚於開始時間。'] });
          this.toggleButtonLoading(button, false);
          return;
        }

        if (!isEditing) {
          if (!startDateValue) {
            this.showWorkingHoursErrors({ start_date: ['請選擇開始日期。'] });
            this.toggleButtonLoading(button, false);
            return;
          }
          if (!selectedWeekdays.length) {
            this.showWorkingHoursErrors({ weekday: ['請至少選擇一天。'] });
            this.toggleButtonLoading(button, false);
            return;
          }
        }

        try {
          if (isEditing) {
            await this.updateExistingWorkingHours({
              startDateValue,
              startTimeValue,
              endTimeValue,
              note,
              canUpdateTimes,
            });
            this.elements.workingHoursModal?.hide();
            this.showFeedback('上班時間已更新。', 'info');
          } else {
            const createdCount = await this.createWorkingHoursEntries({
              startDateValue,
              startTimeValue,
              durationMs,
              note,
              repeatWeeks,
              selectedWeekdays,
            });
            this.elements.workingHoursModal?.hide();
            if (createdCount > 1) {
              this.showFeedback(`已建立 ${createdCount} 個重複上班時段。`, 'success');
            } else {
              this.showFeedback('上班時間已建立。', 'success');
            }
          }

          this.activeWorkingHoursEvent = null;
          this.calendar?.refetchEvents();
        } catch (error) {
          if (error?.isValidation) {
            // 已顯示錯誤訊息
          } else {
            console.error(error);
            this.showFeedback(error.message || '發生未知錯誤。', 'danger');
          }
        } finally {
          this.toggleButtonLoading(button, false);
        }
      }

      async updateExistingWorkingHours({ startDateValue, startTimeValue, endTimeValue, note, canUpdateTimes }) {
        if (!this.activeWorkingHoursEvent) return;

        const payload = { note };

        if (canUpdateTimes) {
          let baseDate = this.parseDateValue(startDateValue);
          if (!baseDate && this.activeWorkingHoursEvent.start) {
            baseDate = new Date(this.activeWorkingHoursEvent.start);
          }
          if (!baseDate) {
            this.showWorkingHoursErrors({ start_date: ['請選擇開始日期。'] });
            throw { isValidation: true };
          }

          const startDateTime = this.combineDateAndTime(baseDate, startTimeValue);
          const endDateTime = this.combineDateAndTime(baseDate, endTimeValue);
          if (!startDateTime || !endDateTime) {
            this.showWorkingHoursErrors({ starts_at: ['請輸入有效的時間。'] });
            throw { isValidation: true };
          }
          if (endDateTime <= startDateTime) {
            this.showWorkingHoursErrors({ ends_at: ['結束時間需晚於開始時間。'] });
            throw { isValidation: true };
          }

          payload.starts_at = startDateTime.toISOString();
          payload.ends_at = endDateTime.toISOString();
        }

        const endpoint = `${this.workingHoursApiBase}${this.activeWorkingHoursEvent.id}/`;
        const response = await this.apiRequest(endpoint, {
          method: 'PATCH',
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          const message = await this.getErrorMessage(response, '上班時間更新失敗');
          throw new Error(message);
        }
      }

      async createWorkingHoursEntries({ startDateValue, startTimeValue, durationMs, note, repeatWeeks, selectedWeekdays }) {
        const baseDate = this.parseDateValue(startDateValue);
        if (!baseDate) {
          this.showWorkingHoursErrors({ start_date: ['請輸入有效的日期。'] });
          throw { isValidation: true };
        }

        const requests = [];
        for (const weekday of selectedWeekdays) {
          const firstOccurrence = this.shiftDateToWeekday(baseDate, weekday);
          const startDateTime = this.combineDateAndTime(firstOccurrence, startTimeValue);
          if (!startDateTime) {
            this.showWorkingHoursErrors({ starts_at: ['請輸入有效的時間。'] });
            throw { isValidation: true };
          }
          const endDateTime = new Date(startDateTime.getTime() + durationMs);
          const body = {
            starts_at: startDateTime.toISOString(),
            ends_at: endDateTime.toISOString(),
            note,
            weekday,
            repeat_interval: 1,
          };
          if (repeatWeeks > 1) {
            const repeatUntilDate = this.addWeeksToDate(firstOccurrence, repeatWeeks - 1);
            body.repeat_until = this.formatDateValue(repeatUntilDate);
          }
          requests.push(body);
        }

        let successCount = 0;

        for (const body of requests) {
          const response = await this.apiRequest(this.workingHoursApiBase, {
            method: 'POST',
            body: JSON.stringify(body),
          });

          if (!response.ok) {
            const message = await this.getErrorMessage(response, '上班時間建立失敗');
            if (successCount > 0) {
              throw new Error(`${message}（部分時段已建立）`);
            }
            throw new Error(message);
          }

          successCount += 1;
        }

        return successCount;
      }

      async createTimeOffEntries({ baseDate, startTimeValue, durationMs, note, repeatWeeks, selectedWeekdays }) {
        const requests = [];
        for (const weekday of selectedWeekdays) {
          const firstOccurrenceDate = this.shiftDateToWeekday(baseDate, weekday);
          const startDateTime = this.combineDateAndTime(firstOccurrenceDate, startTimeValue);
          if (!startDateTime) {
            throw new Error('請輸入有效的時間。');
          }
          const endDateTime = new Date(startDateTime.getTime() + durationMs);
          const body = {
            starts_at: startDateTime.toISOString(),
            ends_at: endDateTime.toISOString(),
            note,
          };
          if (repeatWeeks > 1) {
            body.repeat_type = 'weekly';
            body.repeat_interval = 1;
            const repeatUntilDate = this.addWeeksToDate(firstOccurrenceDate, repeatWeeks - 1);
            body.repeat_until = this.formatDateValue(repeatUntilDate);
          }
          requests.push(body);
        }

        let successCount = 0;
        for (const body of requests) {
          const response = await this.apiRequest(this.timeOffApiBase, {
            method: 'POST',
            body: JSON.stringify(body),
          });
          if (!response.ok) {
            const message = await this.getErrorMessage(response, '休假建立失敗');
            if (successCount > 0) {
              throw new Error(`${message}（部分時段已建立）`);
            }
            throw new Error(message);
          }
          successCount += 1;
        }
        return successCount;
      }

      showWorkingHoursDeleteConfirm() {
        if (!this.activeWorkingHoursEvent) return;
        const modal = this.elements.workingHoursDeleteConfirmModal;
        if (!modal) {
          this.deleteWorkingHours();
          return;
        }

        const hasSeries = Boolean(this.activeWorkingHoursEvent.extendedProps?.seriesUuid);
        if (this.elements.workingHoursDeleteMessage) {
          this.elements.workingHoursDeleteMessage.textContent = hasSeries
            ? '這是重複上班時段，請選擇刪除單次或整個序列。'
            : '確定要刪除此上班時段嗎？';
        }
        if (this.elements.workingHoursDeleteSeries) {
          this.elements.workingHoursDeleteSeries.classList.toggle('d-none', !hasSeries);
        }
        if (this.elements.workingHoursDeleteSingle) {
          this.elements.workingHoursDeleteSingle.textContent = hasSeries ? '只刪除此筆' : '刪除';
        }

        modal.show();
      }

      handleWorkingHoursDeleteAction(scope = null) {
        if (!this.activeWorkingHoursEvent) return;
        this.elements.workingHoursDeleteConfirmModal?.hide();
        const hasSeries = Boolean(this.activeWorkingHoursEvent.extendedProps?.seriesUuid);
        const effectiveScope = scope === 'series' && hasSeries ? 'series' : null;
        const trigger =
          effectiveScope === 'series'
            ? this.elements.workingHoursDeleteSeries
            : this.elements.workingHoursDeleteSingle;
        this.deleteWorkingHours(effectiveScope, trigger);
      }

      async deleteWorkingHours(scope = null, triggerButton = null) {
        if (!this.activeWorkingHoursEvent) return;

        const hasSeries = Boolean(this.activeWorkingHoursEvent.extendedProps?.seriesUuid);
        const wantsSeriesDeletion = scope === 'series' && hasSeries;
        const button = triggerButton || this.elements.workingHoursDelete;
        this.toggleButtonLoading(button, true);

        try {
          let endpoint = `${this.workingHoursApiBase}${this.activeWorkingHoursEvent.id}/`;
          if (wantsSeriesDeletion) {
            endpoint += '?scope=series';
          }

          const response = await this.apiRequest(endpoint, { method: 'DELETE' });
          if (!response.ok) {
            const message = await this.getErrorMessage(response, '上班時間刪除失敗');
            throw new Error(message);
          }

          this.elements.workingHoursModal?.hide();
          this.clearWorkingHoursErrors();
          this.showFeedback(wantsSeriesDeletion ? '重複上班時段已刪除。' : '上班時間已刪除。', 'warning');
          this.activeWorkingHoursEvent = null;
          this.calendar?.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message || '刪除失敗，請稍後再試。', 'danger');
        } finally {
          this.toggleButtonLoading(button, false);
        }
      }

      async handleWorkingHoursEdit(event) {
        this.resetWorkingHoursModal();
        this.isEditingWorkingHours = true;
        this.activeWorkingHoursEvent = event;

        const startDate = event.start ? new Date(event.start) : null;
        const endDate = event.end ? new Date(event.end) : null;

        let formattedDate = '';
        if (startDate) {
          if (this.elements.workingHoursStartDate) {
            this.elements.workingHoursStartDate.value = this.formatDateValue(startDate);
          }
          if (this.elements.workingHoursStartTime) {
            this.elements.workingHoursStartTime.value = this.formatTimeValue(startDate);
          }
          formattedDate = this.formatDateWithWeekday(startDate);
          this.elements.workingHoursStartDateDisplay?.classList.add('d-none');
        }
        if (endDate && this.elements.workingHoursEndTime) {
          this.elements.workingHoursEndTime.value = this.formatTimeValue(endDate);
        }
        if (this.elements.workingHoursNote) {
          this.elements.workingHoursNote.value = event.extendedProps.note || '';
        }
        if (this.elements.workingHoursRepeatWeeks) {
          this.elements.workingHoursRepeatWeeks.value = '1';
          this.elements.workingHoursRepeatWeeks.setAttribute('disabled', 'disabled');
        }
        this.elements.workingHoursRepeatWeeksSection?.classList.add('d-none');

        const warningEl = this.elements.workingHoursRepeatEditWarning;
        const hasSeries = Boolean(event.extendedProps.seriesUuid);
        const isGenerated = Boolean(event.extendedProps.isGenerated);
        const eventWeekday = typeof event.extendedProps.weekday === 'number'
          ? event.extendedProps.weekday
          : (startDate ? this.getWeekdayIndex(startDate) : 0);

        if (this.elements.workingHoursModalTitle) {
          this.elements.workingHoursModalTitle.textContent = formattedDate
            ? `編輯上班時間 - ${formattedDate}`
            : '編輯上班時間';
        }
        if (this.elements.workingHoursSave) {
          this.elements.workingHoursSave.textContent = '儲存上班時間';
        }

        this.setWorkingWeekdaySelection([eventWeekday], true);
        this.elements.workingHoursWeekdaySection?.classList.add('d-none');
        this.elements.workingHoursStartDate?.setAttribute('disabled', 'disabled');
        this.elements.workingHoursStartDate?.classList.add('d-none');
        this.elements.workingHoursStartDateDisplay?.classList.add('d-none');
        this.elements.workingHoursStartTime?.removeAttribute('disabled');
        this.elements.workingHoursEndTime?.removeAttribute('disabled');

        if (warningEl) {
          if (hasSeries) {
            const baseText = warningEl.dataset.defaultText || warningEl.textContent;
            warningEl.textContent = isGenerated
              ? `${baseText}（本次調整僅影響這一天）`
              : baseText;
            warningEl.classList.remove('d-none');
          } else if (isGenerated) {
            warningEl.textContent = '此上班時段由系統建立，調整僅會影響這一天。如需更新整個循環，請刪除後重新建立。';
            warningEl.classList.remove('d-none');
          } else {
            warningEl.classList.add('d-none');
          }
        }

        this.elements.workingHoursDelete?.classList.remove('d-none');

        this.elements.workingHoursModal?.show();
      }

      async handleTimeOffEdit(event) {
        this.resetTimeOffModal();
        this.isEditingTimeOff = true;
        this.activeTimeOffEvent = event;
        const form = this.elements.timeOffForm;
        form?.reset?.();

        const startDate = event.start ? new Date(event.start) : null;
        const endDate = event.end ? new Date(event.end) : null;
        if (startDate && this.elements.timeOffDate) {
          this.elements.timeOffDate.value = this.formatDateValue(startDate);
        }
        if (startDate && this.elements.timeOffStartTime) {
          this.elements.timeOffStartTime.value = this.formatTimeValue(startDate);
        }
        if (endDate && this.elements.timeOffEndTime) {
          this.elements.timeOffEndTime.value = this.formatTimeValue(endDate);
        }
        if (form) {
          form.note.value = event.extendedProps.note || '';
        }

        const formattedDate = startDate ? this.formatDateWithWeekday(startDate) : '';
        const eventWeekday = startDate ? this.getWeekdayIndex(startDate) : 0;

        this.elements.timeOffModalTitle.textContent = formattedDate
          ? `編輯休假 - ${formattedDate}`
          : '編輯休假';
        this.elements.timeOffSave.textContent = '儲存休假';
        this.elements.timeOffDelete?.classList.remove('d-none');

        this.elements.timeOffDate?.setAttribute('disabled', 'disabled');
        this.elements.timeOffDate?.classList.add('d-none');
        this.elements.timeOffDateSection?.classList.add('d-none');
        this.setTimeOffWeekdaySelection([eventWeekday], true);
        this.elements.timeOffWeekdaySection?.classList.add('d-none');
        if (this.elements.timeOffRepeatWeeks) {
          this.elements.timeOffRepeatWeeks.value = '1';
          this.elements.timeOffRepeatWeeks.setAttribute('disabled', 'disabled');
        }
        this.elements.timeOffRepeatWeeksSection?.classList.add('d-none');
        this.elements.timeOffRepeatSection?.classList.add('d-none');

        if (this.elements.repeatType) {
          this.elements.repeatType.disabled = true;
        }
        this.elements.repeatSettings?.classList.add('d-none');
        this.elements.repeatEditWarning?.classList.remove('d-none');

        this.elements.timeOffModal.show();
      }

      toggleEditMode() {
        this.isEditMode = !this.isEditMode;
        this.updateCalendarModeButton();
        this.applyCalendarMode();
        if (!this.isEditMode) {
          this.elements.workingHoursModal?.hide();
          this.elements.timeOffModal?.hide();
          this.resetWorkingHoursModal();
          this.resetTimeOffModal();
        }
      }

      updateCalendarModeButton() {
        const button = this.elements.calendarModeToggle;
        if (!button) return;

        if (this.isEditMode) {
          button.classList.remove('btn-outline-secondary');
          button.classList.add('btn-secondary', 'active');
          button.innerHTML = '<i class="bi bi-eye me-1"></i>返回檢視模式';
        } else {
          button.classList.remove('btn-secondary', 'active');
          button.classList.add('btn-outline-secondary');
          button.innerHTML = '<i class="bi bi-pencil-square me-1"></i>開啟編輯模式';
        }
      }

      applyCalendarMode() {
        if (!this.calendar) return;

        this.calendar.batchRendering(() => {
          this.calendar.getEvents().forEach((event) => {
            const eventType = event.extendedProps.eventType;
            if (!['workingHours', 'timeOff'].includes(eventType)) return;

            const baseClassNames = event.extendedProps.baseClassNames || [];
            event.setProp('display', this.getEventDisplay(eventType));
            event.setProp('classNames', this.getEventClassNames(eventType, baseClassNames));
            event.setProp('backgroundColor', this.getEventBackgroundColor(eventType));
            event.setProp('borderColor', this.getEventBackgroundColor(eventType));
          });
        });
      }

      getEventDisplay(eventType) {
        if (!this.isEditMode && ['workingHours', 'timeOff'].includes(eventType)) {
          return 'background';
        }
        return 'auto';
      }

      getEventClassNames(eventType, baseClassNames = []) {
        if (!this.isEditMode && ['workingHours', 'timeOff'].includes(eventType)) {
          return [...baseClassNames, 'calendar-background-event'];
        }
        return baseClassNames;
      }

      getEventBackgroundColor(eventType) {
        if (eventType === 'workingHours') {
          return '#d1e7dd';
        }
        if (eventType === 'timeOff') {
          return '#e2e3e5';
        }
        return '';
      }

      async handleEventDrop(info) {
        if (info.event.extendedProps.eventType === 'timeOff' || info.event.extendedProps.eventType === 'workingHours') {
          info.revert();
          return;
        }
        
        if (info.event.extendedProps.isCancelled) {
          this.showFeedback('已取消的預約無法調整時間。', 'warning');
          info.revert();
          return;
        }

        try {
          const response = await this.apiRequest(
            `${this.appointmentsApiBase}${info.event.id}/`,
            {
              method: 'PATCH',
              body: JSON.stringify({ start_time: info.event.start.toISOString() })
            }
          );

          if (!response.ok) {
            const message = await this.getErrorMessage(response, '時間更新失敗');
            throw new Error(message);
          }
          
          this.showFeedback('預約時間已更新。');
          this.calendar.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message, 'danger');
          info.revert();
        }
      }

      async handleSelect(selectionInfo) {
        await this.populateTreatmentSelect(this.elements.treatmentSelects.create);
        
        if (!this.elements.treatmentSelects.create.options.length) {
          this.showFeedback('目前沒有可用的療程，請先建立療程。', 'warning');
          return;
        }

        this.elements.appointmentCreateForm.reset();
        this.elements.appointmentCreateForm.start_time.value = this.toLocalInputValue(selectionInfo.start);
        
        if (this.elements.treatmentSelects.create.options.length) {
          this.elements.treatmentSelects.create.selectedIndex = 0;
        }
        
        this.elements.appointmentCreateModal.show();
        this.calendar.unselect();
      }

      // 事件綁定
      bindEvents() {
        // 預約相關
        this.elements.appointmentSave?.addEventListener('click', () => this.saveAppointment());
        this.elements.appointmentCancel?.addEventListener('click', () => this.cancelAppointment());
        this.elements.appointmentCreateSave?.addEventListener('click', () => this.createAppointment());

        // 上班時間相關
        this.elements.workingHoursCreateButton?.addEventListener('click', () => this.showWorkingHoursModal());
        this.elements.workingHoursSave?.addEventListener('click', () => this.saveWorkingHours());
        this.elements.workingHoursDelete?.addEventListener('click', () => this.showWorkingHoursDeleteConfirm());
        this.elements.workingHoursDeleteSingle?.addEventListener('click', () => this.handleWorkingHoursDeleteAction());
        this.elements.workingHoursDeleteSeries?.addEventListener('click', () => this.handleWorkingHoursDeleteAction('series'));
        this.elements.workingHoursResetButton?.addEventListener('click', () => this.resetWorkingHoursModal());
        this.elements.workingHoursStartDate?.addEventListener('change', () => this.syncWorkingWeekdayFromDate());
        this.elements.calendarModeToggle?.addEventListener('click', () => this.toggleEditMode());

        // 休假相關
        this.elements.timeOffCreateButton?.addEventListener('click', () => this.showTimeOffModal());
        this.elements.timeOffSave?.addEventListener('click', () => this.saveTimeOff());
        this.elements.timeOffDelete?.addEventListener('click', () => this.showDeleteConfirm());
        this.elements.timeOffDeleteSingle?.addEventListener('click', () => this.deleteTimeOff());
        this.elements.timeOffDeleteSeries?.addEventListener('click', () => this.deleteTimeOff('series'));

        // 重複設定
        this.elements.repeatType?.addEventListener('change', () => this.updateRepeatControls());

        // 模態框重置
        document.getElementById('workingHoursModal')?.addEventListener('hidden.bs.modal', () => this.resetWorkingHoursModal());
        document.getElementById('timeOffModal')?.addEventListener('hidden.bs.modal', () => this.resetTimeOffModal());
      }

      async saveAppointment() {
        if (!this.activeEvent) return;
        
        this.toggleButtonLoading(this.elements.appointmentSave, true);
        
        const form = this.elements.appointmentForm;
        const payload = {
          customer_name: form.customer_name.value.trim(),
          customer_phone: form.customer_phone.value.trim(),
          note: form.note.value.trim()
        };

        if (this.elements.treatmentSelects.edit.value) {
          payload.treatment = Number(this.elements.treatmentSelects.edit.value);
        }

        try {
          const response = await this.apiRequest(
            `${this.appointmentsApiBase}${this.activeEvent.id}/`,
            { method: 'PATCH', body: JSON.stringify(payload) }
          );

          if (!response.ok) {
            const message = await this.getErrorMessage(response, '預約更新失敗');
            throw new Error(message);
          }

          this.elements.appointmentModal.hide();
          this.showFeedback('預約資訊已更新。');
          this.activeEvent = null;
          this.calendar.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message, 'danger');
        } finally {
          this.toggleButtonLoading(this.elements.appointmentSave, false);
        }
      }

      async cancelAppointment() {
        if (!this.activeEvent || this.activeEvent.extendedProps.isCancelled) {
          this.elements.appointmentModal.hide();
          return;
        }

        if (!confirm('確認要取消這筆預約嗎？')) return;

        try {
          const response = await this.apiRequest(
            `${this.appointmentsApiBase}${this.activeEvent.id}/cancel/`,
            { method: 'POST' }
          );

          const payload = await response.json().catch(() => ({}));

          if (!response.ok) {
            const message = payload.detail || '預約取消失敗';
            throw new Error(message);
          }

          this.elements.appointmentModal.hide();
          this.showFeedback(payload.detail || '預約已取消。', 'warning');
          this.activeEvent = null;
          this.calendar.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message || '取消失敗，請稍後再試。', 'danger');
        }
      }

      async createAppointment() {
        this.toggleButtonLoading(this.elements.appointmentCreateSave, true);
        
        const form = this.elements.appointmentCreateForm;
        const treatmentOption = this.elements.treatmentSelects.create.options[this.elements.treatmentSelects.create.selectedIndex];
        
        const payload = {
          start_time: new Date(form.start_time.value).toISOString(),
          treatment: Number(treatmentOption.value),
          customer_name: form.customer_name.value.trim(),
          customer_phone: form.customer_phone.value.trim(),
          note: form.note.value.trim()
        };

        try {
          const response = await this.apiRequest(
            this.appointmentsApiBase,
            { method: 'POST', body: JSON.stringify(payload) }
          );

          if (!response.ok) {
            const message = await this.getErrorMessage(response, '預約建立失敗');
            throw new Error(message);
          }

          this.elements.appointmentCreateModal.hide();
          this.showFeedback('預約已建立。');
          this.calendar.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message, 'danger');
        } finally {
          this.toggleButtonLoading(this.elements.appointmentCreateSave, false);
        }
      }

      showTimeOffModal() {
        this.resetTimeOffModal();
        
        const now = new Date();
        const roundedStart = new Date(now);
        const minutes = roundedStart.getMinutes();
        const remainder = minutes % 30;
        if (remainder !== 0) {
          roundedStart.setMinutes(minutes + (30 - remainder), 0, 0);
        } else {
          roundedStart.setSeconds(0, 0);
        }
        const roundedEnd = new Date(roundedStart.getTime() + 60 * 60 * 1000);

        if (this.elements.timeOffDate) {
          this.elements.timeOffDate.value = this.formatDateValue(roundedStart);
        }
        if (this.elements.timeOffStartTime) {
          this.elements.timeOffStartTime.value = this.formatTimeValue(roundedStart);
        }
        if (this.elements.timeOffEndTime) {
          this.elements.timeOffEndTime.value = this.formatTimeValue(roundedEnd);
        }
        this.syncTimeOffWeekdayFromDate();
        this.elements.timeOffModal.show();
      }

      async saveTimeOff() {
        this.toggleButtonLoading(this.elements.timeOffSave, true);
        
        const form = this.elements.timeOffForm;
        const dateValue = this.elements.timeOffDate?.value || '';
        const startTimeValue = this.elements.timeOffStartTime?.value || '';
        const endTimeValue = this.elements.timeOffEndTime?.value || '';
        const note = form?.note?.value?.trim() ?? '';
        const isEditing = this.isEditingTimeOff && this.activeTimeOffEvent;

        if (!dateValue || !startTimeValue || !endTimeValue) {
          this.showFeedback('請填寫日期與開始/結束時間。', 'warning');
          this.toggleButtonLoading(this.elements.timeOffSave, false);
          return;
        }

        const baseDate = this.parseDateValue(dateValue);
        if (!baseDate) {
          this.showFeedback('請輸入有效的日期。', 'warning');
          this.toggleButtonLoading(this.elements.timeOffSave, false);
          return;
        }

        const startDate = this.combineDateAndTime(baseDate, startTimeValue);
        const endDate = this.combineDateAndTime(baseDate, endTimeValue);
        if (!startDate || !endDate) {
          this.showFeedback('請輸入有效的時間。', 'warning');
          this.toggleButtonLoading(this.elements.timeOffSave, false);
          return;
        }

        if (endDate <= startDate) {
          this.showFeedback('結束時間必須晚於開始時間。', 'warning');
          this.toggleButtonLoading(this.elements.timeOffSave, false);
          return;
        }

        const durationMs = endDate.getTime() - startDate.getTime();
        const repeatWeeksRaw = Number.parseInt(this.elements.timeOffRepeatWeeks?.value ?? '1', 10);
        const repeatWeeks = Number.isNaN(repeatWeeksRaw) ? 1 : Math.min(Math.max(repeatWeeksRaw, 1), 8);
        const selectedWeekdays = this.getSelectedTimeOffWeekdays();

        try {
          if (isEditing) {
            const payload = {
              starts_at: startDate.toISOString(),
              ends_at: endDate.toISOString(),
              note,
            };
            const response = await this.apiRequest(
              `${this.timeOffApiBase}${this.activeTimeOffEvent.id}/`,
              { method: 'PATCH', body: JSON.stringify(payload) }
            );
            if (!response.ok) {
              const message = await this.getErrorMessage(response, '休假更新失敗');
              throw new Error(message);
            }
            this.elements.timeOffModal.hide();
            this.showFeedback('休假已更新。', 'info');
          } else {
            if (!selectedWeekdays.length) {
              this.showFeedback('請至少選擇一天。', 'warning');
              this.toggleButtonLoading(this.elements.timeOffSave, false);
              return;
            }
            const createdCount = await this.createTimeOffEntries({
              baseDate,
              startTimeValue,
              durationMs,
              note,
              repeatWeeks,
              selectedWeekdays,
            });
            this.elements.timeOffModal.hide();
            if (createdCount > 1) {
              this.showFeedback(`已建立 ${createdCount} 段重複休假。`, 'success');
            } else {
              this.showFeedback('休假已建立。', 'success');
            }
          }

          this.activeTimeOffEvent = null;
          this.calendar.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message, 'danger');
        } finally {
          this.toggleButtonLoading(this.elements.timeOffSave, false);
        }
      }

      showDeleteConfirm() {
        if (!this.activeTimeOffEvent) return;
        
        const hasRecurring = Boolean(this.activeTimeOffEvent.extendedProps?.seriesUuid);
        
        if (hasRecurring) {
          this.elements.timeOffDeleteSeries.classList.remove('d-none');
          document.getElementById('time-off-delete-message').textContent = 
            '這筆休假屬於重複序列，請選擇刪除單次或整個序列。';
          this.elements.timeOffDeleteSingle.textContent = '只刪除此筆';
        } else {
          this.elements.timeOffDeleteSeries.classList.add('d-none');
          document.getElementById('time-off-delete-message').textContent = '確定要刪除此休假嗎？';
          this.elements.timeOffDeleteSingle.textContent = '刪除此筆';
        }
        
        this.elements.timeOffDeleteConfirmModal.show();
      }

      async deleteTimeOff(scope = null) {
        if (!this.activeTimeOffEvent) return;
        
        const deletingSeries = scope === 'series';
        const url = deletingSeries 
          ? `${this.timeOffApiBase}${this.activeTimeOffEvent.id}/?scope=series`
          : `${this.timeOffApiBase}${this.activeTimeOffEvent.id}/`;

        try {
          const response = await this.apiRequest(url, { method: 'DELETE' });

          if (!response.ok) {
            const message = await this.getErrorMessage(response, '休假刪除失敗');
            throw new Error(message);
          }

          this.elements.timeOffDeleteConfirmModal.hide();
          this.elements.timeOffModal.hide();
          this.showFeedback(deletingSeries ? '重複休假已刪除。' : '休假已刪除。', 'warning');
          this.activeTimeOffEvent = null;
          this.calendar.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message, 'danger');
        }
      }

      updateRepeatControls() {
        const type = this.elements.repeatType?.value;
        
        if (!type) {
          this.elements.repeatSettings?.classList.add('d-none');
          return;
        }
        
        this.elements.repeatSettings?.classList.remove('d-none');
        
        if (this.elements.repeatIntervalLabel) {
          this.elements.repeatIntervalLabel.textContent = type === 'weekly' ? '週' : '天';
        }
      }

      resetTimeOffModal() {
        this.isEditingTimeOff = false;
        this.activeTimeOffEvent = null;
        this.elements.timeOffForm?.reset?.();
        
        this.elements.timeOffModalTitle.textContent = '新增休假';
        this.elements.timeOffSave.textContent = '建立休假';
        this.elements.timeOffDelete?.classList.add('d-none');

        const now = new Date();
        if (this.elements.timeOffDate) {
          this.elements.timeOffDate.value = this.formatDateValue(now);
          this.elements.timeOffDate.removeAttribute('disabled');
          this.elements.timeOffDate.classList.remove('d-none');
        }
        if (this.elements.timeOffStartTime) {
          this.elements.timeOffStartTime.value = this.formatTimeValue(now);
          this.elements.timeOffStartTime.removeAttribute('disabled');
        }
        if (this.elements.timeOffEndTime) {
          const end = new Date(now.getTime() + 60 * 60 * 1000);
          this.elements.timeOffEndTime.value = this.formatTimeValue(end);
          this.elements.timeOffEndTime.removeAttribute('disabled');
        }
        this.elements.timeOffDateSection?.classList.remove('d-none');
        this.resetTimeOffWeekdayButtons();
        this.elements.timeOffWeekdaySection?.classList.remove('d-none');
        if (this.elements.timeOffRepeatWeeks) {
          this.elements.timeOffRepeatWeeks.value = '1';
          this.elements.timeOffRepeatWeeks.removeAttribute('disabled');
        }
        this.elements.timeOffRepeatWeeksSection?.classList.remove('d-none');
        this.elements.timeOffRepeatSection?.classList.add('d-none');

        if (this.elements.timeOffForm) {
          this.elements.timeOffForm.note.value = '';
        }

        // 重置重複設定
        if (this.elements.repeatType) {
          this.elements.repeatType.disabled = false;
          this.elements.repeatType.value = '';
        }
        if (this.elements.repeatSettings) {
          this.elements.repeatSettings.classList.add('d-none');
        }
        
        this.elements.repeatEditWarning?.classList.add('d-none');
        this.updateRepeatControls();
        this.syncTimeOffWeekdayFromDate();
      }
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      new ScheduleManager();
    });
  </script>
{% endblock %}
