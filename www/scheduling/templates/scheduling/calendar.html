{% extends "therapist_panel/base.html" %}

{% block title %}Schedule | Therapist Panel{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <style>
    #schedule-calendar { 
      min-height: 720px; 
    }
    
    /* FullCalendar 響應式調整 */
    @media (max-width: 767.98px) {
      #schedule-calendar { 
        min-height: 500px; 
      }
      
      .fc-toolbar {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .fc-toolbar-chunk {
        display: flex;
        justify-content: center;
      }
      
      .fc-button-group .fc-button {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
      }
      
      .fc-event-title {
        font-size: 0.8rem;
      }
    }
    
    .fc-event-title { font-weight: 600; }
    .fc-event-time { font-weight: 500; }
    .fc-event-customer { font-size: 0.85rem; }
    .fc-event-phone { font-size: 0.8rem; color: #64748b; }
    .fc-event.appointment-cancelled,
    .fc-event.appointment-cancelled .fc-event-main {
      opacity: 0.6;
      text-decoration: line-through;
    }
    .fc-event.time-off-event,
    .fc-event.time-off-event .fc-event-main {
      background-color: #e2e8f0;
      border-color: #cbd5f5;
      color: #1f2937;
    }
    .fc-event.time-off-event .time-off-label {
      font-weight: 600;
      font-size: 0.9rem;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="row align-items-center mb-4">
    <div class="col-12">
      <h1 class="h3 mb-1">本週預約行程</h1>
      <p class="text-body-secondary mb-0">檢視並管理您的按摩行程與營業時間。</p>
    </div>
  </div>
  
  <div class="card shadow-sm">
    <div class="card-body">
      <div id="schedule-feedback" class="alert d-none" role="alert"></div>
      <div id="schedule-calendar"></div>
    </div>
  </div>

  <div class="d-flex justify-content-end mt-3">
    <button type="button" class="btn btn-outline-primary" id="time-off-create-button">
      <i class="bi bi-calendar-minus me-1"></i>新增休假
    </button>
  </div>

  <!-- 編輯預約 Modal -->
  <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="appointmentModalLabel">編輯預約</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="appointment-form" novalidate>
            <div class="mb-3">
              <label for="appointment-treatment" class="form-label">療程</label>
              <select class="form-select" id="appointment-treatment" name="treatment" required></select>
            </div>
            <div class="mb-3">
              <label for="appointment-customer-name" class="form-label">顧客姓名</label>
              <input type="text" class="form-control" id="appointment-customer-name" name="customer_name" required>
            </div>
            <div class="mb-3">
              <label for="appointment-customer-phone" class="form-label">顧客電話</label>
              <input type="tel" class="form-control" id="appointment-customer-phone" name="customer_phone" required>
            </div>
            <div class="mb-3">
              <label for="appointment-note" class="form-label">備註</label>
              <textarea class="form-control" id="appointment-note" name="note" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer flex-column flex-sm-row">
          <button type="button" class="btn btn-outline-danger w-100 w-sm-auto order-sm-first me-sm-auto mb-2 mb-sm-0" id="appointment-cancel">取消預約</button>
          <div class="d-flex gap-2 w-100 w-sm-auto">
            <button type="button" class="btn btn-secondary flex-fill flex-sm-grow-0" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary flex-fill flex-sm-grow-0" id="appointment-save">儲存變更</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增預約 Modal -->
  <div class="modal fade" id="appointmentCreateModal" tabindex="-1" aria-labelledby="appointmentCreateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="appointmentCreateModalLabel">新增預約</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="appointment-create-form" novalidate>
            <div class="mb-3">
              <label for="create-start-time" class="form-label">開始時間</label>
              <input type="datetime-local" class="form-control" id="create-start-time" name="start_time" required>
            </div>
            <div class="mb-3">
              <label for="create-treatment" class="form-label">療程</label>
              <select class="form-select" id="create-treatment" name="treatment" required></select>
            </div>
            <div class="mb-3">
              <label for="create-customer-name" class="form-label">顧客姓名</label>
              <input type="text" class="form-control" id="create-customer-name" name="customer_name" required>
            </div>
            <div class="mb-3">
              <label for="create-customer-phone" class="form-label">顧客電話</label>
              <input type="tel" class="form-control" id="create-customer-phone" name="customer_phone" required>
            </div>
            <div class="mb-3">
              <label for="create-note" class="form-label">備註</label>
              <textarea class="form-control" id="create-note" name="note" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="appointment-create-save">建立預約</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增休假 Modal -->
  <div class="modal fade" id="timeOffModal" tabindex="-1" aria-labelledby="timeOffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="timeOffModalLabel">新增休假</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="time-off-form" novalidate>
            <div class="mb-3">
              <label for="time-off-start" class="form-label">開始時間</label>
              <input type="datetime-local" class="form-control" id="time-off-start" name="starts_at" step="1800" required>
            </div>
            <div class="mb-3">
              <label for="time-off-end" class="form-label">結束時間</label>
              <input type="datetime-local" class="form-control" id="time-off-end" name="ends_at" step="1800" required>
            </div>
            <div class="mb-3">
              <label for="time-off-note" class="form-label">備註</label>
              <textarea class="form-control" id="time-off-note" name="note" rows="3" placeholder="例如：請假、進修..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger me-auto d-none" id="time-off-delete">
            <i class="bi bi-trash"></i>
            刪除
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="time-off-save">建立休假</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script
    src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"
    crossorigin="anonymous"
  ></script>
  <script>
    (function() {
      const calendarEl = document.getElementById('schedule-calendar');
      if (!calendarEl) {
        return;
      }

      const csrfToken = (function() {
        const name = 'csrftoken=';
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
          const trimmed = cookie.trim();
          if (trimmed.startsWith(name)) {
            return decodeURIComponent(trimmed.substring(name.length));
          }
        }
        return '';
      })();

      const feedbackEl = document.getElementById('schedule-feedback');
      const showFeedback = (message, variant = 'success') => {
        if (!feedbackEl) {
          return;
        }
        feedbackEl.className = `alert alert-${variant}`;
        feedbackEl.textContent = message;
        feedbackEl.classList.remove('d-none');
        setTimeout(() => {
          feedbackEl.classList.add('d-none');
        }, 3000);
      };

      const modalEl = document.getElementById('appointmentModal');
      const modal = modalEl ? new bootstrap.Modal(modalEl) : null;
      const formEl = document.getElementById('appointment-form');
      const saveButton = document.getElementById('appointment-save');
      const cancelButton = document.getElementById('appointment-cancel');
      const editTreatmentSelect = document.getElementById('appointment-treatment');
      const createModalEl = document.getElementById('appointmentCreateModal');
      const createModal = createModalEl ? new bootstrap.Modal(createModalEl) : null;
      const createFormEl = document.getElementById('appointment-create-form');
      const createSaveButton = document.getElementById('appointment-create-save');
      const createTreatmentSelect = document.getElementById('create-treatment');
      const timeOffButton = document.getElementById('time-off-create-button');
      const timeOffModalEl = document.getElementById('timeOffModal');
      const timeOffModal = timeOffModalEl ? new bootstrap.Modal(timeOffModalEl) : null;
      const timeOffFormEl = document.getElementById('time-off-form');
      const timeOffSaveButton = document.getElementById('time-off-save');
      const timeOffDeleteButton = document.getElementById('time-off-delete');
      const timeOffModalTitle = document.getElementById('timeOffModalLabel');

      let activeEvent = null;
      let cachedTreatments = null;
      let activeTimeOffEvent = null;
      let isEditingTimeOff = false;

      const resetTimeOffModalState = () => {
        isEditingTimeOff = false;
        activeTimeOffEvent = null;
        if (timeOffModalTitle) {
          timeOffModalTitle.textContent = '新增休假';
        }
        if (timeOffSaveButton) {
          timeOffSaveButton.textContent = '建立休假';
        }
        if (timeOffDeleteButton) {
          timeOffDeleteButton.classList.add('d-none');
        }
      };

      const appointmentsApiBase = '{{ appointments_api_url }}';
      const appointmentDetailUrl = (uuid) => `${appointmentsApiBase}${uuid}/`;
      const appointmentListUrl = () => appointmentsApiBase;
      const timeOffApiBase = '{{ time_off_api_url }}';

      const toLocalInputValue = (date) => {
        if (!date) {
          return '';
        }
        const local = new Date(date);
        local.setMinutes(local.getMinutes() - local.getTimezoneOffset());
        return local.toISOString().slice(0, 16);
      };

      const mapFriendlyMessage = (message, fallback) => {
        if (!message) {
          return fallback;
        }
        const normalized = message.toLowerCase();
        if (normalized.includes('time off')) {
          return '此時段與休假重疊，請選擇其他時間。';
        }
        return message;
      };

      const getErrorMessage = async (response, fallback) => {
        if (!response || typeof response.json !== 'function') {
          return fallback;
        }
        try {
          const data = await response.json();
          if (!data) {
            return fallback;
          }
          if (typeof data === 'string') {
            return mapFriendlyMessage(data, fallback);
          }
          if (Array.isArray(data) && data.length > 0) {
            return mapFriendlyMessage(typeof data[0] === 'string' ? data[0] : fallback, fallback);
          }
          if (typeof data.detail === 'string') {
            return mapFriendlyMessage(data.detail, fallback);
          }
          for (const value of Object.values(data)) {
            if (Array.isArray(value) && value.length > 0) {
              const candidate = value[0];
              if (typeof candidate === 'string') {
                return mapFriendlyMessage(candidate, fallback);
              }
            }
            if (typeof value === 'string') {
              return mapFriendlyMessage(value, fallback);
            }
          }
        } catch (error) {
          console.debug('Failed to parse error response:', error);
        }
        return mapFriendlyMessage(null, fallback);
      };

      const loadTreatments = async () => {
        if (cachedTreatments) {
          return cachedTreatments;
        }
        try {
          const response = await fetch('{% url "therapist_panel:api:treatments:treatment-list" %}', {
            headers: { 'Accept': 'application/json' },
          });
          if (!response.ok) {
            throw new Error('failed to load treatments');
          }
          const data = await response.json();
          cachedTreatments = data;
          return data;
        } catch (error) {
          console.error(error);
          showFeedback('無法載入療程清單，請稍後再試。', 'danger');
          return [];
        }
      };

      const populateTreatmentSelect = async (selectElement) => {
        if (!selectElement) {
          return;
        }
        const treatments = await loadTreatments();
        selectElement.innerHTML = '';
        for (const treatment of treatments) {
          if (!treatment.is_active) {
            continue;
          }
          const option = document.createElement('option');
          option.value = treatment.id;
          option.textContent = `${treatment.name} (${treatment.duration_minutes} 分)`;
          option.dataset.duration = treatment.duration_minutes;
          option.dataset.preparation = treatment.preparation_minutes;
          selectElement.appendChild(option);
        }
      };

      // 檢測螢幕大小來調整行事曆視圖
      const getInitialView = () => {
        if (window.innerWidth < 768) {
          return 'listWeek';
        }
        return 'timeGridWeek';
      };

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: getInitialView(),
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: window.innerWidth < 768 ? 'listWeek,timeGridDay' : 'timeGridWeek,timeGridDay,listWeek'
        },
        slotMinTime: '08:00:00',
        slotMaxTime: '23:00:00',
        nowIndicator: true,
        locale: 'zh-tw',
        firstDay: 1,
        scrollTime: '09:00:00',
        editable: true,
        eventDurationEditable: false,
        selectable: true,
        height: 'auto',
        eventSources: [
          {
            events: async function(info, successCallback, failureCallback) {
              const url = new URL('{{ appointments_api_url }}', window.location.origin);
              url.searchParams.set('start', info.startStr);
              url.searchParams.set('end', info.endStr);
              try {
                const response = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
                if (!response.ok) {
                  throw new Error('Failed to load appointments');
                }
                const data = await response.json();
                const events = data.map((item) => ({
                  id: item.uuid,
                  title: item.treatment_name || '療程',
                  start: item.start_time,
                  end: item.end_time,
                  extendedProps: {
                    therapistUuid: item.therapist_uuid,
                    customerName: item.customer_name,
                    customerPhone: item.customer_phone,
                    note: item.note,
                    isCancelled: item.is_cancelled,
                    treatmentId: item.treatment,
                    eventType: 'appointment',
                  },
                  classNames: item.is_cancelled ? ['appointment-cancelled'] : [],
                }));
                successCallback(events);
              } catch (error) {
                console.error(error);
                failureCallback(error);
              }
            },
          },
          {
            events: async function(info, successCallback, failureCallback) {
              const url = new URL(timeOffApiBase, window.location.origin);
              url.searchParams.set('start', info.startStr);
              url.searchParams.set('end', info.endStr);
              try {
                const response = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
                if (!response.ok) {
                  throw new Error('Failed to load time off');
                }
                const data = await response.json();
                const events = data.map((item) => ({
                  id: item.uuid,
                  title: item.note ? `休假：${item.note}` : '休假',
                  start: item.starts_at,
                  end: item.ends_at,
                  editable: false,
                  classNames: ['time-off-event'],
                  extendedProps: {
                    eventType: 'timeOff',
                    note: item.note,
                  },
                }));
                successCallback(events);
              } catch (error) {
                console.error(error);
                failureCallback(error);
              }
            },
          },
        ],
        eventContent: function(arg) {
          if (arg.event.extendedProps.eventType === 'timeOff') {
            const wrapper = document.createElement('div');
            wrapper.classList.add('time-off-label');
            wrapper.textContent = arg.event.extendedProps.note
              ? `休假：${arg.event.extendedProps.note}`
              : '休假';
            return { domNodes: [wrapper] };
          }
          const container = document.createElement('div');

          const titleEl = document.createElement('div');
          titleEl.classList.add('fc-event-title');
          const baseTitle = arg.event.title;
          const isCancelled = Boolean(arg.event.extendedProps.isCancelled);
          titleEl.textContent = isCancelled ? `${baseTitle} (已取消)` : baseTitle;
          container.appendChild(titleEl);

          const customerName = arg.event.extendedProps.customerName;
          if (customerName) {
            const customerEl = document.createElement('div');
            customerEl.classList.add('fc-event-customer');
            customerEl.textContent = customerName;
            container.appendChild(customerEl);
          }

          const phone = arg.event.extendedProps.customerPhone;
          if (phone && window.innerWidth >= 768) { // 只在較大螢幕顯示電話
            const phoneEl = document.createElement('div');
            phoneEl.classList.add('fc-event-phone');
            phoneEl.textContent = `☎ ${phone}`;
            container.appendChild(phoneEl);
          }

          return { domNodes: [container] };
        },
        eventClick: async function(info) {
          info.jsEvent.preventDefault();
          if (info.event.extendedProps.eventType === 'timeOff') {
            if (!timeOffModal || !timeOffFormEl) {
              return;
            }
            isEditingTimeOff = true;
            activeTimeOffEvent = info.event;
            timeOffFormEl.reset();
            const startField = timeOffFormEl.querySelector('[name="starts_at"]');
            const endField = timeOffFormEl.querySelector('[name="ends_at"]');
            const noteField = timeOffFormEl.querySelector('[name="note"]');
            if (startField && info.event.start) {
              startField.value = toLocalInputValue(info.event.start);
            }
            if (endField && info.event.end) {
              endField.value = toLocalInputValue(info.event.end);
            }
            if (noteField) {
              noteField.value = info.event.extendedProps.note || '';
            }
            if (timeOffModalTitle) {
              timeOffModalTitle.textContent = '編輯休假';
            }
            if (timeOffSaveButton) {
              timeOffSaveButton.textContent = '儲存休假';
            }
            if (timeOffDeleteButton) {
              timeOffDeleteButton.classList.remove('d-none');
            }
            timeOffModal.show();
            return;
          }
          activeEvent = info.event;
          if (!formEl || !modal) {
            return;
          }
          formEl.reset();
          await populateTreatmentSelect(editTreatmentSelect);
          if (editTreatmentSelect) {
            editTreatmentSelect.value = activeEvent.extendedProps.treatmentId || '';
          }
          formEl.querySelector('[name="customer_name"]').value = activeEvent.extendedProps.customerName || '';
          formEl.querySelector('[name="customer_phone"]').value = activeEvent.extendedProps.customerPhone || '';
          formEl.querySelector('[name="note"]').value = activeEvent.extendedProps.note || '';
          if (cancelButton) {
            cancelButton.disabled = Boolean(activeEvent.extendedProps.isCancelled);
          }
          modal.show();
        },
        eventDrop: async function(info) {
          if (info.event.extendedProps.eventType === 'timeOff') {
            info.revert();
            return;
          }
          if (!info.event.start) {
            return;
          }
          if (info.event.extendedProps.isCancelled) {
            showFeedback('已取消的預約無法調整時間。', 'warning');
            info.revert();
            return;
          }
          try {
            const response = await fetch(appointmentDetailUrl(info.event.id), {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'Accept': 'application/json',
              },
              body: JSON.stringify({ start_time: info.event.start.toISOString() }),
            });

            if (!response.ok) {
              const message = await getErrorMessage(response, '時間更新失敗，請稍後再試。');
              throw new Error(message);
            }
            showFeedback('預約時間已更新。');
            calendar.refetchEvents();
          } catch (error) {
            console.error(error);
            showFeedback(error instanceof Error ? error.message : '更新失敗，請稍後再試。', 'danger');
            info.revert();
          }
        },
        select: async function(selectionInfo) {
          if (!createModal || !createFormEl || !createTreatmentSelect) {
            return;
          }

          await populateTreatmentSelect(createTreatmentSelect);
          if (!createTreatmentSelect.options.length) {
            showFeedback('目前沒有可用的療程，請先建立療程。', 'warning');
            return;
          }

          createFormEl.reset();
          const startLocal = toLocalInputValue(selectionInfo.start);
          createFormEl.querySelector('[name="start_time"]').value = startLocal;
          if (createTreatmentSelect && createTreatmentSelect.options.length) {
            createTreatmentSelect.selectedIndex = 0;
          }
          createModal.show();
          calendar.unselect();
        },
      });

      calendar.render();

      // 視窗大小改變時重新渲染
      window.addEventListener('resize', function() {
        calendar.updateSize();
      });

      if (saveButton && formEl && modal) {
        saveButton.addEventListener('click', async () => {
          if (!activeEvent) {
            return;
          }

          const payload = {
            customer_name: formEl.querySelector('[name="customer_name"]').value.trim(),
            customer_phone: formEl.querySelector('[name="customer_phone"]').value.trim(),
            note: formEl.querySelector('[name="note"]').value.trim(),
          };

          if (editTreatmentSelect && editTreatmentSelect.value) {
            payload.treatment = Number(editTreatmentSelect.value);
          }

          try {
            const response = await fetch(appointmentDetailUrl(activeEvent.id), {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'Accept': 'application/json',
              },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              const message = await getErrorMessage(response, '預約更新失敗');
              throw new Error(message);
            }

            modal.hide();
            showFeedback('預約資訊已更新。');
            activeEvent = null;
            calendar.refetchEvents();
          } catch (error) {
            console.error(error);
            showFeedback(error instanceof Error ? error.message : '更新失敗，請確認資料後再試。', 'danger');
          }
        });
      }

      if (cancelButton && modal) {
        cancelButton.addEventListener('click', async () => {
          if (!activeEvent) {
            return;
          }

          if (activeEvent.extendedProps.isCancelled) {
            modal.hide();
            return;
          }

          if (!window.confirm('確認要取消這筆預約嗎？')) {
            return;
          }

          try {
            const response = await fetch(appointmentDetailUrl(activeEvent.id), {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'Accept': 'application/json',
              },
              body: JSON.stringify({ is_cancelled: true }),
            });

            if (!response.ok) {
              throw new Error('預約取消失敗');
            }

            modal.hide();
            showFeedback('預約已取消。', 'warning');
            activeEvent = null;
            calendar.refetchEvents();
          } catch (error) {
            console.error(error);
            showFeedback('取消失敗，請稍後再試。', 'danger');
          }
        });
      }

      if (createSaveButton && createFormEl && createModal) {
        createSaveButton.addEventListener('click', async () => {
          const startInput = createFormEl.querySelector('[name="start_time"]');
          const treatmentOption = createTreatmentSelect && createTreatmentSelect.options[createTreatmentSelect.selectedIndex];
          if (!startInput || !treatmentOption) {
            return;
          }

          const payload = {
            start_time: new Date(startInput.value).toISOString(),
            treatment: Number(treatmentOption.value),
            customer_name: createFormEl.querySelector('[name="customer_name"]').value.trim(),
            customer_phone: createFormEl.querySelector('[name="customer_phone"]').value.trim(),
            note: createFormEl.querySelector('[name="note"]').value.trim(),
          };

          try {
            const response = await fetch(appointmentListUrl(), {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'Accept': 'application/json',
              },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              const message = await getErrorMessage(response, '預約建立失敗');
              throw new Error(message);
            }

            createModal.hide();
            showFeedback('預約已建立。', 'success');
            calendar.refetchEvents();
          } catch (error) {
            console.error(error);
            showFeedback(error instanceof Error ? error.message : '建立預約失敗，請確認資料後再試。', 'danger');
          }
        });
      }

      if (timeOffButton && timeOffModal && timeOffFormEl) {
        timeOffButton.addEventListener('click', () => {
          resetTimeOffModalState();
          timeOffFormEl.reset();
          const startField = timeOffFormEl.querySelector('[name="starts_at"]');
          const endField = timeOffFormEl.querySelector('[name="ends_at"]');
          const now = new Date();
          const roundedStart = new Date(now.getTime());
          const minutes = roundedStart.getMinutes();
          const remainder = minutes % 30;
          if (remainder !== 0) {
            roundedStart.setMinutes(minutes + (30 - remainder), 0, 0);
          } else {
            roundedStart.setSeconds(0, 0);
          }
          const roundedEnd = new Date(roundedStart.getTime() + 60 * 60 * 1000);
          if (startField) {
            startField.value = toLocalInputValue(roundedStart);
          }
          if (endField) {
            endField.value = toLocalInputValue(roundedEnd);
          }
          timeOffModal.show();
        });
      }

      if (timeOffSaveButton && timeOffFormEl && timeOffModal) {
        timeOffSaveButton.addEventListener('click', async () => {
          const startInput = timeOffFormEl.querySelector('[name="starts_at"]');
          const endInput = timeOffFormEl.querySelector('[name="ends_at"]');
          const noteInput = timeOffFormEl.querySelector('[name="note"]');
          if (!startInput || !endInput) {
            return;
          }
          if (!startInput.value || !endInput.value) {
            showFeedback('請填寫開始與結束時間。', 'warning');
            return;
          }
          const startDate = new Date(startInput.value);
          const endDate = new Date(endInput.value);
          if (Number.isNaN(startDate.getTime()) || Number.isNaN(endDate.getTime())) {
            showFeedback('時間格式不正確，請重新輸入。', 'warning');
            return;
          }
          if (endDate <= startDate) {
            showFeedback('結束時間必須晚於開始時間。', 'warning');
            return;
          }

          const payload = {
            starts_at: startDate.toISOString(),
            ends_at: endDate.toISOString(),
            note: noteInput ? noteInput.value.trim() : '',
          };

          const isEditingCurrent = Boolean(isEditingTimeOff && activeTimeOffEvent);

          try {
            const endpoint = isEditingCurrent ? `${timeOffApiBase}${activeTimeOffEvent.id}/` : timeOffApiBase;
            const method = isEditingCurrent ? 'PATCH' : 'POST';
            const response = await fetch(endpoint, {
              method,
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'Accept': 'application/json',
              },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              let errorMessage = isEditingCurrent ? '休假更新失敗' : '休假建立失敗';
              try {
                const errorData = await response.json();
                if (errorData && typeof errorData === 'object') {
                  if (typeof errorData.detail === 'string') {
                    errorMessage = errorData.detail;
                  } else {
                    const firstKey = Object.keys(errorData)[0];
                    const firstValue = firstKey ? errorData[firstKey] : null;
                    if (Array.isArray(firstValue) && firstValue.length > 0) {
                      errorMessage = firstValue[0];
                    } else if (typeof firstValue === 'string') {
                      errorMessage = firstValue;
                    }
                  }
                }
              } catch (parseError) {
                // ignore parse error and keep default message
              }
              throw new Error(errorMessage);
            }

            timeOffModal.hide();
            timeOffFormEl.reset();
            showFeedback(isEditingCurrent ? '休假已更新。' : '休假已建立。', isEditingCurrent ? 'info' : 'success');
            calendar.refetchEvents();
          } catch (error) {
            console.error(error);
            const fallback = isEditingCurrent ? '更新休假失敗，請稍後再試。' : '建立休假失敗，請稍後再試。';
            showFeedback(error instanceof Error ? error.message : fallback, 'danger');
          }
        });
      }

      if (timeOffDeleteButton && timeOffModal) {
        timeOffDeleteButton.addEventListener('click', async () => {
          if (!activeTimeOffEvent) {
            return;
          }
          if (!window.confirm('確認要刪除此休假區間嗎？')) {
            return;
          }
          try {
            const response = await fetch(`${timeOffApiBase}${activeTimeOffEvent.id}/`, {
              method: 'DELETE',
              headers: {
                'X-CSRFToken': csrfToken,
                'Accept': 'application/json',
              },
            });
            if (!response.ok) {
              let errorMessage = '休假刪除失敗';
              try {
                const errorData = await response.json();
                if (errorData && typeof errorData.detail === 'string') {
                  errorMessage = errorData.detail;
                }
              } catch (parseError) {
                // ignore
              }
              throw new Error(errorMessage);
            }
            timeOffModal.hide();
            showFeedback('休假已刪除。', 'warning');
            calendar.refetchEvents();
          } catch (error) {
            console.error(error);
            showFeedback(error instanceof Error ? error.message : '刪除休假失敗，請稍後再試。', 'danger');
          }
        });
      }

      if (timeOffModalEl) {
        timeOffModalEl.addEventListener('hidden.bs.modal', () => {
          resetTimeOffModalState();
          if (timeOffFormEl) {
            timeOffFormEl.reset();
          }
        });
      }
    })();
  </script>
{% endblock %}
