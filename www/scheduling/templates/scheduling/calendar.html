{% extends "therapist_panel/base.html" %}

{% block title %}Schedule | Therapist Panel{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <style>
    /* 使用 Bootstrap 的 min-height utilities 和自定義 CSS variables */
    :root {
      --calendar-height-desktop: 720px;
      --calendar-height-mobile: 500px;
    }
    
    #schedule-calendar { 
      min-height: var(--calendar-height-desktop);
    }
    
    /* 簡化響應式設計 - 更多使用 Bootstrap utilities */
    @media (max-width: 767.98px) {
      #schedule-calendar { 
        min-height: var(--calendar-height-mobile);
      }
    }
    
    /* FullCalendar 自定義樣式 - 保持必要的樣式 */
    .fc-event-title { font-weight: 600; }
    .fc-event-time { font-weight: 500; }
    .fc-event-customer { font-size: 0.85rem; }
    .fc-event-phone { font-size: 0.8rem; }
    
    /* 事件狀態樣式 */
    .fc-event.appointment-cancelled,
    .fc-event.appointment-cancelled .fc-event-main {
      opacity: 0.6;
      text-decoration: line-through;
    }
    
    .fc-event.time-off-event,
    .fc-event.time-off-event .fc-event-main {
      background-color: var(--bs-gray-200);
      border-color: var(--bs-blue-200);
      color: var(--bs-gray-800);
    }

    .fc-event.working-hours-event,
    .fc-event.working-hours-event .fc-event-main {
      background-color: var(--bs-success-bg-subtle);
      border-color: var(--bs-success-border-subtle);
      color: var(--bs-success-text);
    }

    .fc-event.working-hours-event {
      opacity: 0.85;
    }
    
    .working-hours-label {
      font-weight: 500;
      font-size: 0.85rem;
    }
    
    .time-off-label {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .calendar-background-event {
      pointer-events: none;
    }

    #calendar-mode-toggle.btn-secondary.active {
      background-color: var(--bs-primary);
      border-color: var(--bs-primary);
    }
  </style>
{% endblock %}

{% block content %}
  <!-- 使用 Bootstrap 的 d-flex 和 justify-content-between -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">本週預約行程</h1>
      <p class="text-body-secondary mb-0">檢視並管理您的按摩行程與營業時間。</p>
    </div>
    <div class="btn-group">
      <button type="button" class="btn btn-outline-secondary" id="calendar-mode-toggle">
        <i class="bi bi-pencil-square me-1"></i>開啟編輯模式
      </button>
      <button type="button" class="btn btn-outline-success" id="working-hours-create-button">
        <i class="bi bi-clock-history me-1"></i>設定上班時間
      </button>
      <button type="button" class="btn btn-outline-primary" id="time-off-create-button">
        <i class="bi bi-calendar-minus me-1"></i>新增休假
      </button>
    </div>
  </div>
  
  <div class="card shadow-sm">
    <div class="card-body">
      <!-- 使用 Bootstrap alert component -->
      <div id="schedule-feedback" class="alert d-none" role="alert"></div>
      <div id="schedule-calendar"></div>
    </div>
  </div>

  <!-- 模態框組件 - 簡化重複的結構 -->
  <!-- 編輯預約 Modal -->
  <div class="modal fade" id="appointmentModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5">編輯預約</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="appointment-form" novalidate>
            <div class="mb-3">
              <label for="appointment-treatment" class="form-label">療程</label>
              <select class="form-select" id="appointment-treatment" name="treatment" required></select>
            </div>
            <div class="mb-3">
              <label for="appointment-customer-name" class="form-label">顧客姓名</label>
              <input type="text" class="form-control" id="appointment-customer-name" name="customer_name" required>
            </div>
            <div class="mb-3">
              <label for="appointment-customer-phone" class="form-label">顧客電話</label>
              <input type="tel" class="form-control" id="appointment-customer-phone" name="customer_phone" required>
            </div>
            <div class="mb-3">
              <label for="appointment-note" class="form-label">備註</label>
              <textarea class="form-control" id="appointment-note" name="note" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-outline-danger" id="appointment-cancel">取消預約</button>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="appointment-save">
              <span class="spinner-border spinner-border-sm me-1 d-none"></span>儲存變更
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增預約 Modal -->
  <div class="modal fade" id="appointmentCreateModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5">新增預約</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="appointment-create-form" novalidate>
            <div class="mb-3">
              <label for="create-start-time" class="form-label">開始時間</label>
              <input type="datetime-local" class="form-control" id="create-start-time" name="start_time" required>
            </div>
            <div class="mb-3">
              <label for="create-treatment" class="form-label">療程</label>
              <select class="form-select" id="create-treatment" name="treatment" required></select>
            </div>
            <div class="mb-3">
              <label for="create-customer-name" class="form-label">顧客姓名</label>
              <input type="text" class="form-control" id="create-customer-name" name="customer_name" required>
            </div>
            <div class="mb-3">
              <label for="create-customer-phone" class="form-label">顧客電話</label>
              <input type="tel" class="form-control" id="create-customer-phone" name="customer_phone" required>
            </div>
            <div class="mb-3">
              <label for="create-note" class="form-label">備註</label>
              <textarea class="form-control" id="create-note" name="note" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="appointment-create-save">
            <span class="spinner-border spinner-border-sm me-1 d-none"></span>建立預約
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 上班時間 Modal -->
  <div class="modal fade" id="workingHoursModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="workingHoursModalLabel">新增上班時間</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="working-hours-form" novalidate>
            <div class="row g-2 mb-3">
              <div class="col-md-6">
                <label for="working-hours-start" class="form-label">開始時間</label>
                <input type="datetime-local" class="form-control" id="working-hours-start" name="starts_at" step="1800" required>
              </div>
              <div class="col-md-6">
                <label for="working-hours-end" class="form-label">結束時間</label>
                <input type="datetime-local" class="form-control" id="working-hours-end" name="ends_at" step="1800" required>
              </div>
            </div>
            <div class="mb-3">
              <label for="working-hours-note" class="form-label">備註</label>
              <textarea class="form-control" id="working-hours-note" name="note" rows="3" placeholder="例如：早班、晚班..."></textarea>
            </div>
            <div class="border-top pt-3" id="working-hours-repeat-section">
              <h6 class="mb-3">重複設定</h6>
              <div class="mb-3">
                <select class="form-select" id="working-hours-repeat-type" name="repeat_type">
                  <option value="">不重複</option>
                  <option value="weekly">每週</option>
                </select>
              </div>
              <div class="row g-2 mb-3 d-none" data-working-repeat-settings>
                <input type="hidden" id="working-hours-repeat-interval" name="repeat_interval" value="1">
                <div class="col-12">
                  <label class="form-label">重複星期</label>
                  <div class="d-flex flex-wrap gap-2" id="working-hours-weekdays">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="0" id="working-hours-weekday-0" data-working-weekday-checkbox>
                      <label class="form-check-label" for="working-hours-weekday-0">週一</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="1" id="working-hours-weekday-1" data-working-weekday-checkbox>
                      <label class="form-check-label" for="working-hours-weekday-1">週二</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="2" id="working-hours-weekday-2" data-working-weekday-checkbox>
                      <label class="form-check-label" for="working-hours-weekday-2">週三</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="3" id="working-hours-weekday-3" data-working-weekday-checkbox>
                      <label class="form-check-label" for="working-hours-weekday-3">週四</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="4" id="working-hours-weekday-4" data-working-weekday-checkbox>
                      <label class="form-check-label" for="working-hours-weekday-4">週五</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="5" id="working-hours-weekday-5" data-working-weekday-checkbox>
                      <label class="form-check-label" for="working-hours-weekday-5">週六</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="6" id="working-hours-weekday-6" data-working-weekday-checkbox>
                      <label class="form-check-label" for="working-hours-weekday-6">週日</label>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mb-3 d-none" data-working-repeat-settings>
                <label for="working-hours-repeat-until" class="form-label">重複至</label>
                <input type="date" class="form-control" id="working-hours-repeat-until" name="repeat_until">
              </div>
              <div class="alert alert-info d-none" data-working-repeat-edit-warning>
                編輯重複上班時段時無法調整重複設定。如需變更，請刪除後重新建立。
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-outline-danger d-none" id="working-hours-delete">
            <i class="bi bi-trash"></i> 刪除
          </button>
          <div class="d-flex gap-2 ms-auto">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-success" id="working-hours-save">
              <span class="spinner-border spinner-border-sm me-1 d-none"></span>建立上班時間
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 休假 Modal -->
  <div class="modal fade" id="timeOffModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="timeOffModalLabel">新增休假</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="time-off-form" novalidate>
            <div class="row g-2 mb-3">
              <div class="col-md-6">
                <label for="time-off-start" class="form-label">開始時間</label>
                <input type="datetime-local" class="form-control" id="time-off-start" name="starts_at" step="1800" required>
              </div>
              <div class="col-md-6">
                <label for="time-off-end" class="form-label">結束時間</label>
                <input type="datetime-local" class="form-control" id="time-off-end" name="ends_at" step="1800" required>
              </div>
            </div>
            <div class="mb-3">
              <label for="time-off-note" class="form-label">備註</label>
              <textarea class="form-control" id="time-off-note" name="note" rows="3" placeholder="例如：請假、進修..."></textarea>
            </div>
            
            <!-- 重複設定區塊 -->
            <div class="border-top pt-3" id="time-off-repeat-section">
              <h6 class="mb-3">重複設定</h6>
              <div class="mb-3">
                <select class="form-select" id="time-off-repeat-type" name="repeat_type">
                  <option value="">不重複</option>
                  <option value="daily">每天</option>
                  <option value="weekly">每週</option>
                </select>
              </div>
              <div class="row g-2 mb-3 d-none" data-repeat-settings>
                <div class="col-6">
                  <label for="time-off-repeat-interval" class="form-label">間隔</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="time-off-repeat-interval" name="repeat_interval" min="1" value="1">
                    <span class="input-group-text" data-repeat-interval-label>天</span>
                  </div>
                </div>
                <div class="col-6">
                  <label for="time-off-repeat-until" class="form-label">重複至</label>
                  <input type="date" class="form-control" id="time-off-repeat-until" name="repeat_until">
                </div>
              </div>
              <div class="alert alert-info d-none" data-repeat-edit-warning>
                編輯休假時無法調整重複設定。如需變更，請刪除後重新建立。
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-outline-danger d-none" id="time-off-delete">
            <i class="bi bi-trash"></i> 刪除
          </button>
          <div class="d-flex gap-2 ms-auto">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="time-off-save">
              <span class="spinner-border spinner-border-sm me-1 d-none"></span>建立休假
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 刪除確認 Modal -->
  <div class="modal fade" id="timeOffDeleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5">刪除休假</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0" id="time-off-delete-message">確定要刪除此休假嗎？</p>
        </div>
        <div class="modal-footer justify-content-end">
          <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-outline-danger me-2" id="time-off-delete-single">刪除</button>
          <button type="button" class="btn btn-danger d-none" id="time-off-delete-series">刪除整個序列</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
  <script>
    // 重構後的模組化 JavaScript
    class ScheduleManager {
      constructor() {
        this.calendar = null;
        this.activeEvent = null;
        this.activeTimeOffEvent = null;
        this.activeWorkingHoursEvent = null;
        this.isEditingTimeOff = false;
        this.isEditingWorkingHours = false;
        this.isEditMode = false;
        this.cachedTreatments = null;
        
        // API URLs
        this.appointmentsApiBase = '{{ appointments_api_url }}';
        this.timeOffApiBase = '{{ time_off_api_url }}';
        this.workingHoursApiBase = '{{ working_hours_api_url }}';
        this.treatmentsApiUrl = '{% url "therapist_panel:api:treatments:treatment-list" %}';
        
        // DOM 元素快取
        this.initElements();
        
        // 初始化
        this.init();
      }

      // 初始化 DOM 元素
      initElements() {
        this.elements = {
          calendar: document.getElementById('schedule-calendar'),
          feedback: document.getElementById('schedule-feedback'),
          
          // 模態框
          appointmentModal: new bootstrap.Modal(document.getElementById('appointmentModal')),
          appointmentCreateModal: new bootstrap.Modal(document.getElementById('appointmentCreateModal')),
          workingHoursModal: new bootstrap.Modal(document.getElementById('workingHoursModal')),
          timeOffModal: new bootstrap.Modal(document.getElementById('timeOffModal')),
          timeOffDeleteConfirmModal: new bootstrap.Modal(document.getElementById('timeOffDeleteConfirmModal')),
          
          // 表單
          appointmentForm: document.getElementById('appointment-form'),
          appointmentCreateForm: document.getElementById('appointment-create-form'),
          workingHoursForm: document.getElementById('working-hours-form'),
          timeOffForm: document.getElementById('time-off-form'),
          
          // 按鈕
          appointmentSave: document.getElementById('appointment-save'),
          appointmentCancel: document.getElementById('appointment-cancel'),
          appointmentCreateSave: document.getElementById('appointment-create-save'),
          workingHoursCreateButton: document.getElementById('working-hours-create-button'),
          workingHoursSave: document.getElementById('working-hours-save'),
          workingHoursDelete: document.getElementById('working-hours-delete'),
          calendarModeToggle: document.getElementById('calendar-mode-toggle'),
          timeOffCreateButton: document.getElementById('time-off-create-button'),
          timeOffSave: document.getElementById('time-off-save'),
          timeOffDelete: document.getElementById('time-off-delete'),
          timeOffDeleteSingle: document.getElementById('time-off-delete-single'),
          timeOffDeleteSeries: document.getElementById('time-off-delete-series'),
          
          // 其他
          treatmentSelects: {
            edit: document.getElementById('appointment-treatment'),
            create: document.getElementById('create-treatment')
          },
          workingHoursModalTitle: document.getElementById('workingHoursModalLabel'),
          workingHoursRepeatType: document.getElementById('working-hours-repeat-type'),
          workingHoursRepeatSettings: Array.from(document.querySelectorAll('[data-working-repeat-settings]')),
          workingHoursRepeatEditWarning: document.querySelector('[data-working-repeat-edit-warning]'),
          workingHoursWeekdayCheckboxes: Array.from(document.querySelectorAll('[data-working-weekday-checkbox]')),
          workingHoursRepeatInterval: document.getElementById('working-hours-repeat-interval'),
          workingHoursRepeatUntil: document.getElementById('working-hours-repeat-until'),
          workingHoursStart: document.getElementById('working-hours-start'),
          workingHoursEnd: document.getElementById('working-hours-end'),
          workingHoursNote: document.getElementById('working-hours-note'),
          timeOffModalTitle: document.getElementById('timeOffModalLabel'),
          repeatType: document.getElementById('time-off-repeat-type'),
          repeatSettings: document.querySelector('[data-repeat-settings]'),
          repeatIntervalLabel: document.querySelector('[data-repeat-interval-label]'),
          repeatEditWarning: document.querySelector('[data-repeat-edit-warning]')
        };

        if (this.elements.workingHoursRepeatEditWarning && !this.elements.workingHoursRepeatEditWarning.dataset.defaultText) {
          this.elements.workingHoursRepeatEditWarning.dataset.defaultText = this.elements.workingHoursRepeatEditWarning.textContent.trim();
        }
      }

      // 主要初始化方法
      async init() {
        if (!this.elements.calendar) return;
        
        this.initCalendar();
        this.bindEvents();
        await this.loadTreatments();
        this.updateCalendarModeButton();
      }

      // 工具方法
      getCsrfToken() {
        const name = 'csrftoken=';
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
          const trimmed = cookie.trim();
          if (trimmed.startsWith(name)) {
            return decodeURIComponent(trimmed.substring(name.length));
          }
        }
        return '';
      }

      showFeedback(message, variant = 'success') {
        if (!this.elements.feedback) return;
        
        this.elements.feedback.className = `alert alert-${variant}`;
        this.elements.feedback.textContent = message;
        this.elements.feedback.classList.remove('d-none');
        
        setTimeout(() => {
          this.elements.feedback.classList.add('d-none');
        }, 3000);
      }

      toLocalInputValue(date) {
        if (!date) return '';
        const local = new Date(date);
        local.setMinutes(local.getMinutes() - local.getTimezoneOffset());
        return local.toISOString().slice(0, 16);
      }

      async getErrorMessage(response, fallback) {
        try {
          const data = await response.json();
          if (typeof data === 'string') return data;
          if (data?.detail) return data.detail;
          
          // 檢查第一個錯誤字段
          for (const value of Object.values(data)) {
            if (Array.isArray(value) && value[0]) return value[0];
            if (typeof value === 'string') return value;
          }
        } catch (e) {
          console.debug('Error parsing response:', e);
        }
        return fallback;
      }

      toggleButtonLoading(button, isLoading) {
        if (!button) return;
        
        const spinner = button.querySelector('.spinner-border');
        if (spinner) {
          spinner.classList.toggle('d-none', !isLoading);
        }
        button.disabled = isLoading;
      }

      // API 方法
      async apiRequest(url, options = {}) {
        const defaultOptions = {
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': this.getCsrfToken(),
            'Accept': 'application/json',
            ...options.headers
          }
        };

        return fetch(url, { ...defaultOptions, ...options });
      }

      async loadTreatments() {
        if (this.cachedTreatments) return this.cachedTreatments;
        
        try {
          const response = await this.apiRequest(this.treatmentsApiUrl);
          if (!response.ok) throw new Error('Failed to load treatments');
          
          this.cachedTreatments = await response.json();
          return this.cachedTreatments;
        } catch (error) {
          console.error(error);
          this.showFeedback('無法載入療程清單，請稍後再試。', 'danger');
          return [];
        }
      }

      async populateTreatmentSelect(selectElement) {
        if (!selectElement) return;
        
        const treatments = await this.loadTreatments();
        selectElement.innerHTML = '';
        
        treatments
          .filter(t => t.is_active)
          .forEach(treatment => {
            const option = document.createElement('option');
            option.value = treatment.id;
            option.textContent = `${treatment.name} (${treatment.duration_minutes} 分)`;
            option.dataset.duration = treatment.duration_minutes;
            selectElement.appendChild(option);
          });
      }

      // 日曆初始化
      initCalendar() {
        const getInitialView = () => window.innerWidth < 768 ? 'listWeek' : 'timeGridWeek';
        
        this.calendar = new FullCalendar.Calendar(this.elements.calendar, {
          initialView: getInitialView(),
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: window.innerWidth < 768 ? 'listWeek,timeGridDay' : 'timeGridWeek,timeGridDay,listWeek'
          },
          slotMinTime: '08:00:00',
          slotMaxTime: '23:00:00',
          nowIndicator: true,
          locale: 'zh-tw',
          firstDay: 1,
          scrollTime: '09:00:00',
          editable: true,
          eventDurationEditable: false,
          selectable: true,
          height: 'auto',
          
          eventSources: [
            this.createWorkingHoursEventSource(),
            this.createAppointmentEventSource(),
            this.createTimeOffEventSource()
          ],
          
          eventContent: (arg) => this.renderEventContent(arg),
          eventClick: (info) => this.handleEventClick(info),
          eventDrop: (info) => this.handleEventDrop(info),
          select: (selectionInfo) => this.handleSelect(selectionInfo)
        });

        this.calendar.render();
        
        // 響應式更新
        window.addEventListener('resize', () => this.calendar.updateSize());
      }

      createWorkingHoursEventSource() {
        return {
          events: async (info, successCallback, failureCallback) => {
            try {
              const url = new URL(this.workingHoursApiBase, window.location.origin);
              url.searchParams.set('start', info.startStr);
              url.searchParams.set('end', info.endStr);

              const response = await this.apiRequest(url.toString());
              if (!response.ok) throw new Error('Failed to load working hours');

              const data = await response.json();
              const events = data.map(item => {
                const baseClassNames = ['working-hours-event'];
                const eventType = 'workingHours';
                return {
                  id: item.uuid,
                  title: item.note ? `上班：${item.note}` : '上班時間',
                  start: item.starts_at,
                  end: item.ends_at,
                  editable: false,
                  display: this.getEventDisplay(eventType),
                  classNames: this.getEventClassNames(eventType, baseClassNames),
                  backgroundColor: this.getEventBackgroundColor(eventType),
                  borderColor: this.getEventBackgroundColor(eventType),
                  extendedProps: {
                    eventType,
                    note: item.note,
                    seriesUuid: item.series_uuid || null,
                    isRecurring: Boolean(item.series_uuid),
                    isGenerated: Boolean(item.is_generated),
                    weekday: item.weekday,
                    baseClassNames,
                  }
                };
              });

              successCallback(events);
              this.applyCalendarMode();
            } catch (error) {
              console.error(error);
              failureCallback(error);
            }
          }
        };
      }

      createAppointmentEventSource() {
        return {
          events: async (info, successCallback, failureCallback) => {
            try {
              const url = new URL(this.appointmentsApiBase, window.location.origin);
              url.searchParams.set('start', info.startStr);
              url.searchParams.set('end', info.endStr);
              
              const response = await this.apiRequest(url.toString());
              if (!response.ok) throw new Error('Failed to load appointments');
              
              const data = await response.json();
              const events = data.map(item => ({
                id: item.uuid,
                title: item.treatment_name || '療程',
                start: item.start_time,
                end: item.end_time,
                extendedProps: {
                  eventType: 'appointment',
                  therapistUuid: item.therapist_uuid,
                  customerName: item.customer_name,
                  customerPhone: item.customer_phone,
                  note: item.note,
                  isCancelled: item.is_cancelled,
                  treatmentId: item.treatment
                },
                classNames: item.is_cancelled ? ['appointment-cancelled'] : []
              }));
              
              successCallback(events);
              this.applyCalendarMode();
            } catch (error) {
              console.error(error);
              failureCallback(error);
            }
          }
        };
      }

      createTimeOffEventSource() {
        return {
          events: async (info, successCallback, failureCallback) => {
            try {
              const url = new URL(this.timeOffApiBase, window.location.origin);
              url.searchParams.set('start', info.startStr);
              url.searchParams.set('end', info.endStr);
              
              const response = await this.apiRequest(url.toString());
              if (!response.ok) throw new Error('Failed to load time off');
              
              const data = await response.json();
              const events = data.map(item => {
                const baseClassNames = ['time-off-event'];
                const eventType = 'timeOff';
                return {
                  id: item.uuid,
                  title: item.note ? `休假：${item.note}` : '休假',
                  start: item.starts_at,
                  end: item.ends_at,
                  editable: false,
                  display: this.getEventDisplay(eventType),
                  classNames: this.getEventClassNames(eventType, baseClassNames),
                  backgroundColor: this.getEventBackgroundColor(eventType),
                  borderColor: this.getEventBackgroundColor(eventType),
                  extendedProps: {
                    eventType,
                    note: item.note,
                    seriesUuid: item.series_uuid || null,
                    isRecurring: Boolean(item.is_recurring),
                    baseClassNames,
                  }
                };
              });
              
              successCallback(events);
            } catch (error) {
              console.error(error);
              failureCallback(error);
            }
          }
        };
      }

      renderEventContent(arg) {
        if (!this.isEditMode && ['workingHours', 'timeOff'].includes(arg.event.extendedProps.eventType)) {
          return { domNodes: [] };
        }

        if (arg.event.extendedProps.eventType === 'workingHours') {
          const wrapper = document.createElement('div');
          wrapper.classList.add('working-hours-label', 'text-body-secondary');
          const base = arg.timeText ? `${arg.timeText} 上班` : '上班時間';
          wrapper.textContent = arg.event.extendedProps.note ? `${base}｜${arg.event.extendedProps.note}` : base;
          return { domNodes: [wrapper] };
        }

        if (arg.event.extendedProps.eventType === 'timeOff') {
          const wrapper = document.createElement('div');
          wrapper.classList.add('time-off-label');
          wrapper.textContent = arg.event.extendedProps.note ? `休假：${arg.event.extendedProps.note}` : '休假';
          return { domNodes: [wrapper] };
        }

        const container = document.createElement('div');
        const props = arg.event.extendedProps;
        
        // 標題
        const titleEl = document.createElement('div');
        titleEl.classList.add('fc-event-title');
        titleEl.textContent = props.isCancelled ? `${arg.event.title} (已取消)` : arg.event.title;
        container.appendChild(titleEl);

        // 顧客姓名
        if (props.customerName) {
          const customerEl = document.createElement('div');
          customerEl.classList.add('fc-event-customer');
          customerEl.textContent = props.customerName;
          container.appendChild(customerEl);
        }

        // 電話（僅桌面版顯示）
        if (props.customerPhone && window.innerWidth >= 768) {
          const phoneEl = document.createElement('div');
          phoneEl.classList.add('fc-event-phone', 'text-body-secondary');
          phoneEl.textContent = `☎ ${props.customerPhone}`;
          container.appendChild(phoneEl);
        }

        return { domNodes: [container] };
      }

      async handleEventClick(info) {
        info.jsEvent.preventDefault();
        
        if (!this.isEditMode && ['timeOff', 'workingHours'].includes(info.event.extendedProps.eventType)) {
          return;
        }

        if (info.event.extendedProps.eventType === 'timeOff') {
          await this.handleTimeOffEdit(info.event);
        } else if (info.event.extendedProps.eventType === 'workingHours') {
          await this.handleWorkingHoursEdit(info.event);
        } else {
          await this.handleAppointmentEdit(info.event);
        }
      }

      async handleAppointmentEdit(event) {
        this.activeEvent = event;
        const form = this.elements.appointmentForm;
        
        form.reset();
        await this.populateTreatmentSelect(this.elements.treatmentSelects.edit);
        
        // 填充表單
        form.customer_name.value = event.extendedProps.customerName || '';
        form.customer_phone.value = event.extendedProps.customerPhone || '';
        form.note.value = event.extendedProps.note || '';
        
        if (this.elements.treatmentSelects.edit) {
          this.elements.treatmentSelects.edit.value = event.extendedProps.treatmentId || '';
        }
        
        this.elements.appointmentCancel.disabled = Boolean(event.extendedProps.isCancelled);
        this.elements.appointmentModal.show();
      }

      resetWorkingHoursModal() {
        this.isEditingWorkingHours = false;
        this.activeWorkingHoursEvent = null;

        const form = this.elements.workingHoursForm;
        form?.reset?.();

        if (this.elements.workingHoursModalTitle) {
          this.elements.workingHoursModalTitle.textContent = '新增上班時間';
        }
        if (this.elements.workingHoursSave) {
          this.elements.workingHoursSave.textContent = '建立上班時間';
        }
        this.elements.workingHoursDelete?.classList.add('d-none');

        if (this.elements.workingHoursRepeatType) {
          this.elements.workingHoursRepeatType.disabled = false;
          this.elements.workingHoursRepeatType.value = '';
        }
        if (this.elements.workingHoursRepeatInterval) {
          this.elements.workingHoursRepeatInterval.value = '1';
          this.elements.workingHoursRepeatInterval.removeAttribute('disabled');
        }
        if (this.elements.workingHoursRepeatUntil) {
          this.elements.workingHoursRepeatUntil.value = '';
          this.elements.workingHoursRepeatUntil.removeAttribute('disabled');
        }
        this.elements.workingHoursRepeatSettings?.forEach((el) => el?.classList.add('d-none'));

        this.elements.workingHoursWeekdayCheckboxes?.forEach((checkbox) => {
          checkbox.checked = false;
          checkbox.removeAttribute('disabled');
        });

        if (this.elements.workingHoursRepeatEditWarning) {
          const warningEl = this.elements.workingHoursRepeatEditWarning;
          if (warningEl.dataset.defaultText) {
            warningEl.textContent = warningEl.dataset.defaultText;
          }
          warningEl.classList.add('d-none');
        }

        this.elements.workingHoursStart?.removeAttribute('disabled');
        this.elements.workingHoursEnd?.removeAttribute('disabled');

        this.updateWorkingHoursRepeatControls();
      }

      updateWorkingHoursRepeatControls() {
        const type = this.elements.workingHoursRepeatType?.value;
        const show = type === 'weekly';
        this.elements.workingHoursRepeatSettings?.forEach((el) => {
          if (el) {
            el.classList.toggle('d-none', !show);
          }
        });
        if (show) {
          this.syncWorkingHoursWeekday();
        }
      }

      syncWorkingHoursWeekday() {
        if (this.isEditingWorkingHours) return;
        if (this.elements.workingHoursRepeatType?.value !== 'weekly') return;

        const startInput = this.elements.workingHoursStart;
        if (!startInput?.value) return;

        const date = new Date(startInput.value);
        if (Number.isNaN(date.getTime())) return;

        const weekday = this.getWeekdayIndex(date);
        const hasSelection = this.elements.workingHoursWeekdayCheckboxes?.some((checkbox) => checkbox.checked);
        if (hasSelection) return;

        this.elements.workingHoursWeekdayCheckboxes?.forEach((checkbox) => {
          checkbox.checked = Number(checkbox.value) === weekday;
        });
      }

      getWeekdayIndex(date) {
        return (date.getDay() + 6) % 7;
      }

      getSelectedWorkingWeekdays() {
        return this.elements.workingHoursWeekdayCheckboxes
          ?.filter((checkbox) => checkbox.checked)
          .map((checkbox) => Number(checkbox.value)) ?? [];
      }

      shiftDateToWeekday(baseDate, targetWeekday) {
        const baseWeekday = this.getWeekdayIndex(baseDate);
        let diff = targetWeekday - baseWeekday;
        if (diff < 0) diff += 7;
        const adjusted = new Date(baseDate.getTime());
        adjusted.setDate(adjusted.getDate() + diff);
        return adjusted;
      }

      showWorkingHoursModal() {
        this.resetWorkingHoursModal();

        const now = new Date();
        const roundedStart = new Date(now);
        const minutes = roundedStart.getMinutes();
        const remainder = minutes % 30;
        if (remainder !== 0) {
          roundedStart.setMinutes(minutes + (30 - remainder), 0, 0);
        } else {
          roundedStart.setSeconds(0, 0);
        }
        const roundedEnd = new Date(roundedStart.getTime() + 60 * 60 * 1000);

        if (this.elements.workingHoursStart) {
          this.elements.workingHoursStart.value = this.toLocalInputValue(roundedStart);
        }
        if (this.elements.workingHoursEnd) {
          this.elements.workingHoursEnd.value = this.toLocalInputValue(roundedEnd);
        }

        this.syncWorkingHoursWeekday();
        this.elements.workingHoursModal?.show();
      }

      async saveWorkingHours() {
        const button = this.elements.workingHoursSave;
        this.toggleButtonLoading(button, true);

        try {
          const startValue = this.elements.workingHoursStart?.value;
          const endValue = this.elements.workingHoursEnd?.value;

          if (!startValue || !endValue) {
            this.showFeedback('請填寫上班時間的開始與結束。', 'warning');
            return;
          }

          const startDate = new Date(startValue);
          const endDate = new Date(endValue);
          if (Number.isNaN(startDate.getTime()) || Number.isNaN(endDate.getTime())) {
            this.showFeedback('請輸入有效的日期時間。', 'warning');
            return;
          }

          if (endDate <= startDate) {
            this.showFeedback('結束時間必須晚於開始時間。', 'warning');
            return;
          }

          const isEditing = this.isEditingWorkingHours && this.activeWorkingHoursEvent;
          const repeatTypeValue = this.elements.workingHoursRepeatType?.value;
          const wantsRecurring = !isEditing && repeatTypeValue === 'weekly';

          const note = (this.elements.workingHoursNote?.value || '').trim();
          const durationMs = endDate.getTime() - startDate.getTime();

          let selectedWeekdays = [];
          let repeatInterval = 1;
          let repeatUntilValue = null;
          if (wantsRecurring) {
            selectedWeekdays = this.getSelectedWorkingWeekdays();
            if (!selectedWeekdays.length) {
              this.showFeedback('請至少選擇一個重複的星期。', 'warning');
              return;
            }

            const intervalValue = Number.parseInt(this.elements.workingHoursRepeatInterval?.value ?? '1', 10);
            repeatInterval = Number.isNaN(intervalValue) ? 1 : Math.max(intervalValue, 1);

            const repeatUntilRaw = this.elements.workingHoursRepeatUntil?.value || null;
            repeatUntilValue = repeatUntilRaw;
          }

          const parseRepeatUntilDate = (value) => {
            if (!value) return null;
            const [yearStr, monthStr, dayStr] = value.split('-');
            const year = Number.parseInt(yearStr ?? '', 10);
            if (Number.isNaN(year)) return null;
            const rawMonth = Number.parseInt(monthStr ?? '', 10);
            const rawDay = Number.parseInt(dayStr ?? '', 10);
            const monthIndex = Number.isNaN(rawMonth) ? 0 : Math.max(rawMonth - 1, 0);
            const dayValue = Number.isNaN(rawDay) ? 1 : rawDay;
            return new Date(year, monthIndex, dayValue, 23, 59, 59, 999);
          };

          const repeatUntilDate = wantsRecurring ? parseRepeatUntilDate(repeatUntilValue) : null;

          const buildPayload = (start, end, weekday) => {
            const body = {
              starts_at: start.toISOString(),
              ends_at: end.toISOString(),
              note,
            };
            if (weekday !== undefined) {
              body.weekday = weekday;
              body.repeat_interval = repeatInterval;
              if (repeatUntilValue) {
                body.repeat_until = repeatUntilValue;
              }
            }
            return body;
          };

          const requests = [];

          if (isEditing || !wantsRecurring) {
            const baseEndpoint = isEditing
              ? `${this.workingHoursApiBase}${this.activeWorkingHoursEvent.id}/`
              : this.workingHoursApiBase;
            const method = isEditing ? 'PATCH' : 'POST';
            requests.push({
              endpoint: baseEndpoint,
              method,
              body: buildPayload(startDate, endDate, wantsRecurring ? selectedWeekdays[0] : undefined),
            });
          } else {
            for (const weekday of selectedWeekdays) {
              const occurrenceStart = this.shiftDateToWeekday(startDate, weekday);
              if (repeatUntilDate && occurrenceStart > repeatUntilDate) {
                this.showFeedback('重複結束日期不能早於所選星期的第一次上班日。', 'warning');
                return;
              }
              const occurrenceEnd = new Date(occurrenceStart.getTime() + durationMs);
              requests.push({
                endpoint: this.workingHoursApiBase,
                method: 'POST',
                body: buildPayload(occurrenceStart, occurrenceEnd, weekday),
              });
            }
          }

          let successCount = 0;
          for (const request of requests) {
            const response = await this.apiRequest(request.endpoint, {
              method: request.method,
              body: JSON.stringify(request.body),
            });

            if (!response.ok) {
              const fallback = request.method === 'PATCH' ? '上班時間更新失敗' : '上班時間建立失敗';
              const message = await this.getErrorMessage(response, fallback);
              if (successCount > 0) {
                throw new Error(`${message}（部分時段已建立）`);
              }
              throw new Error(message);
            }

            successCount += 1;
          }

          this.elements.workingHoursModal?.hide();
          if (isEditing) {
            this.showFeedback('上班時間已更新。', 'info');
          } else if (wantsRecurring && successCount > 1) {
            this.showFeedback(`已建立 ${successCount} 個重複上班時段。`, 'success');
          } else {
            this.showFeedback('上班時間已建立。', 'success');
          }
          this.activeWorkingHoursEvent = null;
          this.calendar?.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message || '發生未知錯誤。', 'danger');
        } finally {
          this.toggleButtonLoading(button, false);
        }
      }

      async deleteWorkingHours() {
        if (!this.activeWorkingHoursEvent) return;

        const isSeries = Boolean(this.activeWorkingHoursEvent.extendedProps?.seriesUuid);
        const isGenerated = Boolean(this.activeWorkingHoursEvent.extendedProps?.isGenerated);

        if (isGenerated) {
          this.showFeedback('此上班時段由重複設定產生，僅能透過休假功能處理例外狀況。', 'warning');
          return;
        }

        const confirmed = isSeries
          ? confirm('這是重複上班時段，刪除將移除整個序列，確定要刪除嗎？')
          : confirm('確定要刪除此上班時段嗎？');
        if (!confirmed) return;

        const button = this.elements.workingHoursDelete;
        this.toggleButtonLoading(button, true);

        try {
          let endpoint = `${this.workingHoursApiBase}${this.activeWorkingHoursEvent.id}/`;
          if (isSeries) {
            endpoint += '?scope=series';
          }

          const response = await this.apiRequest(endpoint, { method: 'DELETE' });
          if (!response.ok) {
            const message = await this.getErrorMessage(response, '上班時間刪除失敗');
            throw new Error(message);
          }

          this.elements.workingHoursModal?.hide();
          this.showFeedback(isSeries ? '重複上班時段已刪除。' : '上班時間已刪除。', 'warning');
          this.activeWorkingHoursEvent = null;
          this.calendar?.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message || '刪除失敗，請稍後再試。', 'danger');
        } finally {
          this.toggleButtonLoading(button, false);
        }
      }

      async handleWorkingHoursEdit(event) {
        this.resetWorkingHoursModal();
        this.isEditingWorkingHours = true;
        this.activeWorkingHoursEvent = event;

        if (this.elements.workingHoursStart && event.start) {
          this.elements.workingHoursStart.value = this.toLocalInputValue(event.start);
        }
        if (this.elements.workingHoursEnd && event.end) {
          this.elements.workingHoursEnd.value = this.toLocalInputValue(event.end);
        }
        if (this.elements.workingHoursNote) {
          this.elements.workingHoursNote.value = event.extendedProps.note || '';
        }

        const warningEl = this.elements.workingHoursRepeatEditWarning;
        const hasSeries = Boolean(event.extendedProps.seriesUuid);
        const isGenerated = Boolean(event.extendedProps.isGenerated);
        const eventWeekday = typeof event.extendedProps.weekday === 'number'
          ? event.extendedProps.weekday
          : (event.start ? this.getWeekdayIndex(new Date(event.start)) : 0);

        if (this.elements.workingHoursModalTitle) {
          this.elements.workingHoursModalTitle.textContent = '編輯上班時間';
        }
        if (this.elements.workingHoursSave) {
          this.elements.workingHoursSave.textContent = '儲存上班時間';
        }

        if (hasSeries) {
          if (this.elements.workingHoursRepeatType) {
            this.elements.workingHoursRepeatType.value = 'weekly';
            this.elements.workingHoursRepeatType.disabled = true;
          }
          this.updateWorkingHoursRepeatControls();

          this.elements.workingHoursWeekdayCheckboxes?.forEach((checkbox) => {
            const isMatch = Number(checkbox.value) === eventWeekday;
            checkbox.checked = isMatch;
            checkbox.setAttribute('disabled', 'disabled');
          });
          this.elements.workingHoursRepeatInterval?.setAttribute('disabled', 'disabled');
          this.elements.workingHoursRepeatUntil?.setAttribute('disabled', 'disabled');
          this.elements.workingHoursStart?.setAttribute('disabled', 'disabled');
          this.elements.workingHoursEnd?.setAttribute('disabled', 'disabled');

          if (warningEl) {
            warningEl.classList.remove('d-none');
          }
        } else {
          if (this.elements.workingHoursRepeatType) {
            this.elements.workingHoursRepeatType.value = '';
            this.elements.workingHoursRepeatType.disabled = false;
          }
          this.updateWorkingHoursRepeatControls();
        }

        if (warningEl) {
          if (isGenerated) {
            warningEl.classList.remove('d-none');
            warningEl.textContent = '此上班時段由重複設定產生，僅能調整備註。例外情況請建立休假。';
          } else if (hasSeries) {
            warningEl.classList.remove('d-none');
          }
        }

        if (!isGenerated) {
          this.elements.workingHoursDelete?.classList.remove('d-none');
        } else {
          this.elements.workingHoursDelete?.classList.add('d-none');
        }

        this.elements.workingHoursModal?.show();
      }

      async handleTimeOffEdit(event) {
        this.isEditingTimeOff = true;
        this.activeTimeOffEvent = event;
        const form = this.elements.timeOffForm;
        
        form.reset();
        
        // 填充表單
        if (event.start) form.starts_at.value = this.toLocalInputValue(event.start);
        if (event.end) form.ends_at.value = this.toLocalInputValue(event.end);
        form.note.value = event.extendedProps.note || '';
        
        // 更新界面
        this.elements.timeOffModalTitle.textContent = '編輯休假';
        this.elements.timeOffSave.textContent = '儲存休假';
        this.elements.timeOffDelete.classList.remove('d-none');
        
        // 禁用重複設定
        this.elements.repeatType.disabled = true;
        this.elements.repeatEditWarning.classList.remove('d-none');
        
        this.elements.timeOffModal.show();
      }

      toggleEditMode() {
        this.isEditMode = !this.isEditMode;
        this.updateCalendarModeButton();
        this.applyCalendarMode();
        if (!this.isEditMode) {
          this.elements.workingHoursModal?.hide();
          this.elements.timeOffModal?.hide();
          this.resetWorkingHoursModal();
          this.resetTimeOffModal();
        }
      }

      updateCalendarModeButton() {
        const button = this.elements.calendarModeToggle;
        if (!button) return;

        if (this.isEditMode) {
          button.classList.remove('btn-outline-secondary');
          button.classList.add('btn-secondary', 'active');
          button.innerHTML = '<i class="bi bi-eye me-1"></i>返回檢視模式';
        } else {
          button.classList.remove('btn-secondary', 'active');
          button.classList.add('btn-outline-secondary');
          button.innerHTML = '<i class="bi bi-pencil-square me-1"></i>開啟編輯模式';
        }
      }

      applyCalendarMode() {
        if (!this.calendar) return;

        this.calendar.batchRendering(() => {
          this.calendar.getEvents().forEach((event) => {
            const eventType = event.extendedProps.eventType;
            if (!['workingHours', 'timeOff'].includes(eventType)) return;

            const baseClassNames = event.extendedProps.baseClassNames || [];
            event.setProp('display', this.getEventDisplay(eventType));
            event.setProp('classNames', this.getEventClassNames(eventType, baseClassNames));
            event.setProp('backgroundColor', this.getEventBackgroundColor(eventType));
            event.setProp('borderColor', this.getEventBackgroundColor(eventType));
          });
        });
      }

      getEventDisplay(eventType) {
        if (!this.isEditMode && ['workingHours', 'timeOff'].includes(eventType)) {
          return 'background';
        }
        return 'auto';
      }

      getEventClassNames(eventType, baseClassNames = []) {
        if (!this.isEditMode && ['workingHours', 'timeOff'].includes(eventType)) {
          return [...baseClassNames, 'calendar-background-event'];
        }
        return baseClassNames;
      }

      getEventBackgroundColor(eventType) {
        if (eventType === 'workingHours') {
          return '#d1e7dd';
        }
        if (eventType === 'timeOff') {
          return '#e2e3e5';
        }
        return '';
      }

      async handleEventDrop(info) {
        if (info.event.extendedProps.eventType === 'timeOff' || info.event.extendedProps.eventType === 'workingHours') {
          info.revert();
          return;
        }
        
        if (info.event.extendedProps.isCancelled) {
          this.showFeedback('已取消的預約無法調整時間。', 'warning');
          info.revert();
          return;
        }

        try {
          const response = await this.apiRequest(
            `${this.appointmentsApiBase}${info.event.id}/`,
            {
              method: 'PATCH',
              body: JSON.stringify({ start_time: info.event.start.toISOString() })
            }
          );

          if (!response.ok) {
            const message = await this.getErrorMessage(response, '時間更新失敗');
            throw new Error(message);
          }
          
          this.showFeedback('預約時間已更新。');
          this.calendar.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message, 'danger');
          info.revert();
        }
      }

      async handleSelect(selectionInfo) {
        await this.populateTreatmentSelect(this.elements.treatmentSelects.create);
        
        if (!this.elements.treatmentSelects.create.options.length) {
          this.showFeedback('目前沒有可用的療程，請先建立療程。', 'warning');
          return;
        }

        this.elements.appointmentCreateForm.reset();
        this.elements.appointmentCreateForm.start_time.value = this.toLocalInputValue(selectionInfo.start);
        
        if (this.elements.treatmentSelects.create.options.length) {
          this.elements.treatmentSelects.create.selectedIndex = 0;
        }
        
        this.elements.appointmentCreateModal.show();
        this.calendar.unselect();
      }

      // 事件綁定
      bindEvents() {
        // 預約相關
        this.elements.appointmentSave?.addEventListener('click', () => this.saveAppointment());
        this.elements.appointmentCancel?.addEventListener('click', () => this.cancelAppointment());
        this.elements.appointmentCreateSave?.addEventListener('click', () => this.createAppointment());

        // 上班時間相關
        this.elements.workingHoursCreateButton?.addEventListener('click', () => this.showWorkingHoursModal());
        this.elements.workingHoursSave?.addEventListener('click', () => this.saveWorkingHours());
        this.elements.workingHoursDelete?.addEventListener('click', () => this.deleteWorkingHours());
        this.elements.workingHoursRepeatType?.addEventListener('change', () => this.updateWorkingHoursRepeatControls());
        this.elements.workingHoursStart?.addEventListener('change', () => this.syncWorkingHoursWeekday());
        this.elements.calendarModeToggle?.addEventListener('click', () => this.toggleEditMode());

        // 休假相關
        this.elements.timeOffCreateButton?.addEventListener('click', () => this.showTimeOffModal());
        this.elements.timeOffSave?.addEventListener('click', () => this.saveTimeOff());
        this.elements.timeOffDelete?.addEventListener('click', () => this.showDeleteConfirm());
        this.elements.timeOffDeleteSingle?.addEventListener('click', () => this.deleteTimeOff());
        this.elements.timeOffDeleteSeries?.addEventListener('click', () => this.deleteTimeOff('series'));

        // 重複設定
        this.elements.repeatType?.addEventListener('change', () => this.updateRepeatControls());

        // 模態框重置
        document.getElementById('workingHoursModal')?.addEventListener('hidden.bs.modal', () => this.resetWorkingHoursModal());
        document.getElementById('timeOffModal')?.addEventListener('hidden.bs.modal', () => this.resetTimeOffModal());
      }

      async saveAppointment() {
        if (!this.activeEvent) return;
        
        this.toggleButtonLoading(this.elements.appointmentSave, true);
        
        const form = this.elements.appointmentForm;
        const payload = {
          customer_name: form.customer_name.value.trim(),
          customer_phone: form.customer_phone.value.trim(),
          note: form.note.value.trim()
        };

        if (this.elements.treatmentSelects.edit.value) {
          payload.treatment = Number(this.elements.treatmentSelects.edit.value);
        }

        try {
          const response = await this.apiRequest(
            `${this.appointmentsApiBase}${this.activeEvent.id}/`,
            { method: 'PATCH', body: JSON.stringify(payload) }
          );

          if (!response.ok) {
            const message = await this.getErrorMessage(response, '預約更新失敗');
            throw new Error(message);
          }

          this.elements.appointmentModal.hide();
          this.showFeedback('預約資訊已更新。');
          this.activeEvent = null;
          this.calendar.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message, 'danger');
        } finally {
          this.toggleButtonLoading(this.elements.appointmentSave, false);
        }
      }

      async cancelAppointment() {
        if (!this.activeEvent || this.activeEvent.extendedProps.isCancelled) {
          this.elements.appointmentModal.hide();
          return;
        }

        if (!confirm('確認要取消這筆預約嗎？')) return;

        try {
          const response = await this.apiRequest(
            `${this.appointmentsApiBase}${this.activeEvent.id}/`,
            { method: 'PATCH', body: JSON.stringify({ is_cancelled: true }) }
          );

          if (!response.ok) throw new Error('預約取消失敗');

          this.elements.appointmentModal.hide();
          this.showFeedback('預約已取消。', 'warning');
          this.activeEvent = null;
          this.calendar.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback('取消失敗，請稍後再試。', 'danger');
        }
      }

      async createAppointment() {
        this.toggleButtonLoading(this.elements.appointmentCreateSave, true);
        
        const form = this.elements.appointmentCreateForm;
        const treatmentOption = this.elements.treatmentSelects.create.options[this.elements.treatmentSelects.create.selectedIndex];
        
        const payload = {
          start_time: new Date(form.start_time.value).toISOString(),
          treatment: Number(treatmentOption.value),
          customer_name: form.customer_name.value.trim(),
          customer_phone: form.customer_phone.value.trim(),
          note: form.note.value.trim()
        };

        try {
          const response = await this.apiRequest(
            this.appointmentsApiBase,
            { method: 'POST', body: JSON.stringify(payload) }
          );

          if (!response.ok) {
            const message = await this.getErrorMessage(response, '預約建立失敗');
            throw new Error(message);
          }

          this.elements.appointmentCreateModal.hide();
          this.showFeedback('預約已建立。');
          this.calendar.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message, 'danger');
        } finally {
          this.toggleButtonLoading(this.elements.appointmentCreateSave, false);
        }
      }

      showTimeOffModal() {
        this.resetTimeOffModal();
        this.elements.timeOffForm.reset();
        
        // 設定預設時間
        const now = new Date();
        const roundedStart = new Date(now);
        const minutes = roundedStart.getMinutes();
        const remainder = minutes % 30;
        
        if (remainder !== 0) {
          roundedStart.setMinutes(minutes + (30 - remainder), 0, 0);
        } else {
          roundedStart.setSeconds(0, 0);
        }
        
        const roundedEnd = new Date(roundedStart.getTime() + 60 * 60 * 1000);
        
        this.elements.timeOffForm.starts_at.value = this.toLocalInputValue(roundedStart);
        this.elements.timeOffForm.ends_at.value = this.toLocalInputValue(roundedEnd);
        
        this.elements.timeOffModal.show();
      }

      async saveTimeOff() {
        this.toggleButtonLoading(this.elements.timeOffSave, true);
        
        const form = this.elements.timeOffForm;
        const startDate = new Date(form.starts_at.value);
        const endDate = new Date(form.ends_at.value);
        
        // 驗證
        if (!form.starts_at.value || !form.ends_at.value) {
          this.showFeedback('請填寫開始與結束時間。', 'warning');
          this.toggleButtonLoading(this.elements.timeOffSave, false);
          return;
        }
        
        if (endDate <= startDate) {
          this.showFeedback('結束時間必須晚於開始時間。', 'warning');
          this.toggleButtonLoading(this.elements.timeOffSave, false);
          return;
        }

        const payload = {
          starts_at: startDate.toISOString(),
          ends_at: endDate.toISOString(),
          note: form.note.value.trim()
        };

        // 重複設定
        if (!this.isEditingTimeOff && this.elements.repeatType.value) {
          payload.repeat_type = this.elements.repeatType.value;
          
          const interval = Number.parseInt(form.repeat_interval?.value, 10);
          payload.repeat_interval = isNaN(interval) || interval < 1 ? 1 : interval;
          
          if (form.repeat_until?.value) {
            payload.repeat_until = form.repeat_until.value;
          }
        }

        try {
          const isEditing = this.isEditingTimeOff && this.activeTimeOffEvent;
          const endpoint = isEditing ? `${this.timeOffApiBase}${this.activeTimeOffEvent.id}/` : this.timeOffApiBase;
          const method = isEditing ? 'PATCH' : 'POST';
          
          const response = await this.apiRequest(endpoint, {
            method,
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const message = await this.getErrorMessage(response, isEditing ? '休假更新失敗' : '休假建立失敗');
            throw new Error(message);
          }

          this.elements.timeOffModal.hide();
          this.showFeedback(isEditing ? '休假已更新。' : '休假已建立。', isEditing ? 'info' : 'success');
          this.calendar.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message, 'danger');
        } finally {
          this.toggleButtonLoading(this.elements.timeOffSave, false);
        }
      }

      showDeleteConfirm() {
        if (!this.activeTimeOffEvent) return;
        
        const hasRecurring = Boolean(this.activeTimeOffEvent.extendedProps?.seriesUuid);
        
        if (hasRecurring) {
          this.elements.timeOffDeleteSeries.classList.remove('d-none');
          document.getElementById('time-off-delete-message').textContent = 
            '這筆休假屬於重複序列，請選擇刪除單次或整個序列。';
          this.elements.timeOffDeleteSingle.textContent = '只刪除此筆';
        } else {
          this.elements.timeOffDeleteSeries.classList.add('d-none');
          document.getElementById('time-off-delete-message').textContent = '確定要刪除此休假嗎？';
          this.elements.timeOffDeleteSingle.textContent = '刪除';
        }
        
        this.elements.timeOffDeleteConfirmModal.show();
      }

      async deleteTimeOff(scope = null) {
        if (!this.activeTimeOffEvent) return;
        
        const deletingSeries = scope === 'series';
        const url = deletingSeries 
          ? `${this.timeOffApiBase}${this.activeTimeOffEvent.id}/?scope=series`
          : `${this.timeOffApiBase}${this.activeTimeOffEvent.id}/`;

        try {
          const response = await this.apiRequest(url, { method: 'DELETE' });

          if (!response.ok) {
            const message = await this.getErrorMessage(response, '休假刪除失敗');
            throw new Error(message);
          }

          this.elements.timeOffDeleteConfirmModal.hide();
          this.elements.timeOffModal.hide();
          this.showFeedback(deletingSeries ? '重複休假已刪除。' : '休假已刪除。', 'warning');
          this.activeTimeOffEvent = null;
          this.calendar.refetchEvents();
        } catch (error) {
          console.error(error);
          this.showFeedback(error.message, 'danger');
        }
      }

      updateRepeatControls() {
        const type = this.elements.repeatType?.value;
        
        if (!type) {
          this.elements.repeatSettings?.classList.add('d-none');
          return;
        }
        
        this.elements.repeatSettings?.classList.remove('d-none');
        
        if (this.elements.repeatIntervalLabel) {
          this.elements.repeatIntervalLabel.textContent = type === 'weekly' ? '週' : '天';
        }
      }

      resetTimeOffModal() {
        this.isEditingTimeOff = false;
        this.activeTimeOffEvent = null;
        
        this.elements.timeOffModalTitle.textContent = '新增休假';
        this.elements.timeOffSave.textContent = '建立休假';
        this.elements.timeOffDelete?.classList.add('d-none');
        
        // 重置重複設定
        if (this.elements.repeatType) {
          this.elements.repeatType.disabled = false;
          this.elements.repeatType.value = '';
        }
        
        this.elements.repeatEditWarning?.classList.add('d-none');
        this.updateRepeatControls();
      }
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      new ScheduleManager();
    });
  </script>
{% endblock %}
