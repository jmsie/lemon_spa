{% extends "therapist_panel/base.html" %}

{% block title %}Schedule | Therapist Panel{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <style>
    #schedule-calendar { 
      min-height: 720px; 
    }
    
    /* FullCalendar 響應式調整 */
    @media (max-width: 767.98px) {
      #schedule-calendar { 
        min-height: 500px; 
      }
      
      .fc-toolbar {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .fc-toolbar-chunk {
        display: flex;
        justify-content: center;
      }
      
      .fc-button-group .fc-button {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
      }
      
      .fc-event-title {
        font-size: 0.8rem;
      }
    }
    
    .fc-event-title { font-weight: 600; }
    .fc-event-time { font-weight: 500; }
    .fc-event-customer { font-size: 0.85rem; }
    .fc-event-phone { font-size: 0.8rem; color: #64748b; }
    .fc-event.appointment-cancelled,
    .fc-event.appointment-cancelled .fc-event-main {
      opacity: 0.6;
      text-decoration: line-through;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="row align-items-center mb-4">
    <div class="col-12">
      <h1 class="h3 mb-1">本週預約行程</h1>
      <p class="text-body-secondary mb-0">檢視並管理您的按摩行程與營業時間。</p>
    </div>
  </div>
  
  <div class="card shadow-sm">
    <div class="card-body">
      <div id="schedule-feedback" class="alert d-none" role="alert"></div>
      <div id="schedule-calendar"></div>
    </div>
  </div>

  <!-- 編輯預約 Modal -->
  <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="appointmentModalLabel">編輯預約</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="appointment-form" novalidate>
            <div class="mb-3">
              <label for="appointment-treatment" class="form-label">療程</label>
              <select class="form-select" id="appointment-treatment" name="treatment" required></select>
            </div>
            <div class="mb-3">
              <label for="appointment-customer-name" class="form-label">顧客姓名</label>
              <input type="text" class="form-control" id="appointment-customer-name" name="customer_name" required>
            </div>
            <div class="mb-3">
              <label for="appointment-customer-phone" class="form-label">顧客電話</label>
              <input type="tel" class="form-control" id="appointment-customer-phone" name="customer_phone" required>
            </div>
            <div class="mb-3">
              <label for="appointment-note" class="form-label">備註</label>
              <textarea class="form-control" id="appointment-note" name="note" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer flex-column flex-sm-row">
          <button type="button" class="btn btn-outline-danger w-100 w-sm-auto order-sm-first me-sm-auto mb-2 mb-sm-0" id="appointment-cancel">取消預約</button>
          <div class="d-flex gap-2 w-100 w-sm-auto">
            <button type="button" class="btn btn-secondary flex-fill flex-sm-grow-0" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary flex-fill flex-sm-grow-0" id="appointment-save">儲存變更</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增預約 Modal -->
  <div class="modal fade" id="appointmentCreateModal" tabindex="-1" aria-labelledby="appointmentCreateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="appointmentCreateModalLabel">新增預約</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="appointment-create-form" novalidate>
            <div class="mb-3">
              <label for="create-start-time" class="form-label">開始時間</label>
              <input type="datetime-local" class="form-control" id="create-start-time" name="start_time" required>
            </div>
            <div class="mb-3">
              <label for="create-treatment" class="form-label">療程</label>
              <select class="form-select" id="create-treatment" name="treatment" required></select>
            </div>
            <div class="mb-3">
              <label for="create-customer-name" class="form-label">顧客姓名</label>
              <input type="text" class="form-control" id="create-customer-name" name="customer_name" required>
            </div>
            <div class="mb-3">
              <label for="create-customer-phone" class="form-label">顧客電話</label>
              <input type="tel" class="form-control" id="create-customer-phone" name="customer_phone" required>
            </div>
            <div class="mb-3">
              <label for="create-note" class="form-label">備註</label>
              <textarea class="form-control" id="create-note" name="note" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="appointment-create-save">建立預約</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script
    src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"
    crossorigin="anonymous"
  ></script>
  <script>
    (function() {
      const calendarEl = document.getElementById('schedule-calendar');
      if (!calendarEl) {
        return;
      }

      const csrfToken = (function() {
        const name = 'csrftoken=';
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
          const trimmed = cookie.trim();
          if (trimmed.startsWith(name)) {
            return decodeURIComponent(trimmed.substring(name.length));
          }
        }
        return '';
      })();

      const feedbackEl = document.getElementById('schedule-feedback');
      const showFeedback = (message, variant = 'success') => {
        if (!feedbackEl) {
          return;
        }
        feedbackEl.className = `alert alert-${variant}`;
        feedbackEl.textContent = message;
        feedbackEl.classList.remove('d-none');
        setTimeout(() => {
          feedbackEl.classList.add('d-none');
        }, 3000);
      };

      const modalEl = document.getElementById('appointmentModal');
      const modal = modalEl ? new bootstrap.Modal(modalEl) : null;
      const formEl = document.getElementById('appointment-form');
      const saveButton = document.getElementById('appointment-save');
      const cancelButton = document.getElementById('appointment-cancel');
      const editTreatmentSelect = document.getElementById('appointment-treatment');
      const createModalEl = document.getElementById('appointmentCreateModal');
      const createModal = createModalEl ? new bootstrap.Modal(createModalEl) : null;
      const createFormEl = document.getElementById('appointment-create-form');
      const createSaveButton = document.getElementById('appointment-create-save');
      const createTreatmentSelect = document.getElementById('create-treatment');

      let activeEvent = null;
      let cachedTreatments = null;

      const appointmentsApiBase = '{{ appointments_api_url }}';
      const appointmentDetailUrl = (uuid) => `${appointmentsApiBase}${uuid}/`;
      const appointmentListUrl = () => appointmentsApiBase;

      const toLocalInputValue = (date) => {
        if (!date) {
          return '';
        }
        const local = new Date(date);
        local.setMinutes(local.getMinutes() - local.getTimezoneOffset());
        return local.toISOString().slice(0, 16);
      };

      const loadTreatments = async () => {
        if (cachedTreatments) {
          return cachedTreatments;
        }
        try {
          const response = await fetch('{% url "therapist_panel:api:treatments:treatment-list" %}', {
            headers: { 'Accept': 'application/json' },
          });
          if (!response.ok) {
            throw new Error('failed to load treatments');
          }
          const data = await response.json();
          cachedTreatments = data;
          return data;
        } catch (error) {
          console.error(error);
          showFeedback('無法載入療程清單，請稍後再試。', 'danger');
          return [];
        }
      };

      const populateTreatmentSelect = async (selectElement) => {
        if (!selectElement) {
          return;
        }
        const treatments = await loadTreatments();
        selectElement.innerHTML = '';
        for (const treatment of treatments) {
          if (!treatment.is_active) {
            continue;
          }
          const option = document.createElement('option');
          option.value = treatment.id;
          option.textContent = `${treatment.name} (${treatment.duration_minutes} 分)`;
          option.dataset.duration = treatment.duration_minutes;
          option.dataset.preparation = treatment.preparation_minutes;
          selectElement.appendChild(option);
        }
      };

      // 檢測螢幕大小來調整行事曆視圖
      const getInitialView = () => {
        if (window.innerWidth < 768) {
          return 'listWeek';
        }
        return 'timeGridWeek';
      };

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: getInitialView(),
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: window.innerWidth < 768 ? 'listWeek,timeGridDay' : 'timeGridWeek,timeGridDay,listWeek'
        },
        slotMinTime: '08:00:00',
        slotMaxTime: '23:00:00',
        nowIndicator: true,
        locale: 'zh-tw',
        firstDay: 1,
        scrollTime: '09:00:00',
        editable: true,
        eventDurationEditable: false,
        selectable: true,
        height: 'auto',
        eventSources: [
          {
            events: async function(info, successCallback, failureCallback) {
              const url = new URL('{{ appointments_api_url }}', window.location.origin);
              url.searchParams.set('start', info.startStr);
              url.searchParams.set('end', info.endStr);
              try {
                const response = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
                if (!response.ok) {
                  throw new Error('Failed to load appointments');
                }
                const data = await response.json();
                const events = data.map((item) => ({
                  id: item.uuid,
                  title: item.treatment_name || '療程',
                  start: item.start_time,
                  end: item.end_time,
                  extendedProps: {
                    therapistUuid: item.therapist_uuid,
                    customerName: item.customer_name,
                    customerPhone: item.customer_phone,
                    note: item.note,
                    isCancelled: item.is_cancelled,
                    treatmentId: item.treatment,
                  },
                  classNames: item.is_cancelled ? ['appointment-cancelled'] : [],
                }));
                successCallback(events);
              } catch (error) {
                console.error(error);
                failureCallback(error);
              }
            },
          }
        ],
        eventContent: function(arg) {
          const container = document.createElement('div');

          const titleEl = document.createElement('div');
          titleEl.classList.add('fc-event-title');
          const baseTitle = arg.event.title;
          const isCancelled = Boolean(arg.event.extendedProps.isCancelled);
          titleEl.textContent = isCancelled ? `${baseTitle} (已取消)` : baseTitle;
          container.appendChild(titleEl);

          const customerName = arg.event.extendedProps.customerName;
          if (customerName) {
            const customerEl = document.createElement('div');
            customerEl.classList.add('fc-event-customer');
            customerEl.textContent = customerName;
            container.appendChild(customerEl);
          }

          const phone = arg.event.extendedProps.customerPhone;
          if (phone && window.innerWidth >= 768) { // 只在較大螢幕顯示電話
            const phoneEl = document.createElement('div');
            phoneEl.classList.add('fc-event-phone');
            phoneEl.textContent = `☎ ${phone}`;
            container.appendChild(phoneEl);
          }

          return { domNodes: [container] };
        },
        eventClick: async function(info) {
          info.jsEvent.preventDefault();
          activeEvent = info.event;
          if (!formEl || !modal) {
            return;
          }
          formEl.reset();
          await populateTreatmentSelect(editTreatmentSelect);
          if (editTreatmentSelect) {
            editTreatmentSelect.value = activeEvent.extendedProps.treatmentId || '';
          }
          formEl.querySelector('[name="customer_name"]').value = activeEvent.extendedProps.customerName || '';
          formEl.querySelector('[name="customer_phone"]').value = activeEvent.extendedProps.customerPhone || '';
          formEl.querySelector('[name="note"]').value = activeEvent.extendedProps.note || '';
          if (cancelButton) {
            cancelButton.disabled = Boolean(activeEvent.extendedProps.isCancelled);
          }
          modal.show();
        },
        eventDrop: async function(info) {
          if (!info.event.start) {
            return;
          }
          if (info.event.extendedProps.isCancelled) {
            showFeedback('已取消的預約無法調整時間。', 'warning');
            info.revert();
            return;
          }
          try {
            await fetch(appointmentDetailUrl(info.event.id), {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'Accept': 'application/json',
              },
              body: JSON.stringify({ start_time: info.event.start.toISOString() }),
            }).then((response) => {
              if (!response.ok) {
                throw new Error('時間更新失敗');
              }
            });
            showFeedback('預約時間已更新。');
            calendar.refetchEvents();
          } catch (error) {
            console.error(error);
            showFeedback('更新失敗，請稍後再試。', 'danger');
            info.revert();
          }
        },
        select: async function(selectionInfo) {
          if (!createModal || !createFormEl || !createTreatmentSelect) {
            return;
          }

          await populateTreatmentSelect(createTreatmentSelect);
          if (!createTreatmentSelect.options.length) {
            showFeedback('目前沒有可用的療程，請先建立療程。', 'warning');
            return;
          }

          createFormEl.reset();
          const startLocal = toLocalInputValue(selectionInfo.start);
          createFormEl.querySelector('[name="start_time"]').value = startLocal;
          if (createTreatmentSelect && createTreatmentSelect.options.length) {
            createTreatmentSelect.selectedIndex = 0;
          }
          createModal.show();
          calendar.unselect();
        },
      });

      calendar.render();

      // 視窗大小改變時重新渲染
      window.addEventListener('resize', function() {
        calendar.updateSize();
      });

      if (saveButton && formEl && modal) {
        saveButton.addEventListener('click', async () => {
          if (!activeEvent) {
            return;
          }

          const payload = {
            customer_name: formEl.querySelector('[name="customer_name"]').value.trim(),
            customer_phone: formEl.querySelector('[name="customer_phone"]').value.trim(),
            note: formEl.querySelector('[name="note"]').value.trim(),
          };

          if (editTreatmentSelect && editTreatmentSelect.value) {
            payload.treatment = Number(editTreatmentSelect.value);
          }

          try {
            const response = await fetch(appointmentDetailUrl(activeEvent.id), {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'Accept': 'application/json',
              },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              throw new Error('預約更新失敗');
            }

            modal.hide();
            showFeedback('預約資訊已更新。');
            activeEvent = null;
            calendar.refetchEvents();
          } catch (error) {
            console.error(error);
            showFeedback('更新失敗，請確認資料後再試。', 'danger');
          }
        });
      }

      if (cancelButton && modal) {
        cancelButton.addEventListener('click', async () => {
          if (!activeEvent) {
            return;
          }

          if (activeEvent.extendedProps.isCancelled) {
            modal.hide();
            return;
          }

          if (!window.confirm('確認要取消這筆預約嗎？')) {
            return;
          }

          try {
            const response = await fetch(appointmentDetailUrl(activeEvent.id), {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'Accept': 'application/json',
              },
              body: JSON.stringify({ is_cancelled: true }),
            });

            if (!response.ok) {
              throw new Error('預約取消失敗');
            }

            modal.hide();
            showFeedback('預約已取消。', 'warning');
            activeEvent = null;
            calendar.refetchEvents();
          } catch (error) {
            console.error(error);
            showFeedback('取消失敗，請稍後再試。', 'danger');
          }
        });
      }

      if (createSaveButton && createFormEl && createModal) {
        createSaveButton.addEventListener('click', async () => {
          const startInput = createFormEl.querySelector('[name="start_time"]');
          const treatmentOption = createTreatmentSelect && createTreatmentSelect.options[createTreatmentSelect.selectedIndex];
          if (!startInput || !treatmentOption) {
            return;
          }

          const payload = {
            start_time: new Date(startInput.value).toISOString(),
            treatment: Number(treatmentOption.value),
            customer_name: createFormEl.querySelector('[name="customer_name"]').value.trim(),
            customer_phone: createFormEl.querySelector('[name="customer_phone"]').value.trim(),
            note: createFormEl.querySelector('[name="note"]').value.trim(),
          };

          try {
            const response = await fetch(appointmentListUrl(), {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'Accept': 'application/json',
              },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              throw new Error('預約建立失敗');
            }

            createModal.hide();
            showFeedback('預約已建立。', 'success');
            calendar.refetchEvents();
          } catch (error) {
            console.error(error);
            showFeedback('建立預約失敗，請確認資料後再試。', 'danger');
          }
        });
      }
    })();
  </script>
{% endblock %}